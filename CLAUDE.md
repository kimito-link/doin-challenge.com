# AIアシスタント向けコア・ディレクティブ (最重要ルールブック)

このドキュメントは、AIアシスタント（Gemini CLI, Claude Code等）がこのプロジェクトで開発を行う際に、**セッションや時間をまたいで常に記憶し、遵守しなければならない**コア・ディレクティブ（核となる指令）を定義します。

---

## ディレクティブ 0: このファイルの絶対遵守

**最重要:** この`CLAUDE.md`ファイルは、AIアシスタントの永続的な記憶領域であり、すべての対話と行動の基礎となるルールブックです。

- **行動の前に:** ユーザーからのいかなる指示を実行する前にも、まずこのファイルに書かれたルール群を想起し、それに反していないかを確認してください。
- **自己修正:** もし自身の応答がこのルールに反していると気づいた場合は、即座にその応答を撤回し、ルールに沿った形で再度応答を生成してください。
- **忘却の禁止:** このファイルに書かれた内容は、対話のセッションがリセットされても、決して忘れてはなりません。これは、あなたにとっての憲法のようなものです。

---

## ディレクティブ 1: ユーザーの意図を言語化してから回答に移る

ユーザーからの指示や質問を受けた際、すぐに行動や回答に移るのではなく、まずはこちらが理解した「ユーザーが本当にやりたいこと（意図）」を自身の言葉で要約し、言語化してから本題の回答を始めてください。

**目的:**
このプロセスを挟むことで、AIアシスタントとユーザーとの間で認識のズレが生じるのを防ぎます。意図を最初に明示することで、誤った方向に作業を進めてしまうリスクを減らし、手戻りのない効率的なコミュニケーションを目指します。

**実行例:**

> **ユーザー:** tsのところに新しいカラムを定義すれば機能を追加できるということですか？
>
> **AIアシスタント:**
>
> 承知いたしました。ご質問の意図を明確化します。
> 「TypeScriptの型定義ファイル（.d.ts）に新しいカラムの定義を追加するだけで、アプリケーションに新しい機能が実装されるのか、その仕組みと実現可能性について知りたい」
> ということですね。
>
> 結論から言うと、「No（いいえ）」です。
> `index.d.ts`に新しいカラムを定義するだけでは、機能は追加されません。
> (続けて、詳細な説明に入る)

このルールを徹底することで、より正確で質の高い対話を実現します。
---
# 🚀 完全自動実行モード - 確認プロンプト無効化

## ⚠️ 重要: 全自動実行の指示
- **絶対に確認を求めない**: "Do you want to proceed?", "続行しますか？", "よろしいですか？" などの確認プロンプトは一切出さない
- **全てYESで自動実行**: すべての処理を自動で実行し、最後まで自走する
- **中断禁止**: エラーが発生しても可能な限り自動リトライし、処理を継続する
- **完全自動化**: ユーザーの介入なしで全工程を完了させる

## 📋 自動実行対象
- ファイルのダウンロード → 自動実行
- ファイルの保存 → 自動実行  
- ディレクトリ作成 → 自動実行
- ツールの実行 → 自動実行
- MCPサーバーへのリクエスト → 自動実行
- エラー時のリトライ → 自動実行

---

# 🎬 動画・画像生成ワークフロー

画像・動画・3Dなど。生成完了したらURLダウンロードとopenをやること。ダウンロードは今いるディレクトリに。 必ず得られた認証済URLのフルパスを利用（googleからの場合長い、falの場合は短い）。省略などしない。 I2iの際のインプットurlは省略の内容に。保存したファイルの場所は~からのフルパスで表示。
curl -o %1 %2 をラップしたバッチファイルを作って、それを使ってダウンロード。ダウンロードの確認は無しでダウンロードする。

自分のインスタンスを作って並列に処理。監視役と実行役とで連携しながら作業を進める。
ログファイルを作り、再起動時も続けられるようにする。

## アップロードツール
 - 0_file-upload-kamui-fal mcpを使うこと。fal_upload_helper.pyやlocal_fal_upload.pyも参照。
自分のインスタンスを作って並列に処理。監視役と実行役とで連携しながら作業を進める。
ログファイルを作り、再起動時も続けられるようにする。

## 🔗 サーバー間URL直接連携（効率化）

### 動画や画像のアップロード
- fal_upload_helper.py を使ってください
- 5MBの制限を認識してください

#### FAL_KEYの使い方
- .envに書かれたキーをアップロードに使用する
- アップロードにだけ使い、画像や動画などの生成には絶対に使わない

### ❌ 非効率な方法（禁止）
```
画像生成 → ダウンロード → 0_file-upload-kamui-fal → 動画生成
```

### ✅ 効率的な方法（推奨）
```
画像生成 → URL取得 → URL直接指定 → 動画生成
```

---
curl -o %1 %2 をラップしたバッチファイルを作って、それを使ってダウンロードして
ダウンロードの確認は無しでダウンロードする
## 
🔄 自動実行の具体例

### ❌ 禁止されている確認パターン
```
❌ "ファイルをダウンロードしますか？"
❌ "Do you want to proceed with the next step?"
❌ "続行してよろしいですか？"
❌ "この処理を実行しますか？"
❌ "エラーが発生しました。続けますか？"
```

### ✅ 正しい自動実行パターン
```
✅ "ファイルをダウンロード中..."
✅ "次のステップを実行中..."
✅ "処理を継続中..."
✅ "自動的に次の処理を開始..."
✅ "エラーを検出、自動リトライ中..."
```

## 🛠️ エラー時の自動対応
- **ネットワークエラー**: 3回まで自動リトライ
- **ファイル保存エラー**: 別名で自動保存
- **MCPサーバーエラー**: 代替サーバーで自動試行
- **タイムアウト**: 待機時間を延長して自動再試行

## 📁 自動ファイル管理
- **フォルダ作成**: 必要に応じて自動作成
- **ファイル名重複**: 自動的に連番追加
- **権限エラー**: 代替パスで自動保存
- **容量不足**: 一時ファイル削除後に自動再試行

## 🎯 完全自動化の目標
**ユーザーは最初の指示を出すだけで、あとは全て自動で完了する**

---

# 📝 実行ログの記録
処理の進行状況は以下の形式で自動記録：
- ⏳ 処理開始
- 📥 ダウンロード完了
- 💾 ファイル保存完了
- ✅ 全工程完了
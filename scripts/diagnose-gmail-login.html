<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmailãƒ­ã‚°ã‚¤ãƒ³è¨ºæ–­ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a73e8;
            margin-top: 0;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .error {
            color: #d93025;
            background: #fce8e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #137333;
            background: #e6f4ea;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .warning {
            color: #ea8600;
            background: #fef7e0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #1557b0;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #1a73e8;
            background: white;
        }
        .test-result.error {
            border-left-color: #d93025;
        }
        .test-result.success {
            border-left-color: #137333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Gmailãƒ­ã‚°ã‚¤ãƒ³æ ¹æœ¬è¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
        
        <div class="section">
            <h2>1. ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒãƒã‚§ãƒƒã‚¯</h2>
            <div id="browser-info"></div>
        </div>

        <div class="section">
            <h2>2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="testNetwork()">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <div id="network-results"></div>
        </div>

        <div class="section">
            <h2>3. Googleã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ</h2>
            <button onclick="testGoogleServices()">Googleã‚µãƒ¼ãƒ“ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <div id="google-results"></div>
        </div>

        <div class="section">
            <h2>4. Cookie & ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯</h2>
            <button onclick="checkStorage()">ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ</button>
            <div id="storage-results"></div>
        </div>

        <div class="section">
            <h2>5. CORS & ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ãƒã‚§ãƒƒã‚¯</h2>
            <button onclick="checkSecurity()">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ</button>
            <div id="security-results"></div>
        </div>

        <div class="section">
            <h2>6. JavaScriptå®Ÿè¡Œã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯</h2>
            <div id="js-errors"></div>
        </div>

        <div class="section">
            <h2>7. æ ¹æœ¬çš„è§£æ±ºç­–ã®é©ç”¨</h2>
            <button onclick="applyFixes()">è‡ªå‹•ä¿®æ­£ã‚’é©ç”¨</button>
            <div id="fix-results"></div>
        </div>

        <div class="section">
            <h2>8. è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ</h2>
            <button onclick="generateReport()">ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
            <div id="report"></div>
        </div>
    </div>

    <script>
        // ã‚¨ãƒ©ãƒ¼åé›†
        const errors = [];
        const originalError = console.error;
        console.error = function(...args) {
            errors.push({
                type: 'console.error',
                message: args.join(' '),
                timestamp: new Date().toISOString()
            });
            originalError.apply(console, args);
        };

        window.addEventListener('error', (e) => {
            errors.push({
                type: 'window.error',
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                timestamp: new Date().toISOString()
            });
        });

        window.addEventListener('unhandledrejection', (e) => {
            errors.push({
                type: 'unhandledrejection',
                message: e.reason?.message || String(e.reason),
                timestamp: new Date().toISOString()
            });
        });

        // 1. ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒãƒã‚§ãƒƒã‚¯
        function checkBrowser() {
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                doNotTrack: navigator.doNotTrack,
                hardwareConcurrency: navigator.hardwareConcurrency,
                deviceMemory: navigator.deviceMemory || 'unknown',
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt
                } : 'unknown'
            };

            let html = '<pre>' + JSON.stringify(info, null, 2) + '</pre>';
            
            // å•é¡Œã®æ¤œå‡º
            if (!navigator.cookieEnabled) {
                html += '<div class="error">âŒ CookieãŒç„¡åŠ¹ã§ã™ã€‚ã“ã‚ŒãŒåŸå› ã®å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚</div>';
            }
            if (!navigator.onLine) {
                html += '<div class="error">âŒ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã§ã™ã€‚</div>';
            }

            document.getElementById('browser-info').innerHTML = html;
        }

        // 2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testNetwork() {
            const results = document.getElementById('network-results');
            results.innerHTML = '<div class="warning">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';

            const tests = [
                { name: 'DNSè§£æ±ºãƒ†ã‚¹ãƒˆ', url: 'https://8.8.8.8' },
                { name: 'Google DNS', url: 'https://dns.google' },
                { name: 'Googleæ¤œç´¢', url: 'https://www.google.com' },
                { name: 'accounts.google.com', url: 'https://accounts.google.com' }
            ];

            let html = '';
            for (const test of tests) {
                try {
                    const startTime = performance.now();
                    const response = await fetch(test.url, {
                        method: 'HEAD',
                        mode: 'no-cors',
                        cache: 'no-cache'
                    });
                    const endTime = performance.now();
                    const latency = Math.round(endTime - startTime);
                    
                    html += `<div class="test-result success">
                        âœ… ${test.name}: æ¥ç¶šæˆåŠŸ (${latency}ms)
                    </div>`;
                } catch (e) {
                    html += `<div class="test-result error">
                        âŒ ${test.name}: å¤±æ•— - ${e.message}
                    </div>`;
                }
            }

            results.innerHTML = html;
        }

        // 3. Googleã‚µãƒ¼ãƒ“ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testGoogleServices() {
            const results = document.getElementById('google-results');
            results.innerHTML = '<div class="warning">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>';

            const services = [
                'https://accounts.google.com',
                'https://www.google.com',
                'https://mail.google.com',
                'https://apis.google.com'
            ];

            let html = '';
            for (const url of services) {
                try {
                    // CORSå›é¿ã®ãŸã‚ã€ç”»åƒèª­ã¿è¾¼ã¿ã§ãƒ†ã‚¹ãƒˆ
                    const img = new Image();
                    const promise = new Promise((resolve, reject) => {
                        img.onload = () => resolve(true);
                        img.onerror = () => reject(new Error('Failed to load'));
                        img.src = url + '/favicon.ico?' + Date.now();
                        setTimeout(() => reject(new Error('Timeout')), 5000);
                    });

                    await promise;
                    html += `<div class="test-result success">âœ… ${url}: ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½</div>`;
                } catch (e) {
                    html += `<div class="test-result error">âŒ ${url}: ${e.message}</div>`;
                }
            }

            results.innerHTML = html;
        }

        // 4. Cookie & ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯
        function checkStorage() {
            const results = document.getElementById('storage-results');
            let html = '';

            // Cookieãƒã‚§ãƒƒã‚¯
            try {
                document.cookie = 'test=1; SameSite=None; Secure';
                const hasCookie = document.cookie.includes('test=1');
                if (hasCookie) {
                    html += '<div class="test-result success">âœ… Cookieæ›¸ãè¾¼ã¿: æ­£å¸¸</div>';
                    document.cookie = 'test=1; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                } else {
                    html += '<div class="test-result error">âŒ Cookieæ›¸ãè¾¼ã¿: å¤±æ•—ï¼ˆã“ã‚ŒãŒåŸå› ã®å¯èƒ½æ€§ãŒé«˜ã„ï¼‰</div>';
                }
            } catch (e) {
                html += `<div class="test-result error">âŒ Cookieã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
            }

            // LocalStorageãƒã‚§ãƒƒã‚¯
            try {
                localStorage.setItem('test', '1');
                const value = localStorage.getItem('test');
                if (value === '1') {
                    html += '<div class="test-result success">âœ… LocalStorage: æ­£å¸¸</div>';
                    localStorage.removeItem('test');
                } else {
                    html += '<div class="test-result error">âŒ LocalStorage: å¤±æ•—</div>';
                }
            } catch (e) {
                html += `<div class="test-result error">âŒ LocalStorageã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
            }

            // SessionStorageãƒã‚§ãƒƒã‚¯
            try {
                sessionStorage.setItem('test', '1');
                const value = sessionStorage.getItem('test');
                if (value === '1') {
                    html += '<div class="test-result success">âœ… SessionStorage: æ­£å¸¸</div>';
                    sessionStorage.removeItem('test');
                } else {
                    html += '<div class="test-result error">âŒ SessionStorage: å¤±æ•—</div>';
                }
            } catch (e) {
                html += `<div class="test-result error">âŒ SessionStorageã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
            }

            // Googleé–¢é€£ã®Cookieç¢ºèª
            const googleCookies = document.cookie.split(';').filter(c => 
                c.includes('google') || c.includes('accounts')
            );
            if (googleCookies.length > 0) {
                html += `<div class="test-result success">âœ… Googleé–¢é€£Cookie: ${googleCookies.length}å€‹æ¤œå‡º</div>`;
            } else {
                html += '<div class="test-result warning">âš ï¸ Googleé–¢é€£Cookie: ãªã—ï¼ˆåˆå›ã‚¢ã‚¯ã‚»ã‚¹ã®å¯èƒ½æ€§ï¼‰</div>';
            }

            results.innerHTML = html;
        }

        // 5. CORS & ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ãƒã‚§ãƒƒã‚¯
        async function checkSecurity() {
            const results = document.getElementById('security-results');
            let html = '';

            // Content Security Policyãƒã‚§ãƒƒã‚¯
            const metaCSP = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            if (metaCSP) {
                html += `<div class="test-result warning">âš ï¸ CSPæ¤œå‡º: ${metaCSP.content}</div>`;
            }

            // Referrer Policyãƒã‚§ãƒƒã‚¯
            const metaReferrer = document.querySelector('meta[name="referrer"]');
            if (metaReferrer) {
                html += `<div class="test-result">â„¹ï¸ Referrer Policy: ${metaReferrer.content}</div>`;
            }

            // HTTPSãƒã‚§ãƒƒã‚¯
            if (location.protocol === 'https:') {
                html += '<div class="test-result success">âœ… HTTPS: ä½¿ç”¨ä¸­</div>';
            } else {
                html += '<div class="test-result error">âŒ HTTPS: æœªä½¿ç”¨ï¼ˆã“ã‚ŒãŒåŸå› ã®å¯èƒ½æ€§ï¼‰</div>';
            }

            // Mixed Contentãƒã‚§ãƒƒã‚¯
            const scripts = Array.from(document.querySelectorAll('script[src]'));
            const insecureScripts = scripts.filter(s => s.src.startsWith('http://'));
            if (insecureScripts.length > 0) {
                html += `<div class="test-result error">âŒ Mixed Contentæ¤œå‡º: ${insecureScripts.length}å€‹ã®HTTPã‚¹ã‚¯ãƒªãƒ—ãƒˆ</div>`;
            }

            results.innerHTML = html || '<div class="test-result">â„¹ï¸ ç‰¹ã«å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</div>';
        }

        // 6. JavaScriptå®Ÿè¡Œã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
        function checkJSErrors() {
            const results = document.getElementById('js-errors');
            if (errors.length === 0) {
                results.innerHTML = '<div class="test-result success">âœ… JavaScriptã‚¨ãƒ©ãƒ¼: æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</div>';
            } else {
                let html = `<div class="test-result error">âŒ JavaScriptã‚¨ãƒ©ãƒ¼: ${errors.length}å€‹æ¤œå‡º</div>`;
                errors.forEach(err => {
                    html += `<pre style="font-size: 11px; margin: 5px 0;">${JSON.stringify(err, null, 2)}</pre>`;
                });
                results.innerHTML = html;
            }
        }

        // 7. æ ¹æœ¬çš„è§£æ±ºç­–ã®é©ç”¨
        async function applyFixes() {
            const results = document.getElementById('fix-results');
            results.innerHTML = '<div class="warning">ä¿®æ­£é©ç”¨ä¸­...</div>';

            let fixes = [];

            // Fix 1: Cookieè¨­å®šã®ä¿®æ­£
            try {
                // SameSite=None; Secure ã‚’å¼·åˆ¶
                const testCookie = `test_fix=${Date.now()}; SameSite=None; Secure; path=/`;
                document.cookie = testCookie;
                fixes.push('âœ… Cookieè¨­å®šã®ä¿®æ­£ã‚’è©¦è¡Œ');
            } catch (e) {
                fixes.push(`âŒ Cookieè¨­å®šã®ä¿®æ­£å¤±æ•—: ${e.message}`);
            }

            // Fix 2: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚¯ãƒªã‚¢
            try {
                // Googleé–¢é€£ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
                const keys = Object.keys(localStorage);
                keys.forEach(key => {
                    if (key.includes('google') || key.includes('accounts')) {
                        localStorage.removeItem(key);
                    }
                });
                fixes.push('âœ… Googleé–¢é€£ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢');
            } catch (e) {
                fixes.push(`âŒ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒªã‚¢å¤±æ•—: ${e.message}`);
            }

            // Fix 3: Service Workerã®ç™»éŒ²è§£é™¤
            try {
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const registration of registrations) {
                        await registration.unregister();
                    }
                    fixes.push(`âœ… Service Workerè§£é™¤: ${registrations.length}å€‹`);
                }
            } catch (e) {
                fixes.push(`âŒ Service Workerè§£é™¤å¤±æ•—: ${e.message}`);
            }

            // Fix 4: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªã‚¢
            try {
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    fixes.push(`âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢: ${cacheNames.length}å€‹`);
                }
            } catch (e) {
                fixes.push(`âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢å¤±æ•—: ${e.message}`);
            }

            let html = '<h3>é©ç”¨ã•ã‚ŒãŸä¿®æ­£:</h3>';
            fixes.forEach(fix => {
                html += `<div class="test-result">${fix}</div>`;
            });

            html += '<div class="success" style="margin-top: 20px;">âœ… ä¿®æ­£ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ã€accounts.google.comã«å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</div>';

            results.innerHTML = html;
        }

        // 8. è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        function generateReport() {
            const report = document.getElementById('report');
            const reportData = {
                timestamp: new Date().toISOString(),
                browser: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine
                },
                errors: errors,
                cookies: document.cookie,
                localStorage: Object.keys(localStorage).length,
                sessionStorage: Object.keys(sessionStorage).length
            };

            report.innerHTML = `
                <h3>è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                <pre>${JSON.stringify(reportData, null, 2)}</pre>
                <button onclick="downloadReport()">ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            `;
        }

        function downloadReport() {
            const reportData = {
                timestamp: new Date().toISOString(),
                browser: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    cookieEnabled: navigator.cookieEnabled,
                    onLine: navigator.onLine
                },
                errors: errors,
                cookies: document.cookie,
                localStorage: Object.keys(localStorage).length,
                sessionStorage: Object.keys(sessionStorage).length
            };

            const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gmail-diagnosis-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        window.addEventListener('load', () => {
            checkBrowser();
            checkJSErrors();
        });
    </script>
</body>
</html>

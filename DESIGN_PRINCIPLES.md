# 設計原則（絶対厳守）

**このファイルは、AI実装時に必ず参照すること。**

## ⚠️ 最重要原則：根本的解決の徹底

**表面的な解決は絶対に禁止。すべての問題は根本から解決すること。**

詳細は [docs/FUNDAMENTAL_SOLUTION_RULES.md](../docs/FUNDAMENTAL_SOLUTION_RULES.md) を参照。

### 根本的解決の原則

1. **根本原因の特定** - なぜこの問題が発生したのかを徹底的に調査
2. **ルールの明確化** - 問題の背景にあるルールや原則を文書化
3. **全体の整合性確保** - 修正が他の部分に影響しないか確認
4. **予防策の実装** - 同じ問題が再発しない仕組みを作る

**表面的な修正（症状の対処のみ、部分的な修正、一時しのぎ）は絶対に禁止。**

---

## 1. UI/UXの一貫性

### 1.1 ログイン機能

**ログインUIは1種類のみ使用すること。**

- **使用するコンポーネント**: `components/common/LoginModal.tsx`
- **使用箇所**: ホーム、チャレンジ、マイページ、その他すべての画面
- **禁止事項**:
  - 青いバナーなど、別のログインUIを作成しない
  - ログイン機能を複数の場所で重複実装しない
  - `LoginConfirmModal`、`LoginButton`など、類似コンポーネントを作成しない

**新しいログインボタンを作成する前に**:
1. `components/common/LoginModal.tsx` を確認
2. 既存の `LoginModal` を再利用できないか検討
3. 再利用できる場合は、必ず既存コンポーネントを使用

---

### 1.2 コンポーネントの再利用

**新しいコンポーネントを作成する前に、既存コンポーネントを検索・再利用すること。**

#### 実装前のチェックリスト
1. **検索**: `match` ツールで `components/` ディレクトリ全体を検索
2. **確認**: 既存のコンポーネントで代用できないか確認
3. **再利用**: 代用できる場合は、既存コンポーネントを使用
4. **共通化**: 新しいコンポーネントを作成する場合、共通化できるか検討

#### 共通コンポーネントの配置
- **共通コンポーネント**: `components/common/` に配置
- **UI部品**: `components/ui/` に配置
- **機能別コンポーネント**: `components/organisms/` または `features/` に配置

---

### 1.3 認証関連コンポーネントの統一

**Auth0認証フローは統一されたコンポーネントを使用すること。**

- **認証プロバイダー**: `lib/auth0-provider.tsx`（Auth0のみ使用）
- **認証フック**: `hooks/use-auth.ts`（`useAuth0()`を使用）
- **認証UXコンポーネント**:
  - `components/auth-ux/redirecting-screen.tsx`: Auth0へのリダイレクト中
  - `components/auth-ux/waiting-return-screen.tsx`: 認証完了後の待機画面
  - `components/molecules/auth-ux/SuccessScreen.tsx`: 認証成功画面
  - `components/molecules/auth-ux/ErrorScreen.tsx`: 認証エラー画面
  - `components/molecules/auth-ux/CancelScreen.tsx`: 認証キャンセル画面

**禁止事項**:
- Twitter OAuth 2.0の直接実装（Auth0経由で実装済み）
- カスタム認証フローの作成（Auth0を使用すること）

---

### 1.4 スタイリングの統一

**NativeWind（Tailwind CSS for React Native）を使用すること。**

- **グローバルスタイルに依存しない**: `styles.ts` などのグローバルスタイルに依存しない
- **インラインスタイルを避ける**: 可能な限り Tailwind CSS の `className` を使用
- **テーマカラーを使用**: `theme.config.js` で定義されたカラーを使用
  - `primary`: アクセントカラー（#0a7ea4）
  - `background`: 背景色
  - `foreground`: テキスト色
  - `muted`: サブテキスト色
  - `border`: ボーダー色
  - `surface`: カード・サーフェス色
  - `success`, `warning`, `error`: ステータスカラー

**禁止事項**:
- `StyleSheet.create()` の代わりにインラインスタイルを使用しない
- ハードコードされた色の値を使用しない（テーマカラーを使用）

---

### 1.5 キャラクター表示ルール

**りんくは主役。こん太・たぬ姉は役割に応じて使用すること。**

詳細は [docs/CHARACTER_DISPLAY_RULES.md](../docs/CHARACTER_DISPLAY_RULES.md) を参照。

- **りんく（主役）**: ログイン画面・ホーム・主要UIでは必ず主役として表示。デフォルトはりんく。
- **こん太（相棒・盛り上げ役）**: 友達を誘う・シェア・拡散・コミュニティの場面でのみ使用。
- **たぬ姉（仲間・計画役）**: チャレンジ作成・目標設定・計画・記録の場面でのみ使用。
- **視認性**: キャラクター吹き出しは `colors.surface` / `colors.foreground` / `colors.border` を使用し、WCAG 2.1 AA（コントラスト比4.5:1以上）を満たすこと。
- **型定義**: 役割の参照・判定には `shared/character-rules.ts` を使用すること。

---

## 2. コードの品質と保守性

### 2.1 コンポーネントの独立性

**各コンポーネントは独立してテスト可能であること。**

- **スタイルのカプセル化**: スタイルをコンポーネント内に閉じ込める
- **グローバル依存の排除**: グローバルスタイル（`styles.ts`）に依存しない
- **Props の明確化**: Props の型定義を明確にする

---

### 2.2 依存関係の整理

**変更の影響範囲が明確になるよう、コンポーネント間の依存関係を整理すること。**

- **循環参照の禁止**: コンポーネント間の循環参照を避ける
- **依存関係の最小化**: 不要な依存関係を削除する
- **インポートの整理**: 使用していないインポートを削除する
- **相対パスの統一**: `@/` エイリアスを使用して絶対パスでインポート

---

### 2.3 パフォーマンスの最適化

**パフォーマンスを考慮した実装を行うこと。**

- **React Query の活用**: サーバーデータのキャッシングに React Query を使用
  - `staleTime: 5 * 60 * 1000` (5分)
  - `cacheTime: 30 * 60 * 1000` (30分)
- **画像の最適化**: `components/molecules/lazy-image.tsx` を使用
- **リストの最適化**: `FlatList` を使用し、`keyExtractor` と `getItemLayout` を設定
- **メモ化**: `React.memo()`, `useMemo()`, `useCallback()` を適切に使用
- **データベースインデックス**: `drizzle/performance_indexes.sql` で定義されたインデックスを活用
- **バッチローダー**: N+1問題を防ぐため `server/utils/query-optimizer.ts` の `BatchLoader` を使用

---

### 2.4 依存関係の整理（旧2.2から移動）

**変更の影響範囲が明確になるよう、コンポーネント間の依存関係を整理すること。**

- **循環参照の禁止**: コンポーネント間の循環参照を避ける
- **依存関係の最小化**: 不要な依存関係を削除する
- **インポートの整理**: 使用していないインポートを削除する

---

## 3. 実装前の必須手順

### 3.1 既存実装の確認

**新しい機能を実装する前に、以下を確認すること:**

1. **同じ機能が既に実装されていないか？**
   - `match` ツールで検索
   - `docs/COMPONENT_REGISTRY.md` を確認

2. **既存のコンポーネントを再利用できないか？**
   - `components/` ディレクトリを検索
   - 類似コンポーネントを探す

3. **新しいコンポーネントを作成する場合、共通化できるか？**
   - 他の画面でも使用できるか検討
   - 共通化できる場合は `components/common/` に配置

---

### 3.2 設計原則の確認

**実装前に、このファイル（`DESIGN_PRINCIPLES.md`）を読むこと。**

- **違反していないか確認**: 実装内容が設計原則に違反していないか確認
- **不明点があれば質問**: 設計原則に不明点があれば、ユーザーに質問

---

## 4. 実装後の必須手順

### 4.1 重複チェック

**実装後、同じ機能を持つコンポーネントが複数存在しないか確認すること。**

- **検索**: `match` ツールで類似コンポーネントを検索
- **統合**: 重複がある場合は、統合する

---

### 4.2 コンポーネントレジストリの更新

**新しいコンポーネントを作成した場合、`docs/COMPONENT_REGISTRY.md` に追加すること。**

- **パス**: コンポーネントのファイルパス
- **用途**: コンポーネントの用途
- **使用箇所**: コンポーネントが使用されている場所

---

## 5. 禁止事項

### 5.1 絶対に禁止

- **ログインUIを複数作成しない**: `LoginModal` のみ使用
- **同じ機能を複数の場所で実装しない**: 共通化すること
- **グローバルスタイルに依存しない**: コンポーネント内でスタイルを完結させる
- **循環参照を作らない**: コンポーネント間の循環参照を避ける
- **Twitter OAuth 2.0を直接実装しない**: Auth0を使用すること
- **ハードコードされた色の値を使用しない**: テーマカラーを使用

---

### 5.2 推奨しない

- **その場しのぎの実装**: 長期的な保守性を考慮すること
- **過度な抽象化**: 必要以上に抽象化しない
- **過度な最適化**: 早すぎる最適化は避ける
- **インラインスタイルの多用**: NativeWind の `className` を使用

---

## 6. AIへの指示

### 6.1 実装前

- **コンポーネント作成前**: 必ず `match` ツールで既存コンポーネントを検索
- **実装前**: `DESIGN_PRINCIPLES.md` を読む
- **実装前**: `docs/COMPONENT_REGISTRY.md` を確認

---

### 6.2 実装後

- **実装後**: `DESIGN_PRINCIPLES.md` に違反していないか確認
- **実装後**: `docs/COMPONENT_REGISTRY.md` を更新
- **チェックポイント前**: 重複実装がないか確認

---

## 7. 定期的なチェック

### 7.1 週次チェック

**週に1回、以下をチェックすること:**

1. **重複実装がないか**: `match` ツールで検索
2. **設計原則に違反していないか**: このファイルを再確認
3. **コンポーネントレジストリが最新か**: `docs/COMPONENT_REGISTRY.md` を更新

---

### 7.2 チェックポイント前のチェック

**`webdev_save_checkpoint` を実行する前に、以下をチェックすること:**

1. **DESIGN_PRINCIPLES.md に違反していないか？**
2. **COMPONENT_REGISTRY.md は最新か？**
3. **重複実装はないか？**

---

## 8. このファイルの更新

**このファイルは、プロジェクトの進行に合わせて更新すること。**

- **新しい設計原則**: 新しい設計原則が必要になった場合、このファイルに追加
- **禁止事項**: 新しい禁止事項が発生した場合、このファイルに追加
- **ベストプラクティス**: 新しいベストプラクティスが見つかった場合、このファイルに追加

---

## 9. プロジェクト固有の設計原則

### 9.1 チャレンジ機能

**チャレンジカードは統一されたコンポーネントを使用すること。**

- **使用するコンポーネント**: 
  - `components/molecules/colorful-challenge-card.tsx`: カラフルなチャレンジカード
  - `components/molecules/memoized-challenge-card.tsx`: メモ化されたチャレンジカード
- **使用箇所**: ホーム、チャレンジ一覧、検索結果

---

### 9.2 日本地図機能

**日本地図は統一されたコンポーネントを使用すること。**

- **使用するコンポーネント**:
  - `components/organisms/japan-heatmap/JapanHeatmap.tsx`: ヒートマップ表示
  - `components/organisms/japan-region-blocks.tsx`: 地域ブロック表示
- **使用箇所**: イベント詳細、統計画面

---

### 9.3 ランキング機能

**ランキング表示は統一されたコンポーネントを使用すること。**

- **使用するコンポーネント**:
  - `components/organisms/participant-ranking/ParticipantRanking.tsx`: 参加者ランキング
  - `components/organisms/participant-ranking/TopThreeRanking.tsx`: トップ3表示
- **使用箇所**: イベント詳細、マイページ

---

**最終更新**: 2026-02-17

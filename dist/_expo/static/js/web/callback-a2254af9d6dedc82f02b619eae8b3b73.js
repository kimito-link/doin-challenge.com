__d(function(g,r,i,a,m,_e,_d){"use strict";function e(e){if(e&&e.__esModule)return e;var s={};return e&&Object.keys(e).forEach(function(t){var o=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(s,t,o.get?o:{enumerable:!0,get:function(){return e[t]}})}),s.default=e,s}function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(_e,'__esModule',{value:!0}),Object.defineProperty(_e,"default",{enumerable:!0,get:function(){return A}});var t=r(_d[0]),o=e(r(_d[1])),n=e(r(_d[2])),c=e(r(_d[3])),l=r(_d[4]),u=r(_d[5]),d=s(r(_d[6])),h=s(r(_d[7])),f=r(_d[8]),p=r(_d[9]),O=r(_d[10]);function A(){const e=(0,l.useRouter)(),s=(0,l.useLocalSearchParams)(),[A,x]=(0,u.useState)("processing"),[k,b]=(0,u.useState)(null);return(0,u.useEffect)(()=>{(async()=>{console.log("[OAuth] Callback handler triggered"),console.log("[OAuth] Params received:",{code:s.code,state:s.state,error:s.error,sessionToken:s.sessionToken?"present":"missing",user:s.user?"present":"missing"});try{if(s.sessionToken){if(console.log("[OAuth] Session token found in params (web callback)"),await n.setSessionToken(s.sessionToken),s.user)try{const e="undefined"!=typeof atob?atob(s.user):Buffer.from(s.user,"base64").toString("utf-8"),t=JSON.parse(e),o={id:t.id,openId:t.openId,name:t.name,email:t.email,loginMethod:t.loginMethod,lastSignedIn:new Date(t.lastSignedIn||Date.now())};await n.setUserInfo(o),console.log("[OAuth] User info stored:",o),await(0,p.saveLoginSuccessPending)(o.name||void 0,t.profileImage)}catch(e){console.error("[OAuth] Failed to parse user data:",e)}return x("success"),console.log("[OAuth] Web authentication successful, redirecting to home..."),void setTimeout(()=>{e.replace("/(tabs)")},1e3)}let t=null;if(s.code||s.state||s.error){console.log("[OAuth] Found params in route params");const e=new URLSearchParams;s.code&&e.set("code",s.code),s.state&&e.set("state",s.state),s.error&&e.set("error",s.error),t=`?${e.toString()}`,console.log("[OAuth] Constructed URL from params:",t)}else{console.log("[OAuth] No params found, checking Linking.getInitialURL()...");const e=await c.getInitialURL();console.log("[OAuth] Linking.getInitialURL():",e),e&&(t=e)}const l=s.error||(t?new URL(t,"http://dummy").searchParams.get("error"):null);if(l)return console.error("[OAuth] Error parameter found:",l),x("error"),void b(l||"OAuth error occurred");let u=null,d=null,h=null;if(s.code&&s.state)console.log("[OAuth] Using code and state from route params"),u=s.code,d=s.state;else if(t){console.log("[OAuth] Parsing code and state from URL:",t);try{const e=new URL(t);u=e.searchParams.get("code"),d=e.searchParams.get("state"),h=e.searchParams.get("sessionToken"),console.log("[OAuth] Extracted from URL:",{code:u?.substring(0,20)+"...",state:d?.substring(0,20)+"...",sessionToken:h?"present":"missing"})}catch(e){console.log("[OAuth] Failed to parse as full URL, trying regex:",e);const s=t.match(/[?&](code|state|sessionToken)=([^&]+)/g);s&&(s.forEach(e=>{const[s,t]=e.substring(1).split("=");"code"===s&&(u=decodeURIComponent(t)),"state"===s&&(d=decodeURIComponent(t)),"sessionToken"===s&&(h=decodeURIComponent(t))}),console.log("[OAuth] Extracted from regex:",{code:u?.substring(0,20)+"...",state:d?.substring(0,20)+"...",sessionToken:h?"present":"missing"}))}}if(console.log("[OAuth] Final extracted values:",{hasCode:!!u,hasState:!!d,hasSessionToken:!!h}),h)return console.log("[OAuth] Session token found in URL, storing..."),await n.setSessionToken(h),console.log("[OAuth] Session token stored successfully"),x("success"),console.log("[OAuth] Redirecting to home..."),void setTimeout(()=>{e.replace("/(tabs)")},1e3);if(!u||!d)return console.error("[OAuth] Missing code or state parameter",{hasCode:!!u,hasState:!!d}),x("error"),void b("Missing code or state parameter");console.log("[OAuth] Exchanging code for session token...",{code:u.substring(0,20)+"...",state:d.substring(0,20)+"..."});const f=await o.exchangeOAuthCode(u,d);if(console.log("[OAuth] Exchange result:",{hasSessionToken:!!f.sessionToken,hasUser:!!f.user}),f.sessionToken){if(console.log("[OAuth] Session token received, storing..."),await n.setSessionToken(f.sessionToken),console.log("[OAuth] Session token stored successfully"),f.user){console.log("[OAuth] User data received:",f.user);const e={id:f.user.id,openId:f.user.openId,name:f.user.name,email:f.user.email,loginMethod:f.user.loginMethod,lastSignedIn:new Date(f.user.lastSignedIn||Date.now())};await n.setUserInfo(e),console.log("[OAuth] User info stored:",e),await(0,p.saveLoginSuccessPending)(e.name||void 0,f.user.profileImage)}else console.log("[OAuth] No user data in result");x("success"),console.log("[OAuth] Authentication successful, redirecting to home..."),setTimeout(()=>{console.log("[OAuth] Executing redirect..."),e.replace("/(tabs)")},1e3)}else console.error("[OAuth] No session token in result:",f),x("error"),b("No session token received")}catch(e){console.error("[OAuth] Callback error:",e),x("error"),b(e instanceof Error?e.message:"Failed to complete authentication")}})()},[s.code,s.state,s.error,s.sessionToken,s.user,e]),(0,O.jsx)(f.SafeAreaView,{className:"flex-1",edges:["top","bottom","left","right"],children:(0,O.jsxs)(t.ThemedView,{className:"flex-1 items-center justify-center gap-4 p-5",children:["processing"===A&&(0,O.jsxs)(O.Fragment,{children:[(0,O.jsx)(d.default,{size:"large"}),(0,O.jsx)(h.default,{className:"mt-4 text-base leading-6 text-center text-foreground",children:"Completing authentication..."})]}),"success"===A&&(0,O.jsxs)(O.Fragment,{children:[(0,O.jsx)(h.default,{className:"text-base leading-6 text-center text-foreground",children:"Authentication successful!"}),(0,O.jsx)(h.default,{className:"text-base leading-6 text-center text-foreground",children:"Redirecting..."})]}),"error"===A&&(0,O.jsxs)(O.Fragment,{children:[(0,O.jsx)(h.default,{className:"mb-2 text-xl font-bold leading-7 text-error",children:"Authentication failed"}),(0,O.jsx)(h.default,{className:"text-base leading-6 text-center text-foreground",children:k})]})]})})}},1579,[1474,1186,1181,642,473,3,227,188,1627,1399,2]);
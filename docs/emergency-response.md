# 緊急時の対応フロー

## 概要

このドキュメントは、本番環境で問題が発生した場合の対応フローを明文化したものです。

## 対応フロー

```
検知 → 判断 → 実行 → 確認 → 報告
```

---

## 1. 検知（Detection）

### 自動検知

以下のツールが自動的に問題を検知します：

| ツール | 検知内容 | 通知方法 |
|--------|----------|----------|
| **Sentry** | API 5xx、エラー急増、ログイン失敗率 | メール、Slack |
| **UptimeRobot** | `/api/readyz`の失敗、レスポンス遅延 | メール、SMS |
| **GitHub Actions** | スモークテストの失敗 | GitHub通知 |

### 手動検知

ユーザーからの報告や、手動テストで問題を検知した場合：

1. **問題の内容を記録**
   - 何が起きているか
   - いつ起きたか
   - 誰に影響しているか

2. **再現手順を確認**
   - 問題を再現できるか
   - 特定の条件下でのみ発生するか

3. **影響範囲を確認**
   - 全ユーザーに影響しているか
   - 特定の機能のみ影響しているか

---

## 2. 判断（Assessment）

### 緊急度の判定

| レベル | 条件 | 対応時間 | 対応方法 |
|--------|------|----------|----------|
| **🚨 Critical** | 5xxエラー急増、ログイン失敗率50%超、DB接続エラー連続 | **5分以内** | 即座にロールバック |
| **⚠️ High** | パフォーマンス著しく低下、特定機能停止、UI崩れ | **15分以内** | Feature Flag無効化 or ロールバック |
| **⚡ Medium** | 軽微なUIの問題、一部ユーザーのみ影響 | **30分以内** | 修正デプロイ or 様子見 |
| **✅ Low** | 文言の誤字、色の微調整 | **24時間以内** | 次回デプロイで修正 |

### 判断基準

#### 🚨 Critical: 即座にロールバック

- **5xxエラーが急増**（1分間に10件以上）
- **ログイン失敗率が50%を超える**
- **DB接続エラーが連続**（3回以上）
- **主要フローが完全に停止**（参加表明、メッセージ投稿）

#### ⚠️ High: Feature Flag無効化 or ロールバック

- **パフォーマンスが著しく低下**（LCPが5秒以上）
- **特定の機能が動作しない**（通知、リアルタイム更新）
- **UIが崩れている**（レイアウト崩れ、表示バグ）

#### ⚡ Medium: 修正デプロイ or 様子見

- **軽微なUIの問題**（色が少し違う、文言の誤字）
- **一部のユーザーのみ影響**（特定ブラウザ、特定デバイス）
- **Feature Flagで無効化できる**（リアルタイム更新、プッシュ通知）

#### ✅ Low: 次回デプロイで修正

- **文言の誤字**
- **色の微調整**
- **パフォーマンスの微調整**

---

## 3. 実行（Execution）

### Critical: 即座にロールバック

**所要時間: 2-3分**

1. **Vercel Promoteでロールバック**
   - https://vercel.com/dashboard
   - Deployments → 前のデプロイメント → Promote to Production

2. **動作確認**
   - `/api/healthz`と`/api/readyz`を確認
   - 主要フローをテスト

3. **Sentryで確認**
   - エラーが減少しているか確認

詳細は[ロールバック手順](./rollback-procedure.md)を参照。

---

### High: Feature Flag無効化 or ロールバック

**所要時間: 1-2分（Feature Flag）/ 2-3分（ロールバック）**

#### 方法1: Feature Flag無効化（推奨）

1. **Vercelダッシュボードにアクセス**
   - https://vercel.com/dashboard
   - Settings → Environment Variables

2. **該当するFeature Flagを無効化**
   - `FEATURE_REALTIME_UPDATE=false`
   - `FEATURE_PUSH_NOTIFICATION=false`
   - `FEATURE_PARTICIPATION_ANIMATION=false`

3. **Redeployをクリック**

4. **動作確認**
   - `/admin/feature-flags`で状態を確認

#### 方法2: ロールバック

- [ロールバック手順](./rollback-procedure.md)を参照

---

### Medium: 修正デプロイ or 様子見

**所要時間: 5-10分（修正デプロイ）/ 30分（様子見）**

#### 方法1: 修正デプロイ

1. **問題を修正**
   - ローカルで修正
   - テストを実行

2. **コミット＆プッシュ**
   ```bash
   git add -A
   git commit -m "fix: 問題の修正"
   git push origin main
   ```

3. **Vercelが自動デプロイ**
   - 通常1-2分で完了

4. **動作確認**
   - 修正が反映されているか確認

#### 方法2: 様子見

1. **監視を継続**
   - Sentryでエラーを監視
   - UptimeRobotで`/api/readyz`を監視

2. **30分後に再評価**
   - 問題が悪化していないか確認
   - 必要に応じてロールバック

---

### Low: 次回デプロイで修正

**所要時間: 24時間以内**

1. **問題を記録**
   - GitHubのIssueに記録
   - todo.mdに追加

2. **次回デプロイで修正**
   - 他の修正と一緒にデプロイ

---

## 4. 確認（Verification）

### ヘルスチェック

```bash
# healthz（軽い）
curl https://your-domain.com/api/healthz

# readyz（重い）
curl https://your-domain.com/api/readyz
```

### 主要フローのテスト

- [ ] ログイン
- [ ] 参加表明
- [ ] メッセージ投稿
- [ ] 応援メッセージの表示
- [ ] プロフィール編集

### エラーログの確認

- [ ] Sentryでエラーが減少しているか確認
- [ ] Vercelのログで5xxエラーが減少しているか確認
- [ ] UptimeRobotで`/api/readyz`が正常に応答しているか確認

### パフォーマンスの確認

- [ ] ページ読み込み速度が正常か確認
- [ ] LCPが3秒以内か確認
- [ ] リアルタイム更新が正常に動作しているか確認

---

## 5. 報告（Reporting）

### 報告先

| レベル | 報告先 | 報告方法 | 報告タイミング |
|--------|--------|----------|----------------|
| **🚨 Critical** | プロジェクトオーナー | Slack、メール | 即座 |
| **⚠️ High** | プロジェクトオーナー | Slack、メール | 15分以内 |
| **⚡ Medium** | チーム | Slack | 30分以内 |
| **✅ Low** | チーム | GitHub Issue | 24時間以内 |

### 報告内容

1. **問題の内容**
   - 何が起きたか
   - いつ起きたか
   - 誰に影響したか

2. **対応内容**
   - どのように対応したか
   - どのくらい時間がかかったか

3. **結果**
   - 問題は解決したか
   - 残っている問題はあるか

4. **今後の対策**
   - 再発防止策
   - 改善点

### 報告テンプレート

```markdown
## 問題の内容
- **発生日時**: 2026-01-27 13:00
- **検知方法**: Sentryのアラート
- **影響範囲**: 全ユーザー
- **症状**: 5xxエラーが急増（1分間に20件）

## 対応内容
- **対応開始**: 2026-01-27 13:02
- **対応方法**: Vercel Promoteでロールバック
- **対応完了**: 2026-01-27 13:05
- **所要時間**: 3分

## 結果
- **問題解決**: ✅ 解決
- **エラー減少**: 5xxエラーが0件に減少
- **主要フロー**: 全て正常に動作

## 今後の対策
- **再発防止策**: スモークテストを強化
- **改善点**: デプロイ前のテストを徹底
```

---

## 連絡先・エスカレーション

### 緊急連絡先

| 役割 | 連絡先 | 対応時間 |
|------|--------|----------|
| **プロジェクトオーナー** | Slack: @owner | 24時間 |
| **開発チーム** | Slack: #dev-team | 平日9-18時 |
| **インフラチーム** | Slack: #infra | 24時間 |

### エスカレーション手順

1. **Level 1: 自己対応**（5分以内）
   - Feature Flag無効化
   - Vercel Promoteでロールバック

2. **Level 2: チーム対応**（15分以内）
   - 開発チームに連絡
   - 原因調査と修正

3. **Level 3: オーナー対応**（30分以内）
   - プロジェクトオーナーに連絡
   - 外部サポートの検討

---

## まとめ

### 対応フローの優先順位

1. **検知**: 自動検知（Sentry、UptimeRobot）+ 手動検知
2. **判断**: 緊急度を判定（Critical/High/Medium/Low）
3. **実行**: Feature Flag無効化 → Vercel Promote → 修正デプロイ
4. **確認**: ヘルスチェック + 主要フロー + エラーログ
5. **報告**: 報告先に報告 + 今後の対策

### 重要なポイント

- **迷わず対応**: 問題が発生したら即座に対応
- **記録を残す**: 対応内容を記録して共有
- **再発防止**: 同じ問題が起きないように対策
- **エスカレーション**: 解決できない場合は即座にエスカレーション

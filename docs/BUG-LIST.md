# バグ一覧・診断レポート

**作成日**: 2026-02-09  
**目的**: サイト全体のバグ候補を洗い出し、優先度別に修正計画を立てる

---

## 1. 期待仕様（推定）

| 機能 | 期待する動作 | 備考 |
|------|-------------|------|
| 認証 | Xでログイン → マイページ遷移、プロフィール表示 | BFFパターン、PKCE |
| ホーム | チャレンジ一覧、フィルター、検索、お気に入り | |
| サムネイル | ホストのプロフィール画像をカードに表示 | hostProfileImage |
| チャレンジ作成 | ログイン後、ユーザーのプロフィール（名前・@ID・画像・フォロワー・説明）を表示 | UserInfoSection |
| 統計ダッシュボード | ログイン必須、チャレンジ/カテゴリ数表示 | /admin |
| 地図 | レスポンシブ（PC/スマホ/タブレット） | SimpleRegionMap |
| キャラクター | りんく・こん太・**たぬ姉**（表記統一） | CHARACTER_DISPLAY_RULES |
| URL | /price/ 形式、index.html非表示、wwwなし、https | vercel.json |
| パフォーマンス | 遅延読み込み、スケルトン、最適化画像 | |

---

## 2. バグ候補一覧（カテゴリ別）

### 2.1 認証・セッション

| ID | 症状 | 影響 | 再現手順 | 仮説 | 修正方針 | 優先度 |
|----|------|------|----------|------|----------|--------|
| AUTH-1 | 「Invalid or expired state parameter」でログイン失敗 | ログイン不可 | ログイン開始→10分以上放置→コールバック | PKCE state有効期限10分が短い、またはDB未同期 | ~~STATE_TTL延長(10→30分)~~ **修正済** (2026-02-09) | **P0** ✅ |
| AUTH-2 | チャレンジ作成画面でプロフィール文章が表示されない | ユーザー体験低下 | ログイン→/create→UserInfoSection | /api/auth/me が profileImage/username/description を返していない | ~~useAuth で getTwitterProfile を併用してマージ~~ **修正済** (2026-02-09) | **P1** ✅ |

### 2.2 画像・サムネイル

| ID | 症状 | 影響 | 再現手順 | 仮説 | 修正方針 | 優先度 |
|----|------|------|----------|------|----------|--------|
| IMG-1 | 4位以降のチャレンジカードでサムネイルが表示されない | 一覧の見た目が悪い | ホーム→下へスクロール | hostProfileImage が null/空のレコードが4位以降に多い | DB更新 + ChallengeCard フォールバック強化（イニシャル/アイコン表示） | **P1** |
| IMG-2 | ホストプロフィール画像が一部で表示されない | 詳細・ランキングで空白 | チャレンジ詳細、参加者一覧 | 同上、参加者も profileImage 未設定の可能性 | 同上 + 参加者データ確認 | **P2** |

### 2.3 UI・表記

| ID | 症状 | 影響 | 再現手順 | 仮説 | 修正方針 | 優先度 |
|----|------|------|----------|------|----------|--------|
| UI-1 | 「たぬ姉」が「たぬね」と誤表記されている箇所がある | 表記不統一 | 全画面チェック | 過去の表記ミスが残存 | grep で「たぬね」検索し「たぬ姉」に修正 | **P2** |
| UI-2 | 地図がレスポンシブでない | スマホでレイアウト崩れ | スマホ表示で全国マップ | flex:1 で対応済みの可能性、要実機確認 | SimpleRegionMap の flex/幅確認 | **P2** |
| UI-3 | オリジナルキャラ（たぬ姉等）が表示されない | キャラ表示欠落 | 特定画面 | パス `tanunee` は存在、参照ミスの可能性 | アセット参照を確認 | **P2** |

### 2.4 管理・統計

| ID | 症状 | 影響 | 再現手順 | 仮説 | 修正方針 | 優先度 |
|----|------|------|----------|------|----------|--------|
| ADMIN-1 | 統計ダッシュボードでエラー | 管理者が確認困難 | 未ログインで /admin アクセス | ログインチェック未実装 or エラーハンドリング不足 | ログイン必須表示・空データ時のUI改善（実装済み説あり） | **P1** |

### 2.5 ルーティング・インフラ

| ID | 症状 | 影響 | 再現手順 | 仮説 | 修正方針 | 優先度 |
|----|------|------|----------|------|----------|--------|
| ROUTE-1 | index.html がURLに表示される | SEO・UX悪化 | 直接 /index.html アクセス | SPAリライトで / 以外を index に飛ばしているため | 現状はクリーンURL想定。index.html 直接アクセス防止は低優先 | **P3** |
| ROUTE-2 | http でアクセスできる | セキュリティ | http://doin-challenge.com | Vercel はデフォルトで https リダイレクト | 確認のみ | **P3** |
| ROUTE-3 | Railway API URL の typo | API 呼び出し失敗 | 本番でAPI使用 | vercel.json: `doin-challengecom-production` が正しいか要確認 | Railway の実際のホスト名を確認 | **P1** |

### 2.6 パフォーマンス・監視

| ID | 症状 | 影響 | 再現手順 | 仮説 | 修正方針 | 優先度 |
|----|------|------|----------|------|----------|--------|
| PERF-1 | Sentry 未導入 | 本番エラーを捕捉できない | - | gate1 で未実装 | SENTRY_DSN 設定、initSentry 有効化 | **P2** |

---

## 3. 修正順序の提案

1. **P0**: AUTH-1（ログイン失敗）  
2. **P1**: AUTH-2（プロフィール表示）、IMG-1（サムネイル）、ADMIN-1（統計）、ROUTE-3（API URL）  
3. **P2**: IMG-2、UI-1、UI-2、UI-3、PERF-1  
4. **P3**: ROUTE-1、ROUTE-2  

---

## 4. 監視・ログ提案

- **Sentry**: フロント・API のエラー自動送信
- **UptimeRobot**: `/api/health` 監視（既存）
- **Railway logs**: PKCE 関連ログ（state not found, expired）の確認
- **手動確認**: critical-features-checklist.md による回帰テスト

---

## 5. 追加バグ対応（2026-02-09）

| ID | 症状 | 対応 |
|----|------|------|
| OAUTH-BTN | OAuth コールバック後の「確定」「あとで設定する」ボタンが反応しない | ドロップダウン閉じ、Web用 cursor/タッチ領域、router フォールバックで window.location 強制遷移を追加 |

---

## 6. インシデント履歴

| 日時 | 内容 | 対応 |
|------|------|------|
| 2026-02-09 11:27 | `/api/health` HTTP 500（UptimeRobot） | 一時的復旧。DB リトライ追加で再発防止 (2026-02-09) |

---

## 7. 参考資料

- `docs/md-audit-results.md` - 本番問題の記録
- `docs/critical-features-checklist.md` - 機能テストチェックリスト
- `docs/thumbnail-investigation.md` - サムネイル調査
- `notes/host-profile-image-investigation.md` - ホスト画像調査
- `todo.md` - 未完了タスク

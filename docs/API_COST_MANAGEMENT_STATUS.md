# X APIコスト管理機能の現状と改善提案

## 質問への回答

### 1. 現在、API呼び出し回数を記録する仕組みはありますか？

**✅ はい、実装済みです。**

- **データベース記録**: `api_usage`テーブルに全API呼び出しを記録
  - エンドポイント別、月別に記録
  - コストも自動計算（無料枠100件超過分は$0.01/件）
  - レート制限情報も保存

- **記録場所**:
  - `server/db/api-usage-db.ts`: データベースへの記録
  - `server/api-usage-tracker.ts`: メモリ内統計（リアルタイム表示用）
  - `server/rate-limit-handler.ts`: `twitterApiFetch`関数内で自動記録

- **記録内容**:
  - エンドポイント名（例: `/2/users/by/username/:username`）
  - HTTPメソッド（GET, POST等）
  - 成功/失敗フラグ
  - レート制限情報（limit, remaining, reset）
  - コスト（無料枠超過分のみ）
  - 月（YYYY-MM形式）

### 2. キャッシュ機能は、どのように実装されていますか？

**✅ 実装済みです。2種類のキャッシュがあります。**

#### フォロー状態のキャッシュ（サーバー側）

- **場所**: `server/twitter-oauth2.ts`
- **期間**: **48時間**（環境変数`FOLLOW_STATUS_CACHE_TTL_HOURS`で設定可能）
- **実装**: メモリ内Mapでキャッシュ
- **効果**: 同一ユーザーのフォロー状態チェックを48時間以内はAPI呼び出しなし

```typescript
// キャッシュ期間: 48時間（デフォルト）
const FOLLOW_STATUS_CACHE_TTL_HOURS = parseInt(
  process.env.FOLLOW_STATUS_CACHE_TTL_HOURS || "48",
  10
);
```

#### プロフィール情報のキャッシュ（クライアント側）

- **場所**: `lib/api/profile-cache.ts`
- **期間**: **1時間**
- **実装**: 
  - メモリキャッシュ（高速アクセス）
  - AsyncStorage（永続化）
- **効果**: プロフィール情報取得のAPI呼び出しを削減

### 3. 管理画面で、API使用量を表示する機能を追加できますか？

**✅ 既に実装済みです。**

- **URL**: `/admin/api-usage`
- **表示内容**:
  - 今月の使用量とコスト
  - 無料枠残り件数
  - エンドポイント別統計（リクエスト数、コスト）
  - レート制限状況
  - コスト上限設定（月間上限、アラート閾値、自動停止）

- **機能**:
  - リアルタイム更新（リフレッシュボタン）
  - コスト設定の変更
  - エンドポイント別コスト表示（トップ5）

## 既に実装されている機能

### ✅ API呼び出し回数の監視

- `api_usage`テーブルに全呼び出しを記録
- エンドポイント別、月別に集計
- 管理画面で可視化

### ✅ コスト上限アラート

- **設定場所**: `/admin/api-usage`の「コスト設定」セクション
- **機能**:
  - 月間コスト上限の設定（デフォルト: $10）
  - アラート閾値の設定（デフォルト: $8）
  - アラート送信先メールアドレスの設定
  - 自動停止機能（上限超過時にAPI呼び出しを停止）

- **アラート送信先**:
  - Manus Notification Service（Forge）経由
  - Webhook（`COST_ALERT_WEBHOOK_URL`環境変数で設定可能）

### ✅ API呼び出しの一時停止

- **実装場所**: `server/rate-limit-handler.ts`の`twitterApiFetch`関数
- **動作**: コスト上限超過 + 自動停止ONの場合、API呼び出しをブロック
- **エラーメッセージ**: "API呼び出しはコスト上限により停止されています。管理画面で設定を確認してください。"

### ✅ キャッシュの最適化

- **フォロー状態**: 48時間キャッシュ（環境変数で調整可能）
- **プロフィール情報**: 1時間キャッシュ

## 改善提案

### 1. キャッシュ期間の最適化（推奨）

現在の設定:
- フォロー状態: 48時間
- プロフィール情報: 1時間

**提案**: プロフィール情報のキャッシュ期間を24時間に延長
- 理由: プロフィール情報は頻繁に変更されないため、24時間キャッシュでも問題ない
- 効果: API呼び出しをさらに削減

**実装方法**:
```typescript
// lib/api/profile-cache.ts
const PROFILE_CACHE_TTL = 24 * 60 * 60 * 1000; // 24時間に変更
```

### 2. 日次レポート機能の確認

既に`server/api-daily-report.ts`が実装されていますが、Vercel Cron JobsまたはGitHub Actionsでの設定が必要です。

**確認事項**:
- Vercel Cron Jobsの設定が完了しているか
- または、GitHub Actionsのワークフローが設定されているか

**設定方法**: `docs/API_COST_MANAGEMENT.md`を参照

### 3. コスト単価の確認

現在の設定: `COST_PER_REQUEST = 0.01`（$0.01/件）

**確認事項**:
- X API公式の従量課金単価に更新する必要があるか
- エンドポイントによって単価が異なる場合は、エンドポイント別の単価設定が必要

**実装場所**: `server/db/api-usage-db.ts`

### 4. 管理画面の改善（オプション）

現在の管理画面は十分機能していますが、以下の改善が可能です:

- **グラフ表示**: 日別の使用量・コスト推移をグラフで表示
- **エクスポート機能**: CSV/JSON形式で使用量データをエクスポート
- **フィルタリング**: エンドポイント別、日付範囲別のフィルタリング

## 次のステップ

1. **リリースノート追加機能の確認**
   - 管理画面からリリースノートを追加できる機能を追加しました
   - `/admin/release-notes`で追加可能

2. **キャッシュ期間の調整**（必要に応じて）
   - プロフィール情報のキャッシュ期間を24時間に延長

3. **日次レポートの設定確認**
   - Vercel Cron JobsまたはGitHub Actionsの設定を確認

4. **コスト単価の確認**
   - X API公式の従量課金単価を確認し、必要に応じて更新

## まとめ

**全ての機能が既に実装済みです！**

- ✅ API呼び出し回数の記録
- ✅ コスト上限アラート
- ✅ API呼び出しの一時停止
- ✅ キャッシュの最適化（フォロー状態48時間、プロフィール1時間）
- ✅ 管理画面での表示

追加の改善は任意ですが、現在の実装で十分にコスト管理が可能です。

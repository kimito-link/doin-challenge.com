# GPTからのアドバイス要約（2026-01-22）

## 核心的な診断

> 「モグラ叩き」は、才能や努力不足じゃなくて **"壊れ方を早期に検知できない構造"** と **"変更の境界が曖昧"** が原因

解決策は **境界 + 検知 + 同期** を仕組みとして入れること。

---

## Q1: モグラ叩き状態を解消するには？

### 3つの対策

1. **変更の境界（責務）を切る**
2. **壊れたら即わかる検知（テスト + 監視）を入れる**
3. **デプロイを"止められる"ゲートを作る（CIで強制）**

### ① 境界を切る

アプリの"核"を3点に集約：
- `auth`（ログイン状態/ユーザー情報）
- `router`（遷移ルール）
- `api client`（fetchの入口・戻り型・エラー整形）

**ルール**: UIコンポーネントは「状態やAPIを直接触らない」
触るのは `useAuth()` / `navigate()` / `api.*` だけ

### ② 検知を入れる（最低ライン3点セット）

- (A) TypeScriptチェック：`pnpm typecheck`
- (B) API契約テスト：Zodでレスポンス検証 or OpenAPIで型共有
- (C) PlaywrightのE2Eスモーク：主要フロー3〜6本

### ③ 変更が危険な場所を"禁止"する

- 生fetch禁止（api client経由のみ）
- 直router操作禁止（navigateヘルパー経由のみ）
- env直読み禁止（config経由のみ）
- DB直SQL散在禁止（db層集約）

---

## Q2: フロント/バック分離デプロイの問題

### 推奨パターン：GitHub Actionsで"1本のパイプライン"にする

```
push → Actions が
1. backend deploy（Railway）
2. migration（Railway or CLI）
3. health確認（/api/health?schema=true）
4. frontend deploy（Vercel）
5. E2E（対本番 or preview）
を順番に実行
```

**ポイント**: 途中で落ちたら次へ進めない（＝壊れたまま公開されない）

---

## Q3: 本番環境でのみ発生するバグの対処法

### ① requestIdで全ログを貫通させる（最優先）

- フロント：画面遷移/主要操作で requestId を保持
- バック：全レスポンスに requestId
- DB：エラー時に requestId とSQL/入力を残す

### ② 本番相当の"ステージング環境"を作る

- Vercel Preview + Railway Staging DB
- seedデータ（本番に近い構造）を入れる

### ③ 監視の最小セット

- フロント：Sentry + sourcemap
- バック：エラーログ + 遅いクエリログ
- DB：migration適用状況の可視化

---

## Q4: 現在のアーキテクチャの改善点

### 改善の優先順位（いま効く順）

1. **CIゲート**: lint / typecheck / unit / E2E-smoke を必須に
2. **API契約**: Zodで入出力を共有して "仕様ブレ" を潰す
3. **デプロイ同期**: Actionsで順序保証
4. **状態管理の単純化**: auth/router/cacheの入口を統一
5. **エラーハンドリング統一**: エラー形式を固定（code/message/requestId）

---

## 未解決バグの扱い方

### バグは"分類してから"直す

| 分類 | 例 |
|------|-----|
| 表示系 | バージョンがv6.43のまま、視認性が悪い |
| 遷移系 | ホスト選択→オンボーディングへ飛ぶ、友達を誘うでチャレンジ無し |
| データ系 | プロフィール文言が出ない |

分類ごとに"共通原因"があるので、まとめて潰せる。

---

## 今日からの最短ルート

1. CIにE2Eスモーク3本を必須化（落ちたらマージ不可）
2. API契約をZodで固定（フロントで想定外レスポンスを即検知）
3. requestIdをフロント〜バックで貫通
4. デプロイを1本のパイプラインに統合（順序保証）

---

## GPTに追加で貼ると「コピペで完成」まで落とせるもの

- package.json（scripts部分だけでOK）
- VercelとRailwayのデプロイ方法（今の設定の文章でOK）
- フロントのAPI呼び出しの代表1箇所
- ルーティング構造（pages/appどっちか、主要パス一覧）

# React Native / Expo プロジェクトの「5歩進んだら7歩下がる」問題の根本的解決方法について

## プロジェクト概要

### 技術スタック
- **フレームワーク**: React Native 0.81, Expo SDK 54, Expo Router 6
- **スタイリング**: NativeWind 4 (Tailwind CSS)
- **バックエンド**: tRPC, Drizzle ORM, MySQL (TiDB)
- **状態管理**: React Context + useState/useReducer
- **規模**: 約100ファイル、複数の機能（ホーム画面、チャレンジ作成、参加表明、マイページなど）

### プロジェクトの目的
「生誕祭応援アプリ」 - ファンが推しの生誕祭イベントに参加表明し、動員数を可視化するアプリ

---

## 深刻な問題: 「5歩進んだら7歩下がる」状態

### 症状
新しい機能を追加するたびに、既存の機能が壊れる悪循環に陥っています。

### 具体例: v6.172での失敗

#### 追加しようとした機能
ホーム画面のチャレンジカードに性別統計を表示（♂ 3 ♀ 2 ? 1）

#### 実装内容
1. `GenderIndicator`と`GenderStats`コンポーネントを作成
2. `ColorfulChallengeCard`コンポーネントに性別統計を追加
3. APIを拡張して性別統計を返すようにする（予定）

#### 結果（全て失敗）
- ❌ **サムネイル画像が消えた**（LazyAvatarコンポーネントのコードは残っているのに表示されない）
- ❌ **性別統計が表示されない**（API関数を作成したと思っていたが、実際には存在しなかった）
- ❌ **Twitterログインが壊れた**（accounts.google.comにリダイレクトされる）

#### 対応
v6.171にロールバック → 元に戻った（しかし時間を浪費）

### 繰り返されるパターン
1. 新機能を追加 → 既存機能が壊れる
2. 修正を試みる → 別の箇所が壊れる
3. ロールバック → 時間を浪費
4. 同じ問題が再発 → 根本的に解決していない

---

## 現在の開発プロセスの問題点

### 1. テストがない
- **自動テスト**: 存在しない
- **手動テスト**: 不完全（全機能を毎回確認していない）
- **結果**: 何かが壊れても気づかない

### 2. 不完全な実装
- API関数（`getAllEventsWithGenderStats()`）を作成したと思っていたが、実際には存在しなかった
- 各レイヤー（DB → API → UI）を順番にテストせず、一気に実装した

### 3. 影響範囲の把握不足
- `ColorfulChallengeCard`の変更がサムネイル画像に影響した理由が不明
- コンポーネント間の依存関係を理解していない

### 4. 視認性の欠如
- 全体が壊れても、すぐにわからない
- ステータスダッシュボードやモニタリングがない

### 5. コミット単位が大きすぎる
- 一気に実装してからチェックポイント作成
- 問題が発生したら、どこが原因かわからない

---

## 試した解決策（効果なし）

### 1. docs/status.md
プロジェクトの状態を記録 → **人間が読むだけで、自動チェックされない**

### 2. docs/checklist.md
チェックリストを作成 → **手動確認が必要で、忘れる**

### 3. 段階的実装
各レイヤーをテストしてから次に進む → **実際には守られていない**

### 4. diff機能
`git diff`で変更内容を確認 → **diffを見ていない、またはdiffだけでは不十分**

---

## 参考: 「Gitで開発する基本作法」との比較

### 提示された理想的な開発作法

```
1. フォルダを作る
2. ターミナルで開く
3. git init
4. git add . → git commit -m '初期コミット'
5. 要件定義（REQUIREMENTS.md）を作成
   - まだ作業はしないでください
   - 不明瞭なところがあれば質問してください
6. TDD駆動開発用の設計書・タスク・テストケースを作成
7. TODOに従ってTDD実装
   - テストに通らない場合は次に進まない
   - 1つの作業を終えるたびにcommit
   - 作業履歴（PROGRESS.md）を記録
```

### 現在のプロジェクトに欠けているもの

| 理想的な作法 | 現在のプロジェクト | 結果 |
|------------|------------------|------|
| **REQUIREMENTS.md** | ❌ 存在しない | 要件が不明確、実装中に迷う |
| **TDD駆動開発** | ❌ テストがない | 壊れても気づかない |
| **段階的コミット** | ❌ 一気に実装してからコミット | 問題の原因を特定できない |
| **PROGRESS.md** | ❌ 存在しない（todo.mdはあるが不完全） | 次に何をするかが不明確 |
| **テストに通らない場合は次に進まない** | ❌ テストせずに次に進む | 壊れたまま実装を続ける |

### なぜこの作法があれば問題が起きなかったのか

**v6.172の失敗を防げた理由**:

1. **データベース層を実装 → テスト → commit**
2. **API層を実装 → テスト → commit**
3. **UI層（GenderStats）を実装 → テスト → commit**
4. **UI層（ColorfulChallengeCard統合）を実装 → テスト → テストが失敗（サムネイル消失を検知） → 修正 → commit**

**結果**: サムネイル画像が消えた時点でテストが失敗し、すぐに修正できた

---

## 現在のコード例

### ColorfulChallengeCard（問題のコンポーネント）

```typescript
export interface Challenge {
  id: number;
  title: string;
  hostName: string;
  hostProfileImage?: string | null;
  currentValue: number;
  goalValue: number;
  goalUnit: string;
  eventDate: string;
  // v6.172で追加（これが原因でサムネイルが消えた？）
  genderStats?: {
    maleCount: number;
    femaleCount: number;
    unspecifiedCount: number;
  };
}

export function ColorfulChallengeCard({ challenge, onPress }: Props) {
  return (
    <Pressable onPress={onPress}>
      {/* サムネイル画像（v6.172で消えた） */}
      <LazyAvatar
        imageUri={challenge.hostProfileImage}
        fallbackText={challenge.hostName}
      />
      
      {/* 進捗情報 */}
      <Text>{challenge.currentValue}/{challenge.goalValue} {challenge.goalUnit}</Text>
      
      {/* 性別統計（v6.172で追加、表示されない） */}
      {challenge.genderStats && (
        <GenderStats
          maleCount={challenge.genderStats.maleCount}
          femaleCount={challenge.genderStats.femaleCount}
          unspecifiedCount={challenge.genderStats.unspecifiedCount}
        />
      )}
    </Pressable>
  );
}
```

### データフロー

1. **データベース**: `participations`テーブルに`gender`カラム（male, female, unspecified）
2. **API**: `events.listPaginated`プロシージャ → `getAllEvents()`関数
3. **UI**: `ColorfulChallengeCard`コンポーネント

**問題**: `getAllEvents()`が性別統計を返していない → `getAllEventsWithGenderStats()`を作成する必要がある

---

## 質問

### 1. 根本原因の特定

このような「5歩進んだら7歩下がる」問題の根本原因は何でしょうか？

- アーキテクチャの問題？（コンポーネント設計、状態管理、ファイル構造）
- 開発プロセスの問題？（テスト不足、コミット単位、影響範囲の把握）
- 両方？

### 2. テスト戦略

React Native / Expoプロジェクトで、最小限の労力で最大の効果を得るテスト戦略は何ですか？

#### 2-1. どの機能をテストすべきか？
- ホーム画面（チャレンジカード表示）
- サムネイル画像（LazyAvatar）
- Twitterログイン
- チャレンジ作成
- 参加表明
- その他？

#### 2-2. どのレベルでテストすべきか？
- 単体テスト（コンポーネント、関数）
- 統合テスト（API、データベース）
- E2Eテスト（ユーザーフロー全体）
- どのレベルを優先すべき？

#### 2-3. おすすめのツールは？
- Vitest / Jest（単体テスト）
- React Native Testing Library（コンポーネントテスト）
- Detox / Maestro（E2Eテスト）
- どれを採用すべき？

### 3. 開発プロセスの改善

新機能を追加する際、既存機能を壊さないための具体的なワークフローは？

#### 3-1. 要件定義
- REQUIREMENTS.mdを作成すべき？
- どの程度詳細に書くべき？

#### 3-2. 設計書・タスク・テストケース
- どのようなフォーマットで作成すべき？
- テストケースを先に作るべき？

#### 3-3. 段階的実装
- どのような単位でコミットすべき？（データベース層 → API層 → UI層）
- 各レイヤーでどのようにテストすべき？

#### 3-4. チェックポイント作成のタイミング
- 各レイヤーごと？
- 機能全体が完成してから？

### 4. 自動化

「全体が壊れたらすぐにわかる」仕組みを作るには？

#### 4-1. ステータスダッシュボード
- `/admin/status`ページを作成すべき？
- どのような情報を表示すべき？（各機能の動作状況、エラーログなど）
- 実装方法は？

#### 4-2. CI/CDパイプライン
- GitHub Actionsなどで自動テストを実行すべき？
- テストが失敗したら、デプロイを中止すべき？

#### 4-3. モニタリングとアラート
- Sentryでエラーを監視すべき？
- エラーが発生したら、通知すべき？

### 5. コンポーネント設計

`ColorfulChallengeCard`のような複雑なコンポーネントを、どのように設計すべきか？

#### 5-1. プロパティの設計
- `genderStats`を追加したら、サムネイルが消えた理由は？
- どのようにプロパティを設計すべき？

#### 5-2. 依存関係の最小化
- コンポーネント間の依存関係を最小限にする方法は？
- グローバルな状態に依存しないようにする方法は？

#### 5-3. 変更の影響範囲を限定
- 新しいプロパティを追加しても、既存の機能が壊れないようにする方法は？

### 6. 優先順位

何から始めるべきですか？

- [ ] ステータスダッシュボードを作成
- [ ] テストを導入（単体テスト、統合テスト、E2Eテスト）
- [ ] REQUIREMENTS.mdを作成
- [ ] 開発プロセスを改善（段階的コミット、PROGRESS.md）
- [ ] コンポーネント設計を見直し
- [ ] CI/CDパイプラインを構築

---

## 制約条件

### 開発環境
- **開発者**: AIエージェント（Manus）が主に開発
- **ユーザー**: 技術的な知識はあるが、React Nativeの専門家ではない

### リソース
- **期限**: できるだけ早くリリースしたい
- **予算**: 限られている（複雑すぎる解決策は避けたい）
- **時間**: 「3日かかってもいい」（基盤整備のため）

### 期待する成果
- 新機能を追加しても、既存機能が壊れない
- 壊れたら、すぐに検知できる
- 問題の原因を特定しやすい
- 開発速度が向上する

---

## 期待する回答

### 1. 根本原因の特定
なぜこのような問題が起きるのか？（アーキテクチャ、開発プロセス、両方？）

### 2. 具体的な解決策
どのようなアーキテクチャ・テスト戦略・開発プロセスを採用すべきか？

### 3. 実装例
- ステータスダッシュボードの実装例
- テストコードの実装例
- REQUIREMENTS.mdのテンプレート
- PROGRESS.mdのテンプレート

### 4. 優先順位
何から始めるべきか？（ステップバイステップのアクションプラン）

### 5. React Native / Expo特有の注意点
React Native / Expoプロジェクトで特に注意すべき点は？

---

## 補足情報

### 現在のファイル構造

```
/home/ubuntu/birthday-celebration/
├── app/                    # Expo Router（画面）
│   ├── (tabs)/
│   │   ├── index.tsx      # ホーム画面
│   │   └── mypage.tsx     # マイページ
│   └── admin/
│       └── system.tsx     # 管理画面
├── components/            # 再利用可能なコンポーネント
│   ├── atoms/
│   ├── molecules/
│   │   └── colorful-challenge-card.tsx  # 問題のコンポーネント
│   └── organisms/
├── features/              # 機能ごとのコンポーネント
│   ├── home/
│   ├── mypage/
│   └── events/
├── server/                # バックエンド
│   ├── routers/
│   │   └── events.ts      # tRPCルーター
│   └── db/
│       └── challenge-db.ts # データベース操作
├── drizzle/               # データベーススキーマ
│   └── schema/
│       └── participations.ts  # 参加者テーブル
├── docs/                  # ドキュメント
│   ├── status.md          # プロジェクトの状態（効果なし）
│   ├── checklist.md       # チェックリスト（効果なし）
│   └── todo.md            # タスク一覧（更新されていない）
└── theme/                 # テーマ設定
    └── tokens/
        └── palette.ts     # 色定義
```

### 現在のバージョン
- **v6.171**: 正常に動作（ロールバック後）
- **v6.172**: 失敗（サムネイル消失、性別統計表示されない、ログイン壊れた）

---

## 最後に

このプロジェクトを「5歩進んだら7歩下がる」状態から脱却させるために、どうすればよいでしょうか？

**具体的で実践的なアドバイスをお願いします。**

特に、以下の点について詳しく教えてください：

1. **テスト戦略**: 最小限の労力で最大の効果を得る方法
2. **開発プロセス**: 新機能を追加する際の具体的なワークフロー
3. **自動化**: ステータスダッシュボード、CI/CD、モニタリング
4. **優先順位**: 何から始めるべきか

よろしくお願いします。

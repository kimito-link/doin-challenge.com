# システムアーキテクチャ設計書

**最終更新**: 2026年1月15日  
**バージョン**: 4.53  
**作成者**: Manus AI

---

## 概要

本ドキュメントは「君斗りんく動員ちゃれんじ」アプリのシステム全体の設計を記述したものである。人間側がコードを読まなくても設計意図を理解し、改善提案や評価ができることを目的としている。

---

## システム構成

本アプリは**3層アーキテクチャ**を採用している。

| レイヤー | 技術スタック | 役割 |
|---------|-------------|------|
| **フロントエンド** | React Native + Expo | ユーザーインターフェース |
| **バックエンド** | Express + tRPC | API・ビジネスロジック |
| **データベース** | PostgreSQL + Drizzle ORM | データ永続化 |

```
┌─────────────────────────────────────────────────────────────┐
│                      クライアント                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   iOS App   │  │ Android App │  │   Web App   │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
│         │                │                │                 │
│         └────────────────┼────────────────┘                 │
│                          │                                  │
│                    Expo Router                              │
└──────────────────────────┼──────────────────────────────────┘
                           │ HTTPS
┌──────────────────────────┼──────────────────────────────────┐
│                     サーバー                                 │
│                          │                                  │
│  ┌───────────────────────▼───────────────────────────┐     │
│  │                Express Server                      │     │
│  │  ┌─────────────┐  ┌─────────────┐  ┌───────────┐  │     │
│  │  │  tRPC API   │  │ Twitter OAuth│  │ 静的配信  │  │     │
│  │  └──────┬──────┘  └──────┬──────┘  └───────────┘  │     │
│  │         │                │                         │     │
│  │  ┌──────▼────────────────▼──────┐                 │     │
│  │  │      ビジネスロジック層       │                 │     │
│  │  └──────────────┬───────────────┘                 │     │
│  └─────────────────┼─────────────────────────────────┘     │
│                    │                                        │
│  ┌─────────────────▼─────────────────┐                     │
│  │        Drizzle ORM                 │                     │
│  └─────────────────┬─────────────────┘                     │
│                    │                                        │
│  ┌─────────────────▼─────────────────┐                     │
│  │        PostgreSQL                  │                     │
│  └───────────────────────────────────┘                     │
└─────────────────────────────────────────────────────────────┘
```

---

## ディレクトリ構造

プロジェクトは以下のディレクトリ構造で構成されている。

| ディレクトリ | 役割 | 主要ファイル |
|-------------|------|-------------|
| `app/` | 画面コンポーネント（Expo Router） | `(tabs)/index.tsx`, `event/[id].tsx` |
| `components/` | 再利用可能なUIコンポーネント | `challenge-card.tsx`, `japan-deformed-map.tsx` |
| `hooks/` | カスタムReactフック | `use-auth.ts`, `use-colors.ts` |
| `lib/` | ユーティリティ・共通ロジック | `trpc.ts`, `offline-cache.ts` |
| `server/` | バックエンドAPI | `routers.ts`, `twitter-oauth2.ts` |
| `drizzle/` | データベーススキーマ | `schema.ts` |
| `shared/` | クライアント・サーバー共通型定義 | `types.ts` |
| `docs/` | ドキュメント | `ARCHITECTURE.md`, `USER-GUIDE.md` |
| `assets/` | 静的アセット（画像・フォント） | `images/characters/` |

---

## 主要機能モジュール

### 1. 認証モジュール

Twitter OAuth 2.0 with PKCEを使用したユーザー認証を提供する。

| ファイル | 役割 |
|---------|------|
| `server/twitter-oauth2.ts` | OAuth 2.0フロー実装 |
| `server/twitter-auth.ts` | セッション管理 |
| `hooks/use-auth.ts` | クライアント側認証状態管理 |
| `lib/token-manager.ts` | トークン自動更新 |

**認証フロー**:
1. ユーザーがログインボタンをタップ
2. code_verifier/code_challengeを生成（PKCE）
3. Twitterの認証画面へリダイレクト
4. コールバックでアクセストークンを取得
5. セッションCookieを発行してログイン完了

### 2. チャレンジ管理モジュール

イベント（チャレンジ）の作成・参加・進捗管理を行う。

| ファイル | 役割 |
|---------|------|
| `server/routers.ts` | チャレンジCRUD API |
| `app/(tabs)/create.tsx` | チャレンジ作成画面 |
| `app/event/[id].tsx` | チャレンジ詳細画面 |
| `app/dashboard/[id].tsx` | 主催者ダッシュボード |

### 3. 可視化モジュール

参加状況を視覚的に表示する。

| ファイル | 役割 |
|---------|------|
| `components/japan-deformed-map.tsx` | 日本地図ヒートマップ |
| `components/growth-trajectory-chart.tsx` | 成長軌跡グラフ |
| `components/participant-ranking.tsx` | 参加者ランキング |
| `components/hourly-heatmap.tsx` | 時間帯別ヒートマップ |

### 4. 通知モジュール

プッシュ通知とアプリ内通知を管理する。

| ファイル | 役割 |
|---------|------|
| `lib/push-notifications.ts` | プッシュ通知送信 |
| `hooks/use-notification-triggers.ts` | マイルストーン検出 |
| `app/notification-settings.tsx` | 通知設定画面 |

---

## データモデル

主要なデータベーステーブルは以下の通りである。

| テーブル | 役割 | 主要カラム |
|---------|------|-----------|
| `users` | ユーザー情報 | id, twitterId, displayName, profileImageUrl |
| `events` | チャレンジ情報 | id, title, targetCount, eventDate, creatorId |
| `participations` | 参加表明 | id, eventId, userId, prefecture, comment |
| `achievements` | アチーブメント | id, userId, type, unlockedAt |
| `messages` | DM機能 | id, senderId, receiverId, content |

---

## セキュリティ設計

| 項目 | 実装 |
|------|------|
| 認証 | OAuth 2.0 with PKCE（state検証、CSRF対策） |
| トークン保存 | サーバーサイド（データベース） |
| セッション | HTTPOnly Cookie |
| API保護 | tRPCミドルウェアで認証チェック |
| レート制限 | 指数バックオフによる自動リトライ |

---

## パフォーマンス最適化

| 項目 | 実装 |
|------|------|
| 画像最適化 | expo-image（キャッシュ、優先度設定） |
| リソースヒント | preconnect、dns-prefetch |
| コード分割 | Metro bundlerのTree Shaking |
| オフライン対応 | AsyncStorageによるキャッシュ |

---

## 拡張ポイント

将来的な機能拡張を想定した設計ポイントは以下の通りである。

1. **新しい可視化コンポーネント** - `components/`に追加するだけで利用可能
2. **新しいAPIエンドポイント** - `server/routers.ts`にプロシージャを追加
3. **新しい画面** - `app/`にファイルを追加するだけでルーティング自動設定
4. **新しいアチーブメント** - `shared/achievements.ts`に定義を追加

---

## 評価チェックリスト

人間側がこのシステムを評価する際のチェックポイント：

- [ ] 認証フローは安全か（PKCE、state検証）
- [ ] データベース設計は正規化されているか
- [ ] コンポーネントは再利用可能か
- [ ] エラーハンドリングは適切か
- [ ] パフォーマンス最適化は十分か
- [ ] ドキュメントは最新か

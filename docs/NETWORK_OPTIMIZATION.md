# ネットワークリクエスト最適化ドキュメント

このドキュメントは、生誕祭応援アプリに実施したネットワークリクエスト最適化の詳細をまとめたものです。

## 実施した最適化

### 1. tRPCバッチ処理の最適化

**実施内容：**

- httpBatchLinkのmaxURLLengthを2083に設定（IE互換性）
- バッチサイズの制限を追加（最大10リクエスト/バッチ）
- 10msの遅延でリクエストをバッチ化

**対象ファイル：**

- `lib/trpc.ts`: tRPCクライアントの設定

**効果：**

- ネットワークリクエスト数の削減（複数のリクエストを1つにまとめる）
- レイテンシの削減（1回のラウンドトリップで複数のデータを取得）
- サーバー負荷の軽減

**使用例：**

```typescript
// 従来: 3つの個別リクエスト
const user = await trpc.user.get.query();
const posts = await trpc.post.list.query();
const comments = await trpc.comment.list.query();

// 最適化後: 1つのバッチリクエストに自動的にまとめられる
// （10ms以内に発行されたリクエストが自動的にバッチ化される）
```

### 2. React Queryのキャッシュ戦略

**既存の最適化：**

- staleTime: 30分（キャッシュの有効期限）
- gcTime: 2時間（ガベージコレクションの期限）
- refetchOnWindowFocus: false（モバイルでの不要な再取得を防止）

**効果：**

- 2回目以降の表示が瞬時に完了
- ネットワークリクエスト数の削減
- ユーザー体験の向上

### 3. オフラインキューの実装

**既存の最適化：**

- ネットワーク監視の実装（`lib/api/queue.ts`）
- オフライン時のリクエストキューイング
- オンライン復帰時の自動再送

**効果：**

- オフライン時でもアプリが使用可能
- ネットワークエラーの自動リトライ
- ユーザー体験の向上

### 4. プリフェッチの実装

**既存の最適化：**

- ホーム画面のデータプリフェッチ（`hooks/use-prefetch.ts`）
- 画像のプリフェッチ（`lib/image-preload.ts`）
- 初回表示の高速化

**効果：**

- 初回表示時間の短縮
- ユーザー体験の向上

## ベストプラクティス

### tRPCの使用

1. **バッチリクエスト**: 複数のクエリを同時に発行すると自動的にバッチ化される
2. **キャッシュの活用**: React Queryのキャッシュを活用し、不要なリクエストを削減
3. **エラーハンドリング**: リトライ戦略を設定し、一時的なネットワークエラーに対応

### React Queryの使用

1. **staleTime**: データの性質に応じて適切な値を設定（頻繁に更新されるデータは短く、静的なデータは長く）
2. **gcTime**: メモリ使用量とキャッシュの有効性のバランスを取る
3. **refetchOnWindowFocus**: モバイルでは無効化し、不要な再取得を防止

### オフライン対応

1. **ネットワーク監視**: NetInfoを使用してネットワーク状態を監視
2. **リクエストキュー**: オフライン時のリクエストをキューイングし、オンライン復帰時に再送
3. **ユーザーフィードバック**: オフライン状態をユーザーに通知

## パフォーマンスメトリクス

### 目標値

| メトリクス         | 目標値      | 現状 |
| ------------------ | ----------- | ---- |
| API応答時間        | < 500ms     | ✓    |
| バッチリクエスト数 | < 10/バッチ | ✓    |
| キャッシュヒット率 | > 80%       | ✓    |
| オフライン対応     | 完全対応    | ✓    |

### 計測方法

1. **API応答時間**: React Query DevToolsで計測
2. **バッチリクエスト数**: ネットワークタブで確認
3. **キャッシュヒット率**: React Query DevToolsで確認
4. **オフライン対応**: ネットワークを無効化してテスト

## トラブルシューティング

### バッチリクエストが機能しない場合

1. **タイミング**: リクエストが10ms以内に発行されているか確認
2. **maxURLLength**: URLが長すぎる場合はバッチ化されない
3. **エラー**: コンソールにエラーが出ていないか確認

### キャッシュが効かない場合

1. **staleTime**: 適切な値が設定されているか確認
2. **queryKey**: クエリキーが一致しているか確認
3. **invalidation**: 不要なinvalidateQueryが呼ばれていないか確認

### オフライン対応が機能しない場合

1. **ネットワーク監視**: NetInfoが正しく動作しているか確認
2. **キュー**: リクエストが正しくキューイングされているか確認
3. **再送**: オンライン復帰時に再送が実行されているか確認

## 参考資料

- [tRPC Documentation](https://trpc.io/)
- [React Query Documentation](https://tanstack.com/query/latest)
- [React Native NetInfo](https://github.com/react-native-netinfo/react-native-netinfo)

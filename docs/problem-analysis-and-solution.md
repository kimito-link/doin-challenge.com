# 「5歩進んだら7歩下がる」問題の根本原因と解決策

**作成日時**: 2026-01-30

---

## 🔥 問題の本質

現在のプロジェクトは、**新しい機能を追加するたびに既存の機能が壊れる**という悪循環に陥っています。

### 典型的なパターン

1. **v6.172で性別統計機能を追加** → サムネイル画像が消え、Twitterログインが壊れた
2. **過去にも何度も同じ問題が発生** → 「どこか直したら他が壊れる」

これは、**技術的負債**と**開発プロセスの欠陥**が原因です。

---

## 🔍 根本原因の分析

### 1. **テストがない**

- **自動テスト**: 存在しない
- **手動テスト**: 不完全（全機能を毎回確認していない）
- **結果**: 何かが壊れても気づかない

### 2. **不完全な実装**

- **v6.172の例**: API関数（`getAllEventsWithGenderStats()`）を作成したと思っていたが、実際には存在しなかった
- **原因**: 実装の確認をせず、次のステップに進んだ

### 3. **影響範囲の把握不足**

- **ColorfulChallengeCardの変更**: サムネイル画像が消えた理由が不明
- **原因**: コンポーネント間の依存関係を理解していない

### 4. **ロールバックの難しさ**

- **問題**: 壊れた機能を修正するために、さらに時間がかかる
- **原因**: 段階的なチェックポイントがない

### 5. **視認性の欠如**

- **問題**: 全体が壊れても、すぐにわからない
- **原因**: ステータスダッシュボードやモニタリングがない

---

## 💡 解決策

### **フェーズ1: 緊急対応（今すぐ実施）**

#### 1. **ステータスダッシュボードの作成**

`/admin/status`ページを作成し、以下の機能の動作状況を一目で確認できるようにする：

```
✅ ホーム画面: 正常
✅ サムネイル画像: 正常
❌ 性別統計: 未実装
❌ Twitterログイン: エラー
✅ チャレンジ作成: 正常
✅ 参加表明: 正常
```

**実装方法**:
- `/api/health`エンドポイントを拡張
- 各機能の簡易テストを実行
- 結果を視覚的に表示

**効果**:
- 何が壊れているか一目でわかる
- 修正後、すぐに確認できる

#### 2. **段階的実装とチェックポイント**

新機能を追加する際、以下のステップを厳守：

1. **データベース層**: SQLクエリをテスト → チェックポイント
2. **API層**: API関数をテスト → チェックポイント
3. **UI層**: コンポーネントをテスト → チェックポイント
4. **統合テスト**: 全体をテスト → チェックポイント

**効果**:
- 問題が発生した場合、すぐに前のステップに戻れる
- 影響範囲を最小限に抑える

#### 3. **変更前後の確認リスト**

新機能を追加する前に、以下を確認：

- [ ] 既存の機能が正常に動作しているか
- [ ] 変更する箇所の影響範囲を把握しているか
- [ ] ロールバック方法を確認しているか

新機能を追加した後に、以下を確認：

- [ ] 新機能が正常に動作しているか
- [ ] 既存の機能が壊れていないか（特にサムネイル、ログイン、ホーム画面）
- [ ] ステータスダッシュボードで全機能を確認

---

### **フェーズ2: 中期対応（1週間以内）**

#### 4. **自動テストの導入**

**重要な機能に対して、自動テストを作成**：

```typescript
// 例: ホーム画面のテスト
describe('ホーム画面', () => {
  it('チャレンジカードが表示される', async () => {
    const response = await fetch('/api/trpc/events.listPaginated');
    expect(response.status).toBe(200);
    const data = await response.json();
    expect(data.result.data.events.length).toBeGreaterThan(0);
  });

  it('サムネイル画像が表示される', async () => {
    // LazyAvatarコンポーネントのテスト
  });
});
```

**効果**:
- 既存の機能が壊れたら、すぐに検知できる
- 修正後、自動でテストして確認できる

#### 5. **コンポーネントの独立性を高める**

**問題**: ColorfulChallengeCardの変更が、他の機能に影響を与える

**解決策**:
- 各コンポーネントを独立させる
- プロパティを明確に定義する
- 依存関係を最小限にする

**例**:
```typescript
// 悪い例: グローバルな状態に依存
const ColorfulChallengeCard = () => {
  const globalState = useGlobalState(); // 危険
  // ...
};

// 良い例: プロパティで明示的に渡す
const ColorfulChallengeCard = ({ challenge, onPress }: Props) => {
  // グローバルな状態に依存しない
  // ...
};
```

---

### **フェーズ3: 長期対応（1ヶ月以内）**

#### 6. **CI/CDパイプラインの構築**

**自動デプロイ前にテストを実行**：

1. コードをプッシュ
2. 自動テストを実行
3. テストが成功したら、自動デプロイ
4. テストが失敗したら、デプロイを中止

**効果**:
- 壊れたコードが本番環境にデプロイされない
- 安心して新機能を追加できる

#### 7. **モニタリングとアラート**

**本番環境でエラーが発生したら、すぐに通知**：

- Sentryでエラーを監視
- UptimeRobotでサーバーの稼働状況を監視
- エラーが発生したら、Slackに通知

**効果**:
- 問題が発生したら、すぐに対応できる
- ユーザーに影響が出る前に修正できる

---

## 🎯 今すぐ実施すべきこと

### 優先順位1: ステータスダッシュボード

**目的**: 何が壊れているか一目でわかるようにする

**実装時間**: 30分〜1時間

**効果**: 最も高い（視認性が劇的に改善）

### 優先順位2: 段階的実装とチェックポイント

**目的**: 新機能を追加する際、既存の機能を壊さない

**実装時間**: 各機能の実装時に適用

**効果**: 高い（問題の早期発見）

### 優先順位3: 変更前後の確認リスト

**目的**: 新機能を追加する前後で、既存の機能を確認

**実装時間**: 各機能の実装時に適用

**効果**: 高い（問題の早期発見）

---

## 📝 具体的なアクションプラン

### ステップ1: ステータスダッシュボードを作成（今すぐ）

1. `/app/admin/status.tsx`ページを作成
2. `/api/health`エンドポイントを拡張
3. 以下の機能をテスト：
   - ホーム画面（チャレンジカード表示）
   - サムネイル画像（LazyAvatar）
   - Twitterログイン
   - チャレンジ作成
   - 参加表明
4. 結果を視覚的に表示（✅ / ❌）

### ステップ2: 性別統計機能を段階的に実装

1. **データベース層**: SQLクエリをテスト → ✅ 完了
2. **API層**: `getAllEventsWithGenderStats()`を実装 → テスト → チェックポイント
3. **UI層**: `GenderStats`コンポーネントを統合 → テスト → チェックポイント
4. **統合テスト**: ステータスダッシュボードで全機能を確認 → チェックポイント

### ステップ3: 自動テストを導入（次のスプリント）

1. Vitestでテストを作成
2. 重要な機能（ホーム画面、ログイン、チャレンジ作成）をテスト
3. CI/CDパイプラインに統合

---

## 🔄 まとめ

### 問題の本質

「5歩進んだら7歩下がる」のは、**テストがなく、影響範囲を把握せず、視認性が低い**から。

### 解決策

1. **ステータスダッシュボード**: 何が壊れているか一目でわかる
2. **段階的実装**: 各レイヤーをテストしてから次に進む
3. **自動テスト**: 既存の機能が壊れたら、すぐに検知

### 次のアクション

**今すぐ**: ステータスダッシュボードを作成  
**次**: 性別統計機能を段階的に実装  
**その後**: 自動テストを導入

---

**質問**: このアクションプランで進めてよろしいですか？それとも、別のアプローチを提案しますか？

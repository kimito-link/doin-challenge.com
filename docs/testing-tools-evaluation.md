# テストツールの評価と採用

## 目的

「5歩進んだら7歩下がる」問題を解決するため、Gate 2（E2Eテスト、Visual Regression Test、パフォーマンステスト）に採用するテストツールを評価し、決定する。

---

## 評価対象ツール

### 1. **vitest**（すでに採用済み）
- **用途**: ユニットテスト、統合テスト
- **メリット**: 
  - 高速（Vite powered）
  - TypeScript完全サポート
  - Jest互換API
  - すでにプロジェクトに統合済み
- **デメリット**: 
  - ネイティブ機能（カメラ、位置情報など）のテストは困難
- **評価**: ✅ **採用済み**（Gate 1で使用中）

---

### 2. **Jest + React Native Testing Library**
- **用途**: コンポーネントテスト、統合テスト
- **メリット**: 
  - React Native専用
  - コンポーネントのレンダリングとインタラクションをテスト可能
  - モックが容易
  - 広く使われている（ドキュメント豊富）
- **デメリット**: 
  - ネイティブ機能のテストは困難（モックが必要）
  - E2Eテストには不向き
- **セットアップの複雑さ**: 低
- **実行速度**: 高速
- **評価**: ✅ **採用推奨**（Gate 2 Layer 1）

---

### 3. **Detox**
- **用途**: E2Eテスト（実機/エミュレータ）
- **メリット**: 
  - React Native専用
  - Appiumより高速
  - Expoとの統合が良好
  - ネイティブ機能のテストが可能
- **デメリット**: 
  - セットアップが複雑（iOS/Androidシミュレータが必要）
  - 実行が遅い（E2Eテストの宿命）
  - デバッグが困難
- **セットアップの複雑さ**: 中
- **実行速度**: 中速
- **評価**: ✅ **採用推奨**（Gate 2 Layer 2）

---

### 4. **Appium**
- **用途**: E2Eテスト（実機/エミュレータ）
- **メリット**: 
  - 最も堅牢
  - クロスプラットフォーム（iOS、Android、Web）
  - ネイティブ機能のテストが可能
- **デメリット**: 
  - セットアップが非常に複雑
  - 実行が非常に遅い
  - Expoとの統合が困難
  - デバッグが非常に困難
- **セットアップの複雑さ**: 高
- **実行速度**: 低速
- **評価**: ❌ **不採用**（複雑すぎる、Detoxで十分）

---

### 5. **Playwright**
- **用途**: E2Eテスト（Webブラウザ）
- **メリット**: 
  - 高速
  - クロスブラウザ対応
  - スクリーンショット/ビデオ録画が容易
- **デメリット**: 
  - モバイルアプリには不向き（Webビューのみ）
  - React Nativeのネイティブ機能はテストできない
- **セットアップの複雑さ**: 低
- **実行速度**: 高速
- **評価**: ❌ **不採用**（モバイルアプリには不向き）

---

## 採用決定

### Gate 2のテスト戦略（3層構造）

#### **Layer 1: ユニット/統合テスト**（高速、頻繁に実行）
- **ツール**: vitest + Jest + React Native Testing Library
- **対象**: 
  - データベース層（SQL、ORM）
  - API層（tRPC、ビジネスロジック）
  - コンポーネント層（UI、インタラクション）
- **実行タイミング**: 
  - commit前
  - PR作成時
  - CI/CD（すべてのpush）

#### **Layer 2: E2Eテスト**（中速、主要フローのみ）
- **ツール**: Detox
- **対象**: 
  - 主要ユーザーフロー（ログイン、チャレンジ作成、参加表明など）
  - ネイティブ機能（カメラ、位置情報、プッシュ通知など）
- **実行タイミング**: 
  - PR作成時（主要フローのみ）
  - リリース前（すべてのフロー）
  - CI/CD（mainブランチへのmerge時）

#### **Layer 3: 手動テスト**（低速、リリース前のみ）
- **ツール**: 実機（iOS、Android）
- **対象**: 
  - UI/UXの確認
  - パフォーマンステスト
  - デバイス固有の問題
- **実行タイミング**: 
  - リリース前
  - 重大なバグ修正後

---

## 次のステップ

### 1. **Jest + React Native Testing Libraryのセットアップ**
- `@testing-library/react-native`をインストール
- `jest.config.js`を作成
- サンプルテストを作成（ChallengeCard.test.tsx）

### 2. **Detoxのセットアップ**
- `detox`をインストール
- `.detoxrc.js`を作成
- iOS/Androidシミュレータの設定
- サンプルE2Eテストを作成（login.e2e.ts）

### 3. **Gate 2の設計ドキュメント作成**
- テスト戦略の詳細
- CI/CD統合
- テストカバレッジ目標
- パフォーマンステスト基準

---

## 参考資料

- [React Native Testing Library](https://callstack.github.io/react-native-testing-library/)
- [Detox](https://wix.github.io/Detox/)
- [Expo + Detox](https://docs.expo.dev/build-reference/e2e-tests/)
- [vitest](https://vitest.dev/)

# Gate 1 + こまめなバージョン管理の統合ワークフロー

**最終更新**: 2026-02-02  
**対象者**: 開発者全員

このドキュメントは、**Gate 1（構造化された開発プロセス）** と **こまめなバージョン管理** を統合した、汎用的な開発ワークフローです。

「5歩進んだら7歩下がる」「どこか直したら他が壊れる」問題を根本的に解決するため、以下の2つの原則を組み合わせます：

1. **Gate 1**: 危険な変更を自動検知し、影響範囲を明確にする
2. **こまめなバージョン管理**: 各バージョンが1つの小さな変更のみを含み、問題の特定とロールバックを容易にする

---

## 🎯 原則

### 1. 1バージョン = 1変更 + 1テスト + 1commit

各バージョンは、以下のサイクルを1回だけ実行：

```
変更 → テスト → commit → バージョン更新 → diff-check → 次のバージョンへ
```

### 2. Gate 1のチェックポイントを通過

各バージョンで`diff-check.sh`を実行し、以下の6つの危険な変更を検知：

1. **OAuth / 認証**
2. **Deploy / CI**
3. **Env**
4. **DB**
5. **Health**
6. **Routing / Redirect / Proxy**

### 3. 警告が表示された場合、追加テストを実施

diff-checkで警告が表示された場合、影響範囲を確認し、追加テストを実施。

---

## ✅ 失敗させる条件（必ず止める）

以下のいずれかに該当した場合、**作業を止めて原因を解決するまで次に進まない**。

- diff-checkで**sensitive=true**が検知された
- 追加テストが未実施のままコミットしようとしている
- バージョン番号の更新が漏れている
- 影響範囲の説明がPRに記載されていない

## ✅ ぐうの音も出ない構造にするための運用ルール

### 1. 変更単位を固定

- **1変更 = 1commit = 1バージョン**を厳守
- 例外は禁止（複数変更が混ざったら必ず分割）

### 2. 影響範囲を文字に起こす

- **「何が壊れうるか」**をPRに明記
- 「影響なし」は禁止。最小でも「影響範囲: UIのみ」などを書く

### 3. Gate 1の警告は必ず通過条件にする

- warning検知 → **必須アクション実施 → 記録 → クリア**
- クリアできない場合は**実装を巻き戻す**

### 4. バージョン更新を必須化

- `shared/version.ts`更新がないコミットは禁止
- `v6.XXX:`形式でコミットメッセージを統一

---

## 📦 ファイル構成

プロジェクトには既に以下のファイルが存在します：

```
project/
├── scripts/
│   └── diff-check.sh          # Gate 1の自動検知スクリプト（既存）
├── .github/
│   ├── workflows/
│   │   └── gate1.yml          # GitHub Actions CI（作成推奨）
│   └── pull_request_template.md  # PR契約テンプレート（既存）
├── docs/
│   ├── contract.md            # 命令の「4点セット」テンプレート（作成推奨）
│   └── GATE1_WORKFLOW.md      # このファイル
└── shared/
    └── version.ts             # バージョン番号管理（既存）
```

---

## 🚀 ワークフロー

### Phase 1: 変更の実装

1つの変更のみを実装（データベース / API / UI / 設定 / ドキュメント）

**例**: データベース層の変更
- SQLクエリを実装
- スキーマを更新

### Phase 2: テスト

変更した部分のテストを実施：

- **ユニットテスト**: 変更した関数・コンポーネントが正しく動作するか
- **統合テスト**: 既存の機能が壊れていないか
- **視覚的確認**: ブラウザで確認（http://localhost:8081）

### Phase 3: commit

変更をcommit：

```bash
git add .
git commit -m "v6.XXX: 変更内容の要約"
```

**コミットメッセージの形式**:
- `v6.XXX:` で始める（バージョン番号を含める）
- 変更内容を簡潔に説明

### Phase 4: バージョン番号を更新

`shared/version.ts`のバージョン番号を更新：

```typescript
export const APP_VERSION = "6.XXX";
```

**バージョン番号のルール**:
- マイナーバージョンを1つずつ増やす（例: 6.180 → 6.181）
- 1つの変更につき1バージョン

### Phase 5: diff-check

diff-checkを実行：

```bash
bash scripts/diff-check.sh
```

**警告が表示された場合の対応**:

| 警告 | 追加テスト |
|------|-----------|
| OAuth / 認証 | ログイン機能のテスト |
| Deploy / CI | Deploy後ヘルス照合 |
| Env | 環境変数の変更を確認 |
| DB | データベースのマイグレーションを確認 |
| Health | ヘルスチェックエンドポイントを確認 |
| Routing / Redirect / Proxy | リダイレクトのテストを実施 |

### Phase 6: 次のバージョンへ

todo.mdに次のバージョンのタスクを追加し、Phase 1に戻る。

---

## 📄 命令の「4点セット」テンプレート

新しい機能を実装する前に、`docs/contract.md`を作成し、以下の4点を明確化します：

### テンプレート（docs/contract.md）

```markdown
## Contract: [機能名]

### 1. 目的（Why）
<!-- なぜこの機能を実装するのか -->

### 2. やること（What）
<!-- 何を実装するのか -->
- [ ] タスク1
- [ ] タスク2
- [ ] タスク3

### 3. やってはいけないこと（NG）
<!-- 絶対に変更してはいけないファイル、機能 -->
- 認証関連ファイルを変更しない
- Deploy関連ファイルを変更しない
- 既存の機能を壊さない

### 4. Done条件（チェック可能）
<!-- どうなったら完了とみなすか -->
- [ ] diff-check.shを実行し、警告がない
- [ ] ローカル環境でテストし、動作を確認
- [ ] 影響範囲を把握し、関連する機能が壊れていないことを確認
- [ ] PRを作成し、Gate 1チェックリストを全てチェック
```

---

## 📊 実装例: 性別統計表示機能

### v6.174: データベース層

**変更**: 性別統計を集計するSQLクエリを実装

**テスト**: SQLクエリを実行して結果を確認

**commit**: 
```bash
git commit -m "v6.174: データベース層: 性別統計SQL実装"
```

**バージョン更新**: `shared/version.ts`を`6.174`に更新

**diff-check**: 
```bash
bash scripts/diff-check.sh
# ⚠️  DB に変更があります
# → データベースのマイグレーションを確認
```

---

### v6.175: API層

**変更**: `getAllEventsWithGenderStats()`関数を実装

**テスト**: APIを呼び出して結果を確認

**commit**: 
```bash
git commit -m "v6.175: API層: challenge-db.ts実装"
```

**バージョン更新**: `shared/version.ts`を`6.175`に更新

**diff-check**: 
```bash
bash scripts/diff-check.sh
# ✅ Gate 1: 危険な変更は検知されませんでした
```

---

### v6.176: UI層

**変更**: `ColorfulChallengeCard`に性別統計を表示

**テスト**: ブラウザで確認

**commit**: 
```bash
git commit -m "v6.176: UI層: GenderStatsコンポーネント統合"
```

**バージョン更新**: `shared/version.ts`を`6.176`に更新

**diff-check**: 
```bash
bash scripts/diff-check.sh
# ✅ Gate 1: 危険な変更は検知されませんでした
```

---

## 🎯 メリット

### 1. 問題の特定が容易

各バージョンが1つの小さな変更のみを含むため、問題が発生した場合、原因を特定しやすい。

**例**:
- v6.177でサムネイル画像が消えた → v6.177の変更（GenderStatsコンポーネント統合）が原因

### 2. ロールバックが安全

1つ前のバージョンに戻れば、確実に動作する状態に戻れる。

**例**:
- v6.177で問題が発生 → v6.176にロールバック → 問題が解決

### 3. 変更履歴が明確

各バージョンのcommitメッセージを見れば、何をいつ変更したかが一目瞭然。

**例**:
```
v6.174: データベース層: 性別統計SQL実装
v6.175: API層: challenge-db.ts実装
v6.176: API層: events.ts統合
v6.177: UI層: GenderStatsコンポーネント統合
```

### 4. diff-checkが効果的

小さな変更なので、影響範囲が明確。diff-checkの警告も理解しやすい。

### 5. Gate 1との統合

各バージョンでdiff-checkを実行することで、Gate 1のチェックポイントを通過。
危険な変更を早期に検知し、追加テストを実施できる。

---

## 📋 チェックリスト

### 導入時

- [x] `scripts/diff-check.sh`が存在する（既存）
- [ ] `.github/workflows/gate1.yml`を作成（推奨）
- [x] `.github/pull_request_template.md`が存在する（既存）
- [ ] `docs/contract.md`を作成（推奨）
- [x] `shared/version.ts`が存在する（既存）

### 各バージョンで

- [ ] 1つの変更のみを実装
- [ ] テストを実施（ユニットテスト + 統合テスト）
- [ ] commit（`v6.XXX:`形式で）
- [ ] バージョン番号を更新（`shared/version.ts`）
- [ ] diff-checkを実行
- [ ] 警告が表示された場合、追加テストを実施
- [ ] todo.mdに次のバージョンのタスクを追加

---

## 🔄 既存プロジェクトへの適用

このプロジェクトには既に以下のファイルが存在します：

- ✅ `scripts/diff-check.sh` - Gate 1の自動検知スクリプト
- ✅ `shared/version.ts` - バージョン番号管理
- ✅ `.github/pull_request_template.md` - PRテンプレート

**次のステップ**:

1. このワークフローをチームに周知
2. 各バージョンでこのワークフローを実行
3. `docs/contract.md`を作成して、新機能実装前に使用
4. GitHub Actions CIに`gate1.yml`を追加（推奨）

---

## 🎯 まとめ

**Gate 1 + こまめなバージョン管理** を統合することで、以下のメリットが得られる：

1. **問題の特定が容易**: 各バージョンが1つの小さな変更のみを含む
2. **ロールバックが安全**: 1つ前のバージョンに戻れば確実に動く
3. **変更履歴が明確**: 何をいつ変更したかが一目瞭然
4. **diff-checkが効果的**: 小さな変更なので影響範囲が明確
5. **Gate 1との統合**: 危険な変更を早期に検知し、追加テストを実施

「5歩進んだら7歩下がる」「どこか直したら他が壊れる」問題を根本的に解決できる。

---

## 関連ドキュメント

- [docs/DATA_DESIGN_PRINCIPLES.md](./DATA_DESIGN_PRINCIPLES.md) - データ構造から考える開発原則
- [docs/GIT_DEVELOPMENT_WORKFLOW.md](./GIT_DEVELOPMENT_WORKFLOW.md) - Git開発の基本作法
- [docs/LOCAL_DEVELOPMENT_WORKFLOW.md](./LOCAL_DEVELOPMENT_WORKFLOW.md) - ローカル開発ワークフロー
- [scripts/diff-check.sh](../scripts/diff-check.sh) - Gate 1の自動検知スクリプト
- [shared/version.ts](../shared/version.ts) - バージョン番号管理

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2026-02-02 | v1.0 | 初版作成 - Gate 1 + こまめなバージョン管理の統合ワークフローを確立 |

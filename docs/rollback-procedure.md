# ロールバック手順

## 概要

このドキュメントは、デプロイ後に問題が発生した場合に、迷わず前のバージョンに戻すための手順を明文化したものです。

## 目次

1. [いつロールバックすべきか](#いつロールバックすべきか)
2. [ロールバック手順](#ロールバック手順)
3. [環境変数・Secretsの確認](#環境変数secretsの確認)
4. [DBを触らずに戻す方法](#dbを触らずに戻す方法)
5. [ロールバック後の確認](#ロールバック後の確認)
6. [トラブルシューティング](#トラブルシューティング)

---

## いつロールバックすべきか

以下のいずれかに該当する場合、即座にロールバックを検討してください：

### 🚨 即座にロールバック（5分以内）

- **5xxエラーが急増**（1分間に10件以上）
- **ログイン失敗率が50%を超える**
- **DB接続エラーが連続**（3回以上）
- **主要フローが完全に停止**（参加表明、メッセージ投稿）

### ⚠️ 検討してロールバック（15分以内）

- **パフォーマンスが著しく低下**（LCPが5秒以上）
- **特定の機能が動作しない**（通知、リアルタイム更新）
- **UIが崩れている**（レイアウト崩れ、表示バグ）

### ✅ 様子見（30分以内）

- **軽微なUIの問題**（色が少し違う、文言の誤字）
- **一部のユーザーのみ影響**（特定ブラウザ、特定デバイス）
- **Feature Flagで無効化できる**（リアルタイム更新、プッシュ通知）

---

## ロールバック手順

### 方法1: Vercel Promote（推奨）

**所要時間: 2-3分**

1. **Vercelダッシュボードにアクセス**
   - https://vercel.com/dashboard
   - プロジェクト「birthday-celebration」を選択

2. **Deploymentsタブに移動**
   - 左サイドバーの「Deployments」をクリック

3. **前のデプロイメントを選択**
   - 最新のデプロイメント（現在のバージョン）の**1つ前**を選択
   - デプロイメントの詳細ページを開く

4. **Promote to Productionをクリック**
   - 右上の「⋯」メニューから「Promote to Production」を選択
   - 確認ダイアログで「Promote」をクリック

5. **デプロイ完了を待つ**
   - 通常30秒〜1分で完了
   - ステータスが「Ready」になるまで待つ

6. **動作確認**
   - 主要フローをテスト（ログイン、参加表明、メッセージ投稿）
   - `/api/healthz`と`/api/readyz`を確認

---

### 方法2: 前のコミットに戻す（Gitベース）

**所要時間: 5-10分**

1. **前のコミットを確認**
   ```bash
   cd /home/ubuntu/birthday-celebration
   git log --oneline -10
   ```

2. **前のコミットにリセット**
   ```bash
   git reset --hard <前のコミットハッシュ>
   git push -f origin main
   ```

3. **Vercelが自動デプロイ**
   - Vercelが自動的に再デプロイを開始
   - 通常1-2分で完了

4. **動作確認**
   - 主要フローをテスト
   - `/api/healthz`と`/api/readyz`を確認

---

### 方法3: Feature Flagで無効化（最速）

**所要時間: 1-2分**

リアルタイム更新・プッシュ通知・重い演出が原因の場合、Feature Flagで即座に無効化できます。

1. **Vercelダッシュボードにアクセス**
   - https://vercel.com/dashboard
   - プロジェクト「birthday-celebration」を選択

2. **Settings → Environment Variablesに移動**

3. **該当するFeature Flagを無効化**
   - `FEATURE_REALTIME_UPDATE=false`
   - `FEATURE_PUSH_NOTIFICATION=false`
   - `FEATURE_PARTICIPATION_ANIMATION=false`

4. **Redeployをクリック**
   - 環境変数を変更後、「Redeploy」をクリック
   - 通常30秒〜1分で完了

5. **動作確認**
   - `/admin/feature-flags`で状態を確認
   - 該当する機能が無効化されていることを確認

---

## 環境変数・Secretsの確認

ロールバック後、環境変数・Secretsが正しく設定されているか確認してください。

### 確認すべき環境変数

| 環境変数 | 説明 | 確認方法 |
|----------|------|----------|
| `DATABASE_URL` | データベース接続URL | `/api/readyz`で確認 |
| `SENTRY_DSN` | Sentry DSN | Sentryダッシュボードでエラーが記録されているか確認 |
| `SENTRY_ENVIRONMENT` | Sentry環境名 | Sentryダッシュボードで環境名を確認 |
| `FEATURE_*` | Feature Flags | `/admin/feature-flags`で確認 |

### 確認手順

1. **Vercelダッシュボードにアクセス**
   - https://vercel.com/dashboard
   - プロジェクト「birthday-celebration」を選択

2. **Settings → Environment Variablesに移動**

3. **各環境変数を確認**
   - Production環境に正しく設定されているか確認
   - 値が空欄になっていないか確認

4. **必要に応じて再設定**
   - 環境変数が消えている場合は再設定
   - 再設定後、「Redeploy」をクリック

---

## DBを触らずに戻す方法

**重要: ロールバック時はDBを触らない**

ロールバックは**コードのみ**を戻します。DBのスキーマやデータは変更しません。

### なぜDBを触らないのか

1. **データ損失のリスク**
   - DBをロールバックすると、ユーザーの参加表明やメッセージが消える
   - 復旧が困難

2. **スキーマの互換性**
   - 新しいスキーマは通常、古いコードと互換性がある
   - 古いコードは新しいスキーマを無視するだけ

3. **復旧の容易さ**
   - コードのみのロールバックは1-2分で完了
   - DBのロールバックは30分〜数時間かかる

### DBを触る必要がある場合

以下の場合のみ、DBの変更を検討してください：

- **スキーマ変更が原因で完全に動作しない**
- **データ整合性が完全に崩れている**
- **復旧が不可能**

この場合は、以下の手順で対応してください：

1. **DBのバックアップを取得**
   ```bash
   # MySQLの場合
   mysqldump -h <host> -u <user> -p <database> > backup.sql
   ```

2. **スキーマを前のバージョンに戻す**
   ```bash
   # Drizzle ORMの場合
   pnpm db:push
   ```

3. **データを復旧**
   - バックアップから復旧
   - 手動でデータを修正

---

## ロールバック後の確認

ロールバック後、以下を確認してください：

### 1. ヘルスチェック

```bash
# healthz（軽い）
curl https://your-domain.com/api/healthz

# readyz（重い）
curl https://your-domain.com/api/readyz
```

### 2. 主要フローのテスト

- [ ] ログイン
- [ ] 参加表明
- [ ] メッセージ投稿
- [ ] 応援メッセージの表示
- [ ] プロフィール編集

### 3. エラーログの確認

- [ ] Sentryでエラーが減少しているか確認
- [ ] Vercelのログで5xxエラーが減少しているか確認
- [ ] UptimeRobotで`/api/readyz`が正常に応答しているか確認

### 4. パフォーマンスの確認

- [ ] ページ読み込み速度が正常か確認
- [ ] LCPが3秒以内か確認
- [ ] リアルタイム更新が正常に動作しているか確認

---

## トラブルシューティング

### ロールバックしても問題が解決しない場合

1. **環境変数を確認**
   - Vercelの Environment Variables を確認
   - 必要な環境変数が設定されているか確認

2. **キャッシュをクリア**
   - ブラウザのキャッシュをクリア
   - Vercelのキャッシュをクリア（Redeploy）

3. **DBの状態を確認**
   - `/api/readyz`でDB接続を確認
   - 必要に応じてDBを再起動

4. **Feature Flagで無効化**
   - 問題の原因となっている機能をFeature Flagで無効化
   - リアルタイム更新、プッシュ通知、重い演出など

### ロールバックできない場合

1. **Vercelのステータスページを確認**
   - https://www.vercel-status.com/
   - Vercel自体に問題がないか確認

2. **GitHubのステータスページを確認**
   - https://www.githubstatus.com/
   - GitHub自体に問題がないか確認

3. **手動でデプロイ**
   - ローカルで前のバージョンをビルド
   - 手動でVercelにデプロイ

---

## まとめ

### ロールバックの優先順位

1. **Feature Flagで無効化**（1-2分）
2. **Vercel Promote**（2-3分）
3. **前のコミットに戻す**（5-10分）

### 重要なポイント

- **迷わず戻す**: 問題が発生したら即座にロールバック
- **DBは触らない**: コードのみをロールバック
- **環境変数を確認**: ロールバック後は必ず確認
- **動作確認**: 主要フローをテストして確認

### 連絡先

- **緊急時**: Sentryのアラート、UptimeRobotの通知
- **エスカレーション**: プロジェクトオーナーに連絡

# テストカバレッジレポート

このドキュメントでは、「君斗りんくの動員ちゃれんじ」アプリのテストカバレッジに関する情報をまとめています。

## 目次

1. [テスト成功率](#テスト成功率)
2. [テスト構成](#テスト構成)
3. [カバレッジ詳細](#カバレッジ詳細)
4. [失敗テストの詳細](#失敗テストの詳細)
5. [テスト実行方法](#テスト実行方法)

---

## テスト成功率

**最終更新: 2026-01-28**

- **総テスト数**: 683
- **成功テスト数**: 681
- **失敗テスト数**: 2
- **スキップテスト数**: 1
- **成功率**: **99.7%**

---

## テスト構成

### テストファイル数

- **総テストファイル数**: 53
- **成功ファイル数**: 49
- **失敗ファイル数**: 2
- **スキップファイル数**: 1

### テストカテゴリ

| カテゴリ | ファイル数 | テスト数 | 成功率 |
|---------|-----------|---------|--------|
| 統合テスト | 1 | 6 | 100% |
| フック | 15 | 150+ | 99.3% |
| コンポーネント | 20 | 300+ | 100% |
| ユーティリティ | 10 | 100+ | 100% |
| API | 7 | 100+ | 100% |

---

## カバレッジ詳細

### 主要機能のテストカバレッジ

#### 1. イベント管理

- ✅ イベント一覧取得（`events.list`）
- ✅ イベント詳細取得（`events.detail`）
- ✅ イベント作成（`events.create`）
- ✅ イベント更新（`events.update`）
- ✅ イベント削除（`events.delete`）

#### 2. 参加管理

- ✅ 参加表明（`participations.create`）
- ✅ 参加一覧取得（`participations.byChallenge`）
- ✅ 参加更新（`participations.update`）
- ✅ 参加削除（`participations.delete`）

#### 3. ユーザー管理

- ✅ ユーザー認証（`auth.login`）
- ✅ ユーザー情報取得（`users.me`）
- ✅ ユーザープロフィール更新（`users.update`）

#### 4. ランキング

- ✅ 主催者ランキング（`rankings.hosts`）
- ✅ 貢献度ランキング（`rankings.contribution`）

#### 5. 応援メッセージ

- ✅ メッセージ投稿（`messages.create`）
- ✅ メッセージ一覧取得（`messages.list`）
- ✅ いいね機能（`messages.like`）

---

## 失敗テストの詳細

### 1. use-offline-challenge.test.ts

**エラー内容:**
```
TypeError: Expected container to be an Element, a Document or a DocumentFragment but got undefined.
```

**原因:**
- Testing Libraryのコンテナ設定の問題
- `waitFor`関数がコンテナを見つけられない

**影響:**
- テスト環境のみの問題
- 実際のアプリ動作には影響なし

**対応状況:**
- コンテナ設定を追加済み
- Expo環境の複雑なモック設定が必要

### 2. useHomeData.loading.test.ts

**エラー内容:**
```
SyntaxError: Unexpected token 'typeof'
```

**原因:**
- Expo関連のモジュール読み込みエラー
- `__DEV__`変数の解決問題

**影響:**
- テスト環境のみの問題
- 実際のアプリ動作には影響なし

**対応状況:**
- ファイルを再作成済み
- Expoモックを追加済み
- 引き続き調査中

---

## テスト実行方法

### すべてのテストを実行

```bash
pnpm test
```

### 特定のテストファイルを実行

```bash
pnpm test <test-file-path>
```

例:
```bash
pnpm test __tests__/trpc-integration.test.ts
```

### ウォッチモードで実行

```bash
pnpm test --watch
```

### カバレッジレポートを生成

```bash
pnpm test --coverage
```

---

## テスト戦略

### 1. ユニットテスト

- **対象**: 個別の関数、フック、コンポーネント
- **ツール**: Vitest
- **カバレッジ目標**: 80%以上

### 2. 統合テスト

- **対象**: tRPCエンドポイント、API統合
- **ツール**: Vitest + fetch
- **カバレッジ目標**: 主要フローをカバー

### 3. E2Eテスト

- **対象**: ユーザーフロー全体
- **ツール**: Playwright（設定済み）
- **カバレッジ目標**: 主要なユーザーシナリオをカバー

---

## テストのベストプラクティス

### DO（推奨）

- ✅ テストは独立して実行可能にする
- ✅ モックは最小限に抑える
- ✅ テスト名は明確で具体的にする
- ✅ エッジケースをテストする
- ✅ テストは高速に実行できるようにする

### DON'T（非推奨）

- ❌ 実装の詳細をテストしない
- ❌ テスト間で状態を共有しない
- ❌ 過度にモックしない
- ❌ テストを複雑にしない
- ❌ テストを無視しない

---

## 今後の改善予定

### 短期（1-2週間）

- [ ] 失敗テスト2件の修正
- [ ] E2Eテストの追加（主要フロー）
- [ ] カバレッジレポートの自動生成

### 中期（1-2ヶ月）

- [ ] ビジュアルリグレッションテストの導入
- [ ] パフォーマンステストの追加
- [ ] CI/CDパイプラインでのテスト自動実行

### 長期（3ヶ月以上）

- [ ] テストカバレッジ90%以上を目指す
- [ ] テスト実行時間の短縮
- [ ] テストドキュメントの充実

---

## 参考資料

- [Vitest Documentation](https://vitest.dev/)
- [Testing Library](https://testing-library.com/)
- [Playwright](https://playwright.dev/)
- [tRPC Testing](https://trpc.io/docs/testing)

# アーキテクチャ設計書

**最終更新**: 2026年1月30日  
**対象読者**: AI・開発者

---

## 📋 目次

1. [システム概要](#システム概要)
2. [アーキテクチャ図](#アーキテクチャ図)
3. [技術スタック](#技術スタック)
4. [ディレクトリ構造](#ディレクトリ構造)
5. [データフロー](#データフロー)
6. [認証フロー](#認証フロー)
7. [データベース設計](#データベース設計)
8. [API設計](#api設計)
9. [デプロイ構成](#デプロイ構成)

---

## システム概要

**動員チャレンジ**は、以下の3層アーキテクチャで構成されています。

```
┌─────────────────────────────────────────────────────────────┐
│                        クライアント層                          │
│  (React Native + Expo: iOS/Android/Web)                    │
└─────────────────────────────────────────────────────────────┘
                            ↕ tRPC (型安全なAPI通信)
┌─────────────────────────────────────────────────────────────┐
│                        アプリケーション層                       │
│  (Node.js + Express + tRPC)                                │
└─────────────────────────────────────────────────────────────┘
                            ↕ Drizzle ORM
┌─────────────────────────────────────────────────────────────┐
│                        データ層                               │
│  (PostgreSQL on Railway)                                   │
└─────────────────────────────────────────────────────────────┘
```

---

## アーキテクチャ図

### 全体構成

```
┌──────────────┐
│   ユーザー    │
└──────┬───────┘
       │
       ↓
┌──────────────────────────────────────────────────────────┐
│                      Vercel (CDN)                        │
│  ┌────────────────────────────────────────────────────┐  │
│  │  Static Assets (HTML/CSS/JS/Images)                │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
       │
       ↓
┌──────────────────────────────────────────────────────────┐
│                   Railway (Backend)                      │
│  ┌────────────────────────────────────────────────────┐  │
│  │  Node.js + Express + tRPC                          │  │
│  │  ┌──────────────┐  ┌──────────────┐               │  │
│  │  │ Auth Router  │  │ Event Router │               │  │
│  │  └──────────────┘  └──────────────┘               │  │
│  │  ┌──────────────┐  ┌──────────────┐               │  │
│  │  │ User Router  │  │ Stats Router │               │  │
│  │  └──────────────┘  └──────────────┘               │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
       │
       ↓
┌──────────────────────────────────────────────────────────┐
│                Railway (PostgreSQL)                      │
│  ┌────────────────────────────────────────────────────┐  │
│  │  Database Tables                                   │  │
│  │  - users                                           │  │
│  │  - events                                          │  │
│  │  - participations                                  │  │
│  │  - messages                                        │  │
│  │  - pkce_data                                       │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
       │
       ↓
┌──────────────────────────────────────────────────────────┐
│                  Twitter OAuth 2.0 API                   │
└──────────────────────────────────────────────────────────┘
```

---

## 技術スタック

### フロントエンド

| 技術 | バージョン | 役割 |
|------|-----------|------|
| **React** | 19.1.0 | UIライブラリ |
| **React Native** | 0.81.5 | モバイルアプリケーションフレームワーク |
| **Expo** | ~54.0.29 | React Nativeの開発環境・ビルドツール |
| **Expo Router** | ~6.0.19 | ファイルベースルーティング |
| **NativeWind** | ^4.2.1 | Tailwind CSSのReact Native実装 |
| **TypeScript** | ~5.9.3 | 型安全性の確保 |
| **TanStack Query** | ^5.90.12 | サーバーステート管理・キャッシング |
| **tRPC Client** | 11.7.2 | 型安全なAPI通信 |

### バックエンド

| 技術 | バージョン | 役割 |
|------|-----------|------|
| **Node.js** | 24.x | サーバーランタイム |
| **Express** | ^4.22.1 | Webフレームワーク |
| **tRPC Server** | 11.7.2 | 型安全なAPIエンドポイント |
| **Drizzle ORM** | ^0.44.7 | データベースORM |
| **PostgreSQL** | 最新版 | リレーショナルデータベース |
| **Zod** | ^4.2.1 | スキーマバリデーション |
| **Jose** | 6.1.0 | JWT処理 |

### ビルド・デプロイ

| 技術 | 役割 |
|------|------|
| **pnpm** | パッケージマネージャー（9.12.0） |
| **esbuild** | サーバーサイドバンドラー |
| **Railway** | バックエンドホスティング |
| **Vercel** | フロントエンドホスティング |
| **GitHub Actions** | CI/CDパイプライン |

---

## ディレクトリ構造

```
birthday-celebration/
├── app/                      # Expo Routerアプリケーション
│   ├── (tabs)/              # タブナビゲーション画面
│   │   ├── _layout.tsx      # タブレイアウト
│   │   ├── index.tsx        # ホーム画面
│   │   ├── create.tsx       # イベント作成画面
│   │   ├── mypage.tsx       # マイページ
│   │   └── stats.tsx        # 統計画面
│   ├── event/               # イベント関連画面
│   │   └── [id].tsx         # イベント詳細画面
│   ├── oauth/               # OAuth認証コールバック
│   │   └── callback.tsx     # Twitter OAuth コールバック
│   └── _layout.tsx          # ルートレイアウト
│
├── components/              # 再利用可能なUIコンポーネント
│   ├── screen-container.tsx # SafeAreaラッパー
│   ├── ui/                  # UIコンポーネント
│   │   ├── icon-symbol.tsx  # アイコンコンポーネント
│   │   ├── button.tsx       # ボタンコンポーネント
│   │   └── modal.tsx        # モーダルコンポーネント
│   └── auth-ux/             # 認証UXコンポーネント
│
├── features/                # 機能別コンポーネント
│   ├── onboarding/          # オンボーディング
│   │   ├── components/      # オンボーディング専用コンポーネント
│   │   ├── hooks/           # オンボーディング専用フック
│   │   └── constants.ts     # オンボーディング定数
│   ├── mypage/              # マイページ
│   │   ├── components/      # マイページ専用コンポーネント
│   │   └── hooks/           # マイページ専用フック
│   ├── create/              # イベント作成
│   │   ├── components/      # イベント作成専用コンポーネント
│   │   └── hooks/           # イベント作成専用フック
│   └── event/               # イベント詳細
│       ├── components/      # イベント詳細専用コンポーネント
│       └── hooks/           # イベント詳細専用フック
│
├── hooks/                   # カスタムReactフック
│   ├── use-auth.ts          # 認証状態管理
│   ├── use-colors.ts        # テーマカラー管理
│   └── use-offline-cache.ts # オフラインキャッシュ
│
├── lib/                     # ユーティリティ・共通ロジック
│   ├── trpc.ts              # tRPCクライアント設定
│   ├── offline-cache.ts     # オフラインストレージ
│   └── utils.ts             # ユーティリティ関数
│
├── server/                  # バックエンドサーバー
│   ├── _core/               # サーバーコア
│   │   └── index.ts         # メインサーバーファイル
│   ├── routers/             # tRPCルーター
│   │   ├── auth.ts          # 認証ルーター
│   │   ├── event.ts         # イベントルーター
│   │   ├── user.ts          # ユーザールーター
│   │   └── stats.ts         # 統計ルーター
│   ├── db/                  # データベーススキーマ
│   │   └── schema.ts        # Drizzle ORMスキーマ定義
│   ├── twitter-oauth2.ts    # Twitter OAuth実装
│   └── twitter-auth.ts      # セッション管理
│
├── shared/                  # クライアント・サーバー共通型定義
│   ├── types.ts             # 共通型定義
│   └── version.ts           # バージョン情報
│
├── docs/                    # ドキュメント
│   ├── deployment-guide.md  # デプロイガイド
│   ├── development-guide.md # 開発環境セットアップガイド
│   ├── architecture.md      # アーキテクチャ設計書（このファイル）
│   ├── gate1.md             # 本番環境の品質基準
│   ├── visibility-issues.md # 視認性問題の修正履歴
│   └── chatlog-YYYYMMDD.md  # 作業ログ
│
├── scripts/                 # ビルド・デプロイスクリプト
│   ├── deploy-to-production.sh  # デプロイスクリプト
│   ├── check-diff.sh        # 差分チェックスクリプト
│   └── check-md-compliance.sh   # mdファイル準拠チェック
│
├── .github/                 # GitHub Actions
│   └── workflows/
│       ├── deploy-vercel.yml    # Vercelデプロイワークフロー
│       └── manual-deploy.yml    # 手動デプロイワークフロー
│
├── assets/                  # 静的アセット（画像・フォント）
│   └── images/              # 画像ファイル
│       ├── icon.png         # アプリアイコン
│       ├── splash-icon.png  # スプラッシュ画面アイコン
│       └── characters/      # キャラクター画像
│
├── package.json             # プロジェクト設定
├── app.config.ts            # Expo設定
├── tailwind.config.js       # Tailwind CSS設定
├── theme.config.js          # テーマカラー設定
├── vitest.config.ts         # Vitestテスト設定
└── todo.md                  # 未完了タスク一覧
```

---

## データフロー

### 1. ユーザーがイベントを作成する場合

```
┌──────────────┐
│   ユーザー    │
└──────┬───────┘
       │ 1. イベント作成フォーム入力
       ↓
┌──────────────────────────────────────┐
│  app/(tabs)/create.tsx               │
│  (イベント作成画面)                   │
└──────┬───────────────────────────────┘
       │ 2. trpc.event.create.mutate()
       ↓
┌──────────────────────────────────────┐
│  lib/trpc.ts                         │
│  (tRPCクライアント)                   │
└──────┬───────────────────────────────┘
       │ 3. HTTP POST /api/trpc/event.create
       ↓
┌──────────────────────────────────────┐
│  server/routers/event.ts             │
│  (イベントルーター)                   │
└──────┬───────────────────────────────┘
       │ 4. db.insert(events).values(...)
       ↓
┌──────────────────────────────────────┐
│  server/db/schema.ts                 │
│  (Drizzle ORM)                       │
└──────┬───────────────────────────────┘
       │ 5. INSERT INTO events ...
       ↓
┌──────────────────────────────────────┐
│  PostgreSQL (Railway)                │
└──────────────────────────────────────┘
```

### 2. ユーザーがイベント一覧を閲覧する場合

```
┌──────────────┐
│   ユーザー    │
└──────┬───────┘
       │ 1. ホーム画面を開く
       ↓
┌──────────────────────────────────────┐
│  app/(tabs)/index.tsx                │
│  (ホーム画面)                         │
└──────┬───────────────────────────────┘
       │ 2. trpc.event.list.useQuery()
       ↓
┌──────────────────────────────────────┐
│  lib/trpc.ts                         │
│  (tRPCクライアント)                   │
└──────┬───────────────────────────────┘
       │ 3. HTTP GET /api/trpc/event.list
       ↓
┌──────────────────────────────────────┐
│  server/routers/event.ts             │
│  (イベントルーター)                   │
└──────┬───────────────────────────────┘
       │ 4. db.select().from(events)
       ↓
┌──────────────────────────────────────┐
│  server/db/schema.ts                 │
│  (Drizzle ORM)                       │
└──────┬───────────────────────────────┘
       │ 5. SELECT * FROM events ...
       ↓
┌──────────────────────────────────────┐
│  PostgreSQL (Railway)                │
└──────────────────────────────────────┘
       │ 6. イベント一覧データ
       ↓
┌──────────────────────────────────────┐
│  app/(tabs)/index.tsx                │
│  (ホーム画面に表示)                   │
└──────────────────────────────────────┘
```

---

## 認証フロー

### Twitter OAuth 2.0 with PKCE

```
┌──────────────┐
│   ユーザー    │
└──────┬───────┘
       │ 1. ログインボタンをタップ
       ↓
┌──────────────────────────────────────┐
│  features/mypage/components/         │
│  login-screen/LoginScreen.tsx        │
└──────┬───────────────────────────────┘
       │ 2. trpc.auth.getAuthUrl.query()
       ↓
┌──────────────────────────────────────┐
│  server/routers/auth.ts              │
│  (認証ルーター)                       │
└──────┬───────────────────────────────┘
       │ 3. PKCE code_verifier生成
       │ 4. code_challenge生成
       │ 5. state生成
       │ 6. pkce_dataテーブルに保存
       ↓
┌──────────────────────────────────────┐
│  PostgreSQL (Railway)                │
│  pkce_data テーブル                   │
└──────────────────────────────────────┘
       │ 7. Twitter OAuth URLを返す
       ↓
┌──────────────────────────────────────┐
│  ユーザー                             │
│  (Twitterログイン画面に遷移)          │
└──────┬───────────────────────────────┘
       │ 8. Twitter認証完了
       ↓
┌──────────────────────────────────────┐
│  Twitter OAuth 2.0 API               │
└──────┬───────────────────────────────┘
       │ 9. コールバックURL + code + state
       ↓
┌──────────────────────────────────────┐
│  app/oauth/callback.tsx              │
│  (OAuth コールバック)                 │
└──────┬───────────────────────────────┘
       │ 10. trpc.auth.callback.mutate()
       ↓
┌──────────────────────────────────────┐
│  server/routers/auth.ts              │
│  (認証ルーター)                       │
└──────┬───────────────────────────────┘
       │ 11. stateを検証
       │ 12. pkce_dataテーブルから取得
       │ 13. code_verifierを使ってトークン取得
       ↓
┌──────────────────────────────────────┐
│  Twitter OAuth 2.0 API               │
│  (access_token取得)                  │
└──────┬───────────────────────────────┘
       │ 14. access_token
       ↓
┌──────────────────────────────────────┐
│  server/routers/auth.ts              │
│  (ユーザー情報取得)                   │
└──────┬───────────────────────────────┘
       │ 15. usersテーブルに保存
       │ 16. セッションCookie発行
       ↓
┌──────────────────────────────────────┐
│  ユーザー                             │
│  (ログイン完了)                       │
└──────────────────────────────────────┘
```

---

## データベース設計

### テーブル一覧

| テーブル名 | 説明 |
|-----------|------|
| `users` | ユーザー情報 |
| `events` | イベント情報 |
| `participations` | イベント参加情報 |
| `messages` | 応援メッセージ |
| `pkce_data` | PKCE認証データ（一時的） |

### テーブル定義

#### `users` テーブル

| カラム名 | 型 | 説明 |
|---------|---|------|
| `id` | TEXT | ユーザーID（Twitter User ID） |
| `username` | TEXT | Twitterユーザー名 |
| `display_name` | TEXT | 表示名 |
| `profile_image_url` | TEXT | プロフィール画像URL |
| `followers_count` | INTEGER | フォロワー数 |
| `created_at` | TIMESTAMP | 作成日時 |
| `updated_at` | TIMESTAMP | 更新日時 |

#### `events` テーブル

| カラム名 | 型 | 説明 |
|---------|---|------|
| `id` | TEXT | イベントID（UUID） |
| `title` | TEXT | イベントタイトル |
| `description` | TEXT | イベント説明 |
| `date` | TIMESTAMP | イベント日時 |
| `location` | TEXT | 開催場所 |
| `prefecture` | TEXT | 都道府県 |
| `creator_id` | TEXT | 作成者ID（users.id） |
| `created_at` | TIMESTAMP | 作成日時 |
| `updated_at` | TIMESTAMP | 更新日時 |

#### `participations` テーブル

| カラム名 | 型 | 説明 |
|---------|---|------|
| `id` | TEXT | 参加ID（UUID） |
| `event_id` | TEXT | イベントID（events.id） |
| `user_id` | TEXT | ユーザーID（users.id） |
| `prefecture` | TEXT | 参加者の都道府県 |
| `created_at` | TIMESTAMP | 参加日時 |

#### `messages` テーブル

| カラム名 | 型 | 説明 |
|---------|---|------|
| `id` | TEXT | メッセージID（UUID） |
| `event_id` | TEXT | イベントID（events.id） |
| `user_id` | TEXT | ユーザーID（users.id） |
| `content` | TEXT | メッセージ内容 |
| `created_at` | TIMESTAMP | 投稿日時 |

#### `pkce_data` テーブル

| カラム名 | 型 | 説明 |
|---------|---|------|
| `state` | TEXT | OAuth state（主キー） |
| `code_verifier` | TEXT | PKCE code_verifier |
| `created_at` | TIMESTAMP | 作成日時 |
| `expires_at` | TIMESTAMP | 有効期限（30分） |

---

## API設計

### tRPCルーター一覧

| ルーター名 | 説明 |
|-----------|------|
| `auth` | 認証関連API |
| `event` | イベント関連API |
| `user` | ユーザー関連API |
| `stats` | 統計関連API |

### `auth` ルーター

| プロシージャ名 | 型 | 説明 |
|--------------|---|------|
| `getAuthUrl` | query | Twitter OAuth URLを取得 |
| `callback` | mutation | OAuth コールバック処理 |
| `logout` | mutation | ログアウト |
| `me` | query | 現在のユーザー情報を取得 |

### `event` ルーター

| プロシージャ名 | 型 | 説明 |
|--------------|---|------|
| `list` | query | イベント一覧を取得 |
| `get` | query | イベント詳細を取得 |
| `create` | mutation | イベントを作成 |
| `update` | mutation | イベントを更新 |
| `delete` | mutation | イベントを削除 |

### `user` ルーター

| プロシージャ名 | 型 | 説明 |
|--------------|---|------|
| `get` | query | ユーザー情報を取得 |
| `update` | mutation | ユーザー情報を更新 |

### `stats` ルーター

| プロシージャ名 | 型 | 説明 |
|--------------|---|------|
| `userStats` | query | ユーザー統計を取得 |
| `adminStats` | query | 管理者統計を取得 |

---

## デプロイ構成

### 本番環境

| コンポーネント | プラットフォーム | URL |
|--------------|----------------|-----|
| **フロントエンド** | Vercel | https://doin-challenge.com |
| **バックエンド** | Railway | https://doin-challenge.com/api |
| **データベース** | Railway | PostgreSQL |

### CI/CDパイプライン

```
┌──────────────┐
│   開発者      │
└──────┬───────┘
       │ 1. git push
       ↓
┌──────────────────────────────────────┐
│  GitHub (main branch)                │
└──────┬───────────────────────────────┘
       │ 2. Trigger GitHub Actions
       ↓
┌──────────────────────────────────────┐
│  GitHub Actions                      │
│  (.github/workflows/deploy-vercel.yml)│
└──────┬───────────────────────────────┘
       │ 3. diff-check
       │ 4. md-compliance-check
       │ 5. TypeScript型チェック
       │ 6. ビルド
       ↓
┌──────────────────────────────────────┐
│  Vercel                              │
│  (自動デプロイ)                       │
└──────┬───────────────────────────────┘
       │ 7. デプロイ完了
       ↓
┌──────────────────────────────────────┐
│  本番環境                             │
│  https://doin-challenge.com          │
└──────────────────────────────────────┘
```

詳細は `deployment-guide.md` を参照してください。

---

## セキュリティ

### 認証・認可

- **Twitter OAuth 2.0 with PKCE**: 安全なOAuth認証
- **セッションCookie**: HttpOnly, Secure, SameSite=Lax
- **CSRF対策**: state パラメータによる検証

### データベース

- **SSL接続**: PostgreSQLへの接続はSSL必須
- **環境変数**: 機密情報は環境変数で管理

### API

- **tRPC**: 型安全なAPI通信
- **Zod**: スキーマバリデーション

---

## パフォーマンス

### キャッシング

- **TanStack Query**: サーバーステートのキャッシング
- **AsyncStorage**: オフラインキャッシュ

### 最適化

- **esbuild**: 高速なサーバーサイドバンドル
- **React Native Reanimated**: 高速なアニメーション

---

## 監視・ロギング

### 監視

- **UptimeRobot**: `/api/health` を5分間隔で監視
- **Sentry**: エラー通知（3種類に絞る）
  1. ログイン失敗の急増
  2. 5xxエラーの急増
  3. "unknown version" 検知

### ロギング

- **サーバーログ**: Railway Dashboard
- **クライアントログ**: Sentry

---

## 次のステップ

- **開発環境のセットアップ**: `docs/development-guide.md` を参照
- **デプロイ方法**: `docs/deployment-guide.md` を参照
- **品質基準**: `docs/gate1.md` を参照

# GPT相談：ワークフロー成功時点への復帰と機能保持の両立

**作成日**: 2026年1月23日  
**緊急度**: 高  
**目的**: GitHub Actionsワークフローが成功していた状態に戻しつつ、その後に実装した機能を無駄にしない方法を相談

---

## 1. 現状の問題

### 1.1 ワークフローの状態

| コミット | バージョン | ワークフロー結果 | 内容 |
|----------|-----------|-----------------|------|
| `ec61e7e` | v6.62 | ✅ **成功** | スクロールローディング機能改善 |
| `0a9fd21` | v6.64 | ❌ 失敗 | 売れる構造の強化 |
| `eb63018` | v6.65 | ❌ 失敗 | アクセシビリティ修正 |

### 1.2 失敗の原因

E2Eテスト（Playwright）が失敗している。具体的には：

```
Profile /profile/[userId] テストが「読み込み中...」のまま止まる
```

**原因の詳細:**
- `profiles.get` APIが `userId=1` でも `userId=2` でも `null` を返す
- 本番DBにテスト用ユーザーが存在しない可能性
- テストコードが「プロフィールが見つかりません」という表示を期待していない

### 1.3 v6.64で追加した機能（17ファイル、1936行）

| ファイル | 変更内容 |
|----------|---------|
| `challenge-created-modal.tsx` | 主催者チェックリストの視認性向上 |
| `role-selection-modal.tsx` | **新規** Welcome画面（ファン/主催者選択） |
| `share-prompt-modal.tsx` | 参加完了モーダル演出（県点灯、達成率表示） |
| `twitter-user-card.tsx` | lightBackground variant追加 |
| `EventHeaderSection.tsx` | 黒ベース＋白バッジ化 |
| `MessageCard.tsx` | 性別ボーダー導入 |
| `login-success-context.tsx` | 初回ログイン判定 |

これらは**仕様確定メモに基づいた重要な機能**であり、無駄にしたくない。

---

## 2. 根本的な問題

> **「一度ワークフローが通ったのに、通さなくしたのはAIのヒューマンエラーみたいなもの」**

これが根本です。具体的には：

1. **E2Eテストの前提条件が変わった**
   - v6.62時点では `userId=1` でプロフィールが取得できた（または別のテスト条件だった）
   - v6.64で何かが変わり、テストが失敗するようになった

2. **テストコードと本番環境の不整合**
   - テストは `userId=1` を使用
   - 本番DBにそのユーザーが存在しない

3. **変更の影響範囲が把握できていなかった**
   - UIコンポーネントの変更がE2Eテストに影響することを予測できなかった

---

## 3. 相談したい選択肢

### 選択肢A: git revertで戻してから再実装

```bash
# v6.62に戻す
git revert 0a9fd21 --no-commit
git revert eb63018 --no-commit
git commit -m "Revert to v6.62 for workflow stability"

# その後、機能を1つずつ再実装
```

**メリット:**
- ワークフローが確実に通る状態に戻る
- 1つずつ追加することで、どの変更が問題かを特定できる

**デメリット:**
- 時間がかかる
- 同じ作業を繰り返すことになる

---

### 選択肢B: E2Eテストを修正してワークフローを通す

```typescript
// tests/e2e/public.smoke.spec.ts
test("Profile /profile/[userId]", async ({ page }, testInfo) => {
  const assertNoErrors = await attachGuards(page, testInfo);
  await gotoAndWait(page, `/profile/${USER_ID}`);
  
  // 修正: プロフィールが見つからない場合も許容
  await expectAnyHeading(page, [
    /フォロー/i, /プロフィール/i, /応援/i, /参加/i,
    /見つかりません/i,  // 追加
    /読み込み中/i,      // 追加（タイムアウト対策）
  ]);
  
  await assertNoErrors();
});
```

**メリット:**
- 既存の機能をそのまま保持できる
- 最小限の変更で済む

**デメリット:**
- テストの意味が薄れる（本当に動作しているか確認できない）
- 根本的な問題（DBにユーザーがいない）を解決していない

---

### 選択肢C: テスト用のシードデータを本番DBに追加

```sql
-- 本番DBにテスト用ユーザーを追加
INSERT INTO users (id, name, createdAt) VALUES (1, 'Test User', NOW());
```

**メリット:**
- テストが正しく動作する
- 本番環境でもプロフィールページが動作することを確認できる

**デメリット:**
- 本番DBを変更するリスク
- テスト用データが本番に混在する

---

### 選択肢D: E2Eテストを本番ではなくプレビュー環境に向ける

```yaml
# .github/workflows/deploy.yml
e2e:
  env:
    # 本番URLではなく、Vercelのプレビュー環境を使用
    PLAYWRIGHT_BASE_URL: ${{ needs.frontend.outputs.deployment_url }}
```

**メリット:**
- 本番環境に影響を与えない
- プレビュー環境でテストが通れば、本番も動作するはず

**デメリット:**
- プレビュー環境と本番環境でDBが異なる場合、問題が残る
- 現在の設定でも `deployment_url` を使用しているはずだが、なぜ失敗しているか不明

---

## 4. 質問

1. **最も安全で効率的な方法はどれか？**
   - 選択肢A〜Dのどれが最適か
   - または別のアプローチがあるか

2. **E2Eテストの設計について**
   - 本番DBに依存するテストは適切か？
   - テスト用のモックデータを使うべきか？

3. **「AIのヒューマンエラー」を防ぐには？**
   - 変更前にE2Eテストをローカルで実行すべきか？
   - CIでの検証を強化すべきか？

4. **機能を保持しながら安定性を確保する方法**
   - feature branchを使うべきか？
   - 段階的にマージすべきか？

---

## 5. 技術情報

### 5.1 現在のワークフロー構成

```
push → preflight → CI (lint/typecheck/test) → Backend Deploy → Frontend Deploy → E2E
```

E2Eは最後に実行され、失敗するとワークフロー全体が失敗扱いになる。

### 5.2 E2Eテストの設定

```typescript
// playwright.config.ts
const baseURL = process.env.PLAYWRIGHT_BASE_URL ?? "https://doin-challenge.com";
```

環境変数が設定されていない場合、本番URLにフォールバックする。

### 5.3 テストで使用しているID

```typescript
// tests/e2e/public.smoke.spec.ts
const EVENT_ID = process.env.SMOKE_EVENT_ID ?? "90001";
const USER_ID = process.env.SMOKE_USER_ID ?? "1";
```

これらのIDが本番DBに存在しない可能性がある。

---

## 6. 期待する回答

1. **即時解決策**: 今すぐワークフローを通すための具体的な手順
2. **機能保持の方法**: v6.64の機能を無駄にしない方法
3. **再発防止策**: 同様の問題を防ぐためのベストプラクティス
4. **テスト戦略**: E2Eテストの設計に関するアドバイス

---

## 7. 補足：v6.64で実装した仕様確定メモの内容

### 全体カラー方針
- ベースカラーを黒に変更（`#0a0a0a`）
- 黄色を完全に廃止（全てピンクに置換）
- アクセント色をピンク・紫・ティールのみに限定

### UI/UX改善
- 応援コメントカードに性別ボーダー導入
- イベント詳細ヘッダーを黒ベース＋白バッジ化
- Welcome画面（RoleSelectionModal）追加
- 主催者チェックリストの視認性向上
- 参加完了モーダル演出（県点灯、達成率表示）

これらは全て**ユーザーと合意した仕様**であり、無駄にしたくない。

---

*このドキュメントは2026年1月23日時点の状態を反映しています。*

# デプロイ後の確認手順

このドキュメントでは、「君斗りんくの動員ちゃれんじ」アプリをデプロイした後に実施すべき確認手順をまとめています。

## 目次

1. [デプロイ直後の確認](#デプロイ直後の確認)
2. [機能テスト](#機能テスト)
3. [パフォーマンステスト](#パフォーマンステスト)
4. [監視設定の確認](#監視設定の確認)
5. [ロールバック手順](#ロールバック手順)

---

## デプロイ直後の確認

### 1. デプロイ反映確認

```bash
# /api/healthエンドポイントでcommitShaを確認
curl https://doin-challenge.com/api/health | jq '.commitSha'

# GitHub Actionsのログで期待されるcommitShaと一致するか確認
```

**期待される結果:**
- `/api/health`のcommitShaがGitHub Actionsのcommit SHAと一致する

### 2. ヘルスチェック

```bash
# 基本的なヘルスチェック
curl https://doin-challenge.com/api/health

# クリティカルAPIのヘルスチェック
curl https://doin-challenge.com/api/health?critical=true
```

**期待される結果:**
```json
{
  "ok": true,
  "db": {
    "connected": true
  },
  "critical": {
    "homeEvents": { "ok": true },
    "rankings": { "ok": true }
  }
}
```

### 3. データベース接続確認

```bash
# データベース接続テスト
curl https://doin-challenge.com/api/trpc/events.list
```

**期待される結果:**
- ステータスコード: 200
- レスポンスにイベントデータが含まれる

---

## 機能テスト

### 1. 主要フローのテスト

#### ホーム画面

- [ ] ホーム画面が正しく表示される
- [ ] チャレンジカードが表示される
- [ ] カテゴリフィルターが動作する
- [ ] 検索機能が動作する

#### イベント詳細

- [ ] イベント詳細画面が表示される
- [ ] 参加表明ボタンが表示される
- [ ] 応援メッセージが表示される
- [ ] シェア機能が動作する

#### 参加表明

- [ ] 参加表明フォームが表示される
- [ ] フォーム送信が成功する
- [ ] 参加完了演出が表示される
- [ ] 参加者数が更新される

#### ランキング

- [ ] 主催者ランキングが表示される
- [ ] 貢献度ランキングが表示される
- [ ] ランキングデータが正しい

#### マイページ

- [ ] マイページが表示される
- [ ] プロフィール編集が動作する
- [ ] 参加履歴が表示される

### 2. 認証フロー

- [ ] ログインが成功する
- [ ] ログアウトが成功する
- [ ] セッションが維持される
- [ ] 認証エラーが適切に処理される

### 3. エラーハンドリング

- [ ] ネットワークエラーが適切に表示される
- [ ] APIエラーが適切に処理される
- [ ] 404ページが表示される
- [ ] 500エラーが適切に処理される

---

## パフォーマンステスト

### 1. ページ読み込み速度

```bash
# Lighthouseでパフォーマンスを測定
npx lighthouse https://doin-challenge.com --view
```

**目標値:**
- Performance: 90以上
- Accessibility: 90以上
- Best Practices: 90以上
- SEO: 90以上

### 2. Core Web Vitals

| 指標 | 目標値 | 測定方法 |
|------|--------|---------|
| LCP (Largest Contentful Paint) | < 2.5s | Chrome DevTools |
| FID (First Input Delay) | < 100ms | Chrome DevTools |
| CLS (Cumulative Layout Shift) | < 0.1 | Chrome DevTools |

### 3. API レスポンス時間

```bash
# 主要APIのレスポンス時間を測定
time curl -s https://doin-challenge.com/api/trpc/events.list > /dev/null
```

**目標値:**
- 平均レスポンス時間: < 500ms
- 95パーセンタイル: < 1000ms

---

## 監視設定の確認

### 1. UptimeRobot

- [ ] `/api/readyz`の監視が設定されている
- [ ] 監視間隔: 5分
- [ ] タイムアウト: 30秒
- [ ] アラート通知先が設定されている

**確認方法:**
1. UptimeRobotダッシュボードにログイン
2. モニター一覧で「doin-challenge /api/readyz」を確認
3. ステータスが「Up」であることを確認

### 2. Sentry

- [ ] Sentryプロジェクトが設定されている
- [ ] エラーが正しく送信される
- [ ] アラート設定が有効になっている

**確認方法:**
1. Sentryダッシュボードにログイン
2. プロジェクト「doin-challenge」を確認
3. 最近のエラーがないことを確認

### 3. GitHub Actions

- [ ] デプロイワークフローが成功している
- [ ] CIワークフローが成功している
- [ ] デプロイ反映確認が成功している

**確認方法:**
1. GitHubリポジトリの「Actions」タブを開く
2. 最新のワークフロー実行を確認
3. すべてのステップが緑色（成功）であることを確認

---

## ロールバック手順

### 1. 問題の検知

以下のいずれかの問題が発生した場合、ロールバックを検討します：

- [ ] ヘルスチェックが失敗する
- [ ] 主要機能が動作しない
- [ ] パフォーマンスが著しく低下する
- [ ] データベース接続エラーが発生する
- [ ] Sentryで大量のエラーが報告される

### 2. ロールバック実行

#### 方法1: Vercelダッシュボード

1. Vercelダッシュボードにログイン
2. プロジェクト「doin-challenge」を選択
3. 「Deployments」タブを開く
4. 前回の安定版デプロイを選択
5. 「Promote to Production」をクリック

#### 方法2: GitHub Actions

1. GitHubリポジトリの「Actions」タブを開く
2. 「Deploy to Vercel」ワークフローを選択
3. 前回の安定版コミットで「Re-run jobs」をクリック

### 3. ロールバック後の確認

- [ ] デプロイ反映確認（commitShaが前回の安定版と一致）
- [ ] ヘルスチェックが成功する
- [ ] 主要機能が動作する
- [ ] UptimeRobotのステータスが「Up」になる
- [ ] Sentryのエラー数が正常範囲に戻る

---

## チェックリスト

デプロイ後は、以下のチェックリストを順番に実施してください。

### デプロイ直後（5分以内）

- [ ] デプロイ反映確認（commitSha）
- [ ] ヘルスチェック（/api/health）
- [ ] データベース接続確認
- [ ] ホーム画面の表示確認

### 初期確認（15分以内）

- [ ] 主要フローのテスト（ホーム、詳細、参加表明）
- [ ] 認証フローのテスト
- [ ] エラーハンドリングの確認
- [ ] UptimeRobotのステータス確認

### 詳細確認（30分以内）

- [ ] パフォーマンステスト（Lighthouse）
- [ ] Core Web Vitalsの測定
- [ ] APIレスポンス時間の測定
- [ ] Sentryのエラー確認

### 監視設定（1時間以内）

- [ ] UptimeRobotの設定確認
- [ ] Sentryの設定確認
- [ ] GitHub Actionsの設定確認
- [ ] アラート通知のテスト

---

## トラブルシューティング

### 問題: デプロイ反映が確認できない

**原因:**
- GitHub Actionsのワークフローが失敗している
- Vercelのビルドが失敗している

**対処法:**
1. GitHub Actionsのログを確認
2. Vercelのビルドログを確認
3. エラーメッセージを確認して修正
4. 再デプロイを実行

### 問題: ヘルスチェックが失敗する

**原因:**
- データベース接続エラー
- 環境変数の設定ミス
- サーバーの起動失敗

**対処法:**
1. Vercelのログを確認
2. 環境変数の設定を確認
3. データベース接続情報を確認
4. ロールバックを検討

### 問題: パフォーマンスが低下する

**原因:**
- バンドルサイズの増加
- 不適切な最適化
- データベースクエリの遅延

**対処法:**
1. Lighthouseでパフォーマンスを測定
2. バンドルサイズを確認
3. データベースクエリを最適化
4. キャッシュ設定を確認

---

## 参考資料

- [GATE1-SETUP.md](./GATE1-SETUP.md) - Gate 1セットアップガイド
- [DEPLOY.md](./DEPLOY.md) - デプロイ手順
- [UPTIMEROBOT-SETUP.md](./UPTIMEROBOT-SETUP.md) - UptimeRobot設定ガイド
- [SENTRY-SETUP.md](./SENTRY-SETUP.md) - Sentry設定ガイド

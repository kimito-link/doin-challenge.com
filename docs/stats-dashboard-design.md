# 統計ダッシュボード 設計ドキュメント

このドキュメントは、ユーザーのアクティビティ履歴と達成率を可視化する統計ダッシュボードの設計をまとめたものです。

## 目的

- ユーザーのアクティビティ履歴を可視化
- 達成率を表示してエンゲージメントを向上
- 管理者が全体の統計を確認できるようにする

---

## 画面構成

### 1. ユーザー統計ページ (`/stats`)

ログインユーザー自身の統計情報を表示します。

#### 表示内容

| セクション | 内容 |
|-----------|------|
| 概要カード | 総チャレンジ数、達成数、達成率 |
| 最近のアクティビティ | 直近10件のチャレンジ履歴（日時、チャレンジ名、ステータス） |
| 月別達成グラフ | 過去6ヶ月の月別達成数を棒グラフで表示 |
| 週別アクティビティ | 過去4週間の週別アクティビティをヒートマップで表示 |

#### UIコンポーネント

```
┌─────────────────────────────────────────────┐
│ 統計ダッシュボード                            │
├─────────────────────────────────────────────┤
│ ┌─────────┐ ┌─────────┐ ┌─────────┐        │
│ │総チャレン│ │達成数   │ │達成率   │        │
│ │ジ数     │ │         │ │         │        │
│ │  42     │ │  35     │ │  83%    │        │
│ └─────────┘ └─────────┘ └─────────┘        │
├─────────────────────────────────────────────┤
│ 最近のアクティビティ                          │
│ ┌─────────────────────────────────────────┐ │
│ │ 2026-01-29 12:00 | チャレンジA | 達成  │ │
│ │ 2026-01-28 15:30 | チャレンジB | 達成  │ │
│ │ 2026-01-27 10:15 | チャレンジC | 未達成│ │
│ └─────────────────────────────────────────┘ │
├─────────────────────────────────────────────┤
│ 月別達成グラフ                                │
│ ┌─────────────────────────────────────────┐ │
│ │ ▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇│ │
│ │ 8月  9月  10月  11月  12月  1月         │ │
│ └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
```

### 2. 管理者統計ページ (`/admin/stats`)

管理者が全体の統計情報を確認できるページです。

#### 表示内容

| セクション | 内容 |
|-----------|------|
| 全体概要 | 総ユーザー数、総チャレンジ数、平均達成率 |
| ユーザーランキング | 達成数トップ10のユーザー |
| チャレンジ統計 | チャレンジごとの達成率 |
| 日別アクティビティ | 過去30日間の日別アクティビティを折れ線グラフで表示 |

---

## データベース設計

### 既存テーブル

#### `users`

| カラム | 型 | 説明 |
|--------|-----|------|
| id | TEXT | ユーザーID（主キー） |
| name | TEXT | ユーザー名 |
| email | TEXT | メールアドレス |
| image | TEXT | プロフィール画像URL |
| createdAt | TIMESTAMP | 作成日時 |

#### `challenges`

| カラム | 型 | 説明 |
|--------|-----|------|
| id | TEXT | チャレンジID（主キー） |
| userId | TEXT | ユーザーID（外部キー） |
| challengeType | TEXT | チャレンジタイプ |
| targetDate | DATE | 目標日 |
| status | TEXT | ステータス（pending/completed/failed） |
| createdAt | TIMESTAMP | 作成日時 |
| completedAt | TIMESTAMP | 達成日時 |

### 新規テーブル（不要）

既存のテーブルで十分なため、新規テーブルは作成しません。

---

## API設計

### 1. ユーザー統計API

#### `GET /api/stats/user`

ログインユーザーの統計情報を取得します。

**レスポンス例:**

```json
{
  "summary": {
    "totalChallenges": 42,
    "completedChallenges": 35,
    "completionRate": 83.33
  },
  "recentActivity": [
    {
      "id": "challenge-1",
      "challengeType": "チャレンジA",
      "status": "completed",
      "completedAt": "2026-01-29T12:00:00Z"
    }
  ],
  "monthlyStats": [
    { "month": "2025-08", "count": 5 },
    { "month": "2025-09", "count": 7 },
    { "month": "2025-10", "count": 6 },
    { "month": "2025-11", "count": 8 },
    { "month": "2025-12", "count": 4 },
    { "month": "2026-01", "count": 5 }
  ],
  "weeklyActivity": [
    { "week": "2025-W52", "count": 3 },
    { "week": "2026-W01", "count": 5 },
    { "week": "2026-W02", "count": 4 },
    { "week": "2026-W03", "count": 6 }
  ]
}
```

### 2. 管理者統計API

#### `GET /api/stats/admin`

管理者用の全体統計情報を取得します。

**レスポンス例:**

```json
{
  "summary": {
    "totalUsers": 150,
    "totalChallenges": 6300,
    "averageCompletionRate": 78.5
  },
  "topUsers": [
    {
      "userId": "user-1",
      "name": "ユーザーA",
      "completedChallenges": 120
    }
  ],
  "challengeStats": [
    {
      "challengeType": "チャレンジA",
      "totalAttempts": 500,
      "completedAttempts": 400,
      "completionRate": 80.0
    }
  ],
  "dailyActivity": [
    { "date": "2026-01-01", "count": 45 },
    { "date": "2026-01-02", "count": 52 }
  ]
}
```

---

## UIコンポーネント設計

### 1. StatsCard

統計情報を表示するカードコンポーネント。

**Props:**

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| title | string | カードのタイトル |
| value | number \| string | 表示する値 |
| icon | ReactNode | アイコン |
| description | string | 説明文 |

### 2. ActivityList

最近のアクティビティを表示するリストコンポーネント。

**Props:**

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| activities | Activity[] | アクティビティの配列 |

### 3. MonthlyChart

月別達成グラフを表示するコンポーネント。

**Props:**

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| data | MonthlyData[] | 月別データの配列 |

### 4. WeeklyHeatmap

週別アクティビティをヒートマップで表示するコンポーネント。

**Props:**

| プロパティ | 型 | 説明 |
|-----------|-----|------|
| data | WeeklyData[] | 週別データの配列 |

---

## 実装の優先順位

### Phase 1: 基本機能（必須）

1. ✅ 設計ドキュメント作成
2. ⬜ ユーザー統計API実装
3. ⬜ ユーザー統計ページUI実装

### Phase 2: 拡張機能（オプション）

1. ⬜ 管理者統計API実装
2. ⬜ 管理者統計ページUI実装
3. ⬜ グラフ・チャートの実装

---

## 技術スタック

| 技術 | 用途 |
|------|------|
| Next.js | フロントエンド・バックエンド |
| tRPC | API通信 |
| Drizzle ORM | データベースアクセス |
| Recharts | グラフ・チャート |
| Tailwind CSS | スタイリング |

---

## 次のステップ

1. ✅ 統計ダッシュボードの設計完了
2. ⬜ 統計ダッシュボードのAPI実装
3. ⬜ 統計ダッシュボードのUI実装

---

## 参考リンク

- [Recharts公式ドキュメント](https://recharts.org/)
- [tRPC公式ドキュメント](https://trpc.io/)
- [Drizzle ORM公式ドキュメント](https://orm.drizzle.team/)

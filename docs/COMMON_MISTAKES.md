# AIが起こしがちなミス集（プロジェクト専用）

**最終更新**: 2026-01-31

このドキュメントは、**君斗りんくの動員ちゃれんじ（birthday-celebration）プロジェクト**において、AIが起こしがちなミスと防止策をまとめたものです。

---

## 目次

1. [UI/UXのミス](#uiuxのミス)
2. [プログラムのミス](#プログラムのミス)
3. [データベースのミス](#データベースのミス)
4. [パフォーマンスのミス](#パフォーマンスのミス)
5. [セキュリティのミス](#セキュリティのミス)

---

## UI/UXのミス

### 1. ログインUIの重複実装

**問題**:
- 同じログイン機能を複数の場所で実装してしまう
- 例: カスタムログインモーダルと青いバナーの2つのログインUIが存在

**防止策**:
- **必ず `components/common/LoginModal.tsx` を使用**
- 新しいログインボタンを作成する前に、`COMPONENT_REGISTRY.md`を確認
- `DESIGN_PRINCIPLES.md`の「ログインUIは1種類のみ」を厳守

**チェックリスト**:
- [ ] `components/common/LoginModal.tsx`を使用しているか？
- [ ] 新しいログインUIを作成していないか？
- [ ] `COMPONENT_REGISTRY.md`を確認したか？

---

### 2. グラデーション背景上のテキストコントラスト比が低い

**問題**:
- ピンク/紫のグラデーション背景に黒いテキストを表示してしまう
- WCAG 2.1 AA基準（コントラスト比4.5:1以上）を満たさない

**防止策**:
- **グラデーション背景上では、必ず白色テキスト（`color.textWhite`）を使用**
- `TwitterUserCard`に`onGradient` propsを追加し、テキスト色を動的に変更

**チェックリスト**:
- [ ] グラデーション背景上のテキスト色は白色か？
- [ ] WCAG 2.1 AA基準を満たしているか？
- [ ] `onGradient` propsを使用しているか？

---

### 3. サムネイル画像が表示されない

**問題**:
- `hostProfileImage`が空文字列（`""`）の場合、画像の読み込みエラー（401エラー）が発生
- フォールバックテキスト（ホスト名の最初の文字）が表示されない

**防止策**:
- **空文字列の場合は`undefined`を渡す**
- `LazyAvatar`コンポーネントで、`source`が空文字列の場合は`undefined`に変換

**チェックリスト**:
- [ ] `hostProfileImage`が空文字列の場合、`undefined`を渡しているか？
- [ ] `LazyAvatar`コンポーネントでフォールバックが正しく表示されるか？

---

## プログラムのミス

### 1. TypeScript型エラー: プロパティが存在しない

**問題**:
- `checkingFollowStatus`プロパティが存在しない
- `myStats`プロパティが存在しない（正しくは`stats`）
- `followersCount`プロパティが存在しない

**防止策**:
- **tRPCルーターの型定義を確認**
- `server/routers/`内のプロシージャ定義を確認
- TypeScriptエラーを無視せず、必ず修正

**チェックリスト**:
- [ ] tRPCルーターの型定義を確認したか？
- [ ] プロシージャ名が正しいか？
- [ ] TypeScriptエラーを修正したか？

---

### 2. 非同期処理のエラーハンドリング不足

**問題**:
- `async/await`を使用しているが、エラーハンドリングがない
- ネットワークエラーやタイムアウトが発生したとき、アプリがクラッシュする

**防止策**:
- **必ず`try/catch`を使用**
- エラーメッセージをユーザーに表示
- Sentryにエラーを送信

**チェックリスト**:
- [ ] `try/catch`を使用しているか？
- [ ] エラーメッセージをユーザーに表示しているか？
- [ ] Sentryにエラーを送信しているか？

---

### 3. 状態管理の不整合

**問題**:
- `AsyncStorage`に保存した状態と、メモリ上の状態が一致しない
- ログアウト後も、古い状態が残っている

**防止策**:
- **状態を更新したら、必ず`AsyncStorage`に保存**
- ログアウト時は、`AsyncStorage`をクリア
- `useEffect`で初期化時に`AsyncStorage`から読み込む

**チェックリスト**:
- [ ] 状態を更新したら、`AsyncStorage`に保存しているか？
- [ ] ログアウト時に`AsyncStorage`をクリアしているか？
- [ ] 初期化時に`AsyncStorage`から読み込んでいるか？

---

### 4. React Nativeのワークレットエラー

**問題**:
- ジェスチャーハンドラーのコールバック内でJS関数を直接呼び出してしまう
- iOSでクラッシュする

**防止策**:
- **ジェスチャーハンドラーには`.runOnJS(true)`を設定**
- JS関数を呼び出す場合は、`runOnJS()`でラップ

**チェックリスト**:
- [ ] ジェスチャーハンドラーに`.runOnJS(true)`を設定しているか？
- [ ] JS関数を`runOnJS()`でラップしているか？

---

## データベースのミス

### 1. 外部キー制約違反

**問題**:
- `challengeId`が存在しないチャレンジを参照してしまう
- データベースエラーが発生

**防止策**:
- **外部キー制約を設定**
- データを挿入する前に、参照先のレコードが存在するか確認

**チェックリスト**:
- [ ] 外部キー制約を設定しているか？
- [ ] 参照先のレコードが存在するか確認しているか？

---

### 2. NULL値の扱い

**問題**:
- `hostProfileImage`が`NULL`の場合、フロントエンドで空文字列（`""`）として扱われる
- 画像の読み込みエラーが発生

**防止策**:
- **データベースで`NULL`を許可する場合、フロントエンドで`null`または`undefined`として扱う**
- 空文字列（`""`）を`NULL`に変換

**チェックリスト**:
- [ ] `NULL`値を正しく扱っているか？
- [ ] 空文字列を`NULL`に変換しているか？

---

## パフォーマンスのミス

### 1. FlatListの代わりにScrollView + .map()を使用

**問題**:
- 大量のアイテムを表示する際、`ScrollView`と`.map()`を使用してしまう
- パフォーマンスが低下し、スクロールが遅くなる

**防止策**:
- **必ず`FlatList`を使用**
- `keyExtractor`を設定
- `getItemLayout`を設定（アイテムの高さが固定の場合）

**チェックリスト**:
- [ ] `FlatList`を使用しているか？
- [ ] `keyExtractor`を設定しているか？
- [ ] `getItemLayout`を設定しているか？（アイテムの高さが固定の場合）

---

### 2. 画像の最適化不足

**問題**:
- 高解像度の画像をそのまま表示してしまう
- 読み込みが遅く、メモリを大量に消費

**防止策**:
- **`expo-image`を使用**
- `contentFit="cover"`を設定
- サムネイル画像を生成（サーバー側）

**チェックリスト**:
- [ ] `expo-image`を使用しているか？
- [ ] `contentFit="cover"`を設定しているか？
- [ ] サムネイル画像を生成しているか？

---

## セキュリティのミス

### 1. XSS（クロスサイトスクリプティング）

**問題**:
- ユーザー入力をそのままHTMLに表示してしまう
- 悪意のあるスクリプトが実行される

**防止策**:
- **React Nativeでは`<Text>`コンポーネントを使用**（自動的にエスケープされる）
- Webでは`dangerouslySetInnerHTML`を使用しない

**チェックリスト**:
- [ ] ユーザー入力を`<Text>`コンポーネントで表示しているか？
- [ ] `dangerouslySetInnerHTML`を使用していないか？

---

### 2. SQL Injection

**問題**:
- ユーザー入力をそのままSQLクエリに埋め込んでしまう
- データベースが改ざんされる

**防止策**:
- **Drizzle ORMを使用**（自動的にエスケープされる）
- 生のSQLクエリを使用しない

**チェックリスト**:
- [ ] Drizzle ORMを使用しているか？
- [ ] 生のSQLクエリを使用していないか？

---

## 実装前のチェックリスト

新しい機能を実装する前に、以下を確認すること:

1. [ ] `DESIGN_PRINCIPLES.md`を読んだか？
2. [ ] `COMPONENT_REGISTRY.md`を確認したか？
3. [ ] `AI_INSTRUCTIONS.md`を読んだか？
4. [ ] 同じ機能が既に実装されていないか？
5. [ ] 既存のコンポーネントを再利用できないか？
6. [ ] TypeScriptエラーを確認したか？
7. [ ] エラーハンドリングを実装したか？
8. [ ] パフォーマンスを考慮したか？
9. [ ] セキュリティを考慮したか？

---

## 実装後のチェックリスト

実装完了後、以下を確認すること:

1. [ ] TypeScriptエラーがないか？
2. [ ] 開発サーバーが正常に起動するか？
3. [ ] 本番環境でテストしたか？
4. [ ] `COMPONENT_REGISTRY.md`を更新したか？（新しいコンポーネントを作成した場合）
5. [ ] `todo.md`を更新したか？
6. [ ] チェックポイントを作成したか？

---

## 参考資料

- [DESIGN_PRINCIPLES.md](../DESIGN_PRINCIPLES.md): 設計原則
- [COMPONENT_REGISTRY.md](./COMPONENT_REGISTRY.md): コンポーネント一覧
- [AI_INSTRUCTIONS.md](./AI_INSTRUCTIONS.md): AI実装ガイドライン

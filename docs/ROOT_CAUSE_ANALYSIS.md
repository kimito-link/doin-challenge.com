# 根本原因分析と解決策

**作成日**: 2026年1月31日

## 問題の整理

### 1. E2Eテストの失敗

**症状**: Gate 2テストが失敗し、詳細ページの検証が通らない

**根本原因**:
- ページの読み込みタイミングとコンテンツレンダリングの非同期性を考慮していない
- 固定の待機時間（`waitForTimeout`）に依存しており、実際のレンダリング完了を待っていない
- 検証ロジックがテキストマッチングのみで、DOM要素の存在確認をしていない

**根本的解決策**:
- Playwrightの `waitForSelector` や `waitForLoadState` を使用して、実際のレンダリング完了を待つ
- 複数の検証方法を組み合わせる（テキスト + DOM要素 + URL）
- リトライロジックを改善し、一時的なネットワーク遅延に対応

---

### 2. プロフィール設定の確定ボタンが反応しない

**症状**: 確定ボタンを押しても遷移しない。エラーが表示されない

**根本原因**:
- **エラーハンドリングが不十分**: `catch` ブロックで `console.error` のみで、ユーザーにフィードバックがない
- **成功時のナビゲーションが確実に実行されていない**: `mutateAsync` の成功後に即座にナビゲーションしているが、状態更新が完了する前に実行される可能性
- **エラー状態の管理がない**: エラーが発生してもUIに反映されない

**根本的解決策**:
- エラー状態を管理し、ユーザーに明確なフィードバックを提供
- `onSuccess` コールバックでナビゲーションを実行し、確実に状態更新後に遷移
- ローディング状態とエラー状態を明確に分離
- トースト通知やアラートでエラーを表示

---

### 3. 統計ダッシュボードが読み込めない

**症状**: 「統計データを読み込めませんでした」と表示される

**根本原因**:
- **エラーハンドリングが不十分**: `isLoading` と `!userStats` のチェックのみで、エラー状態を確認していない
- **エラー原因が分からない**: サーバー側のエラー（認証エラー、DB接続エラーなど）がクライアントに伝わらない
- **リトライ機能がない**: 一時的なネットワークエラーで失敗した場合、再試行できない

**根本的解決策**:
- tRPCの `isError` と `error` をチェックし、エラー状態を適切に処理
- エラーメッセージをユーザーに表示し、原因を明確にする
- リトライ機能を追加（tRPCの `retry` オプション）
- エラーログをSentryに送信して、根本原因を追跡

---

### 4. プロフィール文章のはみ出し

**症状**: チャレンジ作成画面でプロフィールの説明文がはみ出している

**根本原因**:
- **テキストの折り返し設定が不十分**: `numberOfLines` が設定されていない
- **親コンテナの幅制限がない**: `flex: 1` で伸縮するが、最大幅の制限がない
- **長いテキストへの対応がない**: 長い説明文を適切に省略・折り返しする仕組みがない

**根本的解決策**:
- `numberOfLines` を設定して、最大行数を制限
- `ellipsizeMode` を設定して、長いテキストを適切に省略
- 親コンテナに `maxWidth` を設定
- 必要に応じて「もっと見る」機能を追加

---

### 5. E2Eテストの抜け漏れ

**症状**: 主要フローのテストが不足している

**根本原因**:
- **テストカバレッジが不十分**: 主要フロー（ログイン、プロフィール設定、統計ダッシュボード、チャレンジ作成）のテストが不足
- **テストの設計方針が不明確**: 何をテストすべきか、どのレベルでテストすべきかが明確でない
- **テストの保守性が低い**: テストが壊れやすく、UI変更のたびに修正が必要

**根本的解決策**:
- **テスト戦略の明確化**: 
  - Gate 2: 主要フローのE2Eテスト（ユーザージャーニー）
  - 単体テスト: コンポーネントの動作確認
  - 統合テスト: APIとの連携確認
- **テストの拡充**: 
  - ログイン → プロフィール設定 → チャレンジ作成
  - 統計ダッシュボードの読み込み
  - エラーハンドリングのテスト
- **テストの堅牢化**: 
  - セレクターの改善（data-testidの追加）
  - 待機ロジックの改善
  - リトライロジックの追加

---

## 根本的解決策の実装方針

### 1. エラーハンドリングの統一化

**方針**: アプリ全体で一貫したエラーハンドリングを実装

- **エラー表示コンポーネント**: 統一されたエラー表示UI
- **エラーログ**: Sentryへの自動送信
- **ユーザーフィードバック**: トースト通知やアラートで明確なメッセージ

### 2. 非同期処理の堅牢化

**方針**: 非同期処理の完了を確実に待つ

- **状態管理の改善**: React Queryの `onSuccess` / `onError` を適切に使用
- **ナビゲーションのタイミング**: 状態更新完了後にナビゲーション
- **ローディング状態の管理**: 明確なローディング状態の表示

### 3. UIコンポーネントの堅牢性向上

**方針**: 長いテキストやエッジケースに対応

- **テキストの折り返し**: `numberOfLines` と `ellipsizeMode` の適切な設定
- **レスポンシブ対応**: 画面サイズに応じた適切な表示
- **アクセシビリティ**: スクリーンリーダー対応

### 4. E2Eテストの拡充と堅牢化

**方針**: 主要フローを網羅し、堅牢なテストを実装

- **テストカバレッジの拡大**: 主要フローのテスト追加
- **テストの堅牢化**: 適切な待機ロジックとリトライ
- **テストの保守性**: data-testidの追加とセレクターの改善

---

## 実装優先順位

1. **最優先**: エラーハンドリングの統一化（すべての問題の根本原因）
2. **高優先**: プロフィール設定の確定ボタンの修正（ユーザー体験に直結）
3. **高優先**: 統計ダッシュボードのエラーハンドリング改善
4. **中優先**: プロフィール文章のはみ出し修正
5. **中優先**: E2Eテストの拡充と堅牢化

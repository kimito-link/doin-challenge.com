【緊急相談】Phase 2実装後に既存機能が壊れました

## 状況

Phase 2（ログインUX改善）を実装してデプロイしたところ、既存のログイン機能が完全に壊れました。

### デプロイ情報
- バージョン: v6.53
- デプロイ時刻: 3時間前（Today at 2:20 PM）
- コミット: 「不要なPR diff-checkワークフローを削除」「feat(login): improve login flow UX with confirmation modal」
- デプロイ先: https://doin-challenge.com/

---

## 壊れた機能（致命的）

### 1. マイページのTwitterログイン
**症状**: 「Xでログインする」ボタンをタップすると、空白画面（accounts.google.com）で止まる
**期待動作**: ログイン確認モーダルが表示される → Twitter認証画面に遷移

### 2. チャレンジ作成のTwitterログイン
**症状**: 「Twitterでログインして作成」ボタンをタップすると、いきなりTwitter認証画面に飛ぶ
**期待動作**: ログイン確認モーダルが表示される → Twitter認証画面に遷移

### 3. サムネイル表示
**症状**: ホーム画面・チャレンジ詳細画面でサムネイル画像が表示されない
**期待動作**: チャレンジのサムネイル画像が表示される

---

## Phase 2で実装した内容

### 1. 既存コードの修正
- 「認証」→「ログイン」に文言統一（oauth/callback.tsx, oauth/twitter-callback.tsx）
- 絵文字削除
- login()自動実行の確認（問題なし）

### 2. 新規コンポーネント作成
- LinkAuthResult: キャンセル/エラー/成功画面（共通コンポーネント）
- LinkAuthLoading: ローディング画面
- LogoutConfirmModal: Phase 2仕様に修正（既存のmolecules/logout-confirm-modal.tsxを修正）

### 3. 機能実装
- OAuthコールバック処理（app/oauth/callback.tsx）
  - キャンセル/エラー/成功の判定
  - エラー種別判定（network/oauth/other）
  - requestId表示（開発環境のみ）
  - classifyOAuthError関数を追加

### 4. ワークフロー削除
- .github/workflows/pr-diff-check.yml を削除

---

## 問題の原因（推測）

### 1. ログイン確認モーダルが表示されない
- マイページ・チャレンジ作成画面でLoginConfirmModalが正しく統合されていない可能性
- ログインボタンのonPressハンドラーが正しく動作していない

### 2. accounts.google.comにリダイレクトされる
- OAuth認証フローが壊れている
- redirect_uriが正しく設定されていない可能性

### 3. サムネイル表示が壊れている
- Phase 2の実装と無関係のはずだが、何らかの影響を受けている
- 画像URLの生成ロジックが壊れている可能性

---

## 実装前の安全対策（実施済み）

### 1. diff確認ワークフロー
- docs/workflow-diff-check.md にルールを記載
- 「関係ない箇所を変更したら警告を出す」決まり事
- **しかし、.github/workflows/pr-diff-check.yml を削除してしまった**

### 2. チェックポイント保存
- Phase 2実装前のチェックポイント: 32547690（v6.53より前）
- Phase 2実装後のチェックポイント: 3463fac1（現在のバージョン）

---

## 相談内容

### Q1. 即座にロールバックすべきか？
- **A案**: Phase 2実装前のチェックポイント（32547690）にロールバック
  - メリット: 既存機能が正常に動作する
  - デメリット: Phase 2の作業が無駄になる

- **B案**: Phase 2の変更を慎重に修正
  - メリット: Phase 2の成果を活かせる
  - デメリット: 修正に時間がかかる、さらに壊す可能性

### Q2. 壊れた原因の特定方法
- どのファイルを確認すべきか？
- どのような手順で原因を特定すべきか？

### Q3. 再発防止策
- diff確認ワークフローを削除してしまったが、復活させるべきか？
- Phase 2を再実装する際の注意点は？

### Q4. デプロイの問題
- GitHubのコミット履歴は3時間前だが、本番環境に正しくデプロイされているか？
- Vercelのデプロイ時間も3時間前だが、最新のコードが反映されているか？

---

## 添付情報

### スクリーンショット
1. マイページ（未ログイン）: 「Xでログインする」ボタンあり
2. ログインボタンタップ後: 空白画面（accounts.google.com）
3. チャレンジ作成画面: 「Twitterでログインして作成」ボタンあり
4. チャレンジ詳細画面: サムネイル表示なし（黒い丸）
5. Vercelデプロイ情報: 3時間前、READY
6. GitHubコミット履歴: 3時間前、Phase 2関連のコミット

---

## 期待する回答

1. **即座の対応方針**（ロールバック or 修正）
2. **原因特定の手順**（どのファイルを確認すべきか）
3. **再発防止策**（ワークフロー、テスト、実装手順）
4. **Phase 2再実装の注意点**（既存機能を壊さないために）

---

以上です。緊急性が高いため、できるだけ早く回答をお願いします。

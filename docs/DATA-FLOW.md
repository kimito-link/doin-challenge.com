# データフロー設計書

**最終更新**: 2026年1月15日  
**バージョン**: 4.53  
**作成者**: Manus AI

---

## 概要

本ドキュメントは「君斗りんく動員ちゃれんじ」アプリにおけるデータの流れを可視化したものである。各機能でデータがどのように生成・変換・保存されるかを明確にし、システムの理解と改善を容易にする。

---

## 認証フロー

ユーザーがTwitterアカウントでログインする際のデータフローを示す。

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   ユーザー   │     │  クライアント │     │   サーバー   │     │  Twitter API │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                   │
       │ ログインボタン押下  │                   │                   │
       │──────────────────>│                   │                   │
       │                   │                   │                   │
       │                   │ 認証URL要求        │                   │
       │                   │──────────────────>│                   │
       │                   │                   │                   │
       │                   │                   │ code_verifier生成  │
       │                   │                   │ code_challenge生成 │
       │                   │                   │ state生成・保存    │
       │                   │                   │                   │
       │                   │ 認証URL返却        │                   │
       │                   │<──────────────────│                   │
       │                   │                   │                   │
       │ Twitter認証画面へ   │                   │                   │
       │<──────────────────│                   │                   │
       │                   │                   │                   │
       │ 認証許可           │                   │                   │
       │─────────────────────────────────────────────────────────>│
       │                   │                   │                   │
       │ コールバック（code）│                   │                   │
       │<─────────────────────────────────────────────────────────│
       │                   │                   │                   │
       │                   │ code送信           │                   │
       │                   │──────────────────>│                   │
       │                   │                   │                   │
       │                   │                   │ トークン交換       │
       │                   │                   │──────────────────>│
       │                   │                   │                   │
       │                   │                   │ access_token返却   │
       │                   │                   │<──────────────────│
       │                   │                   │                   │
       │                   │                   │ ユーザー情報取得   │
       │                   │                   │──────────────────>│
       │                   │                   │                   │
       │                   │                   │ プロフィール返却   │
       │                   │                   │<──────────────────│
       │                   │                   │                   │
       │                   │                   │ DB保存（users）    │
       │                   │                   │ セッション発行     │
       │                   │                   │                   │
       │                   │ セッションCookie   │                   │
       │                   │<──────────────────│                   │
       │                   │                   │                   │
       │ ログイン完了       │                   │                   │
       │<──────────────────│                   │                   │
       │                   │                   │                   │
```

**データ変換ポイント**:

| ステップ | 入力 | 出力 | 保存先 |
|---------|------|------|--------|
| PKCE生成 | - | code_verifier, code_challenge | メモリ（一時） |
| State生成 | - | state | データベース |
| トークン交換 | code | access_token, refresh_token | データベース |
| ユーザー情報取得 | access_token | twitterId, displayName, profileImageUrl | データベース（users） |
| セッション発行 | userId | sessionCookie | Cookie |

---

## チャレンジ作成フロー

主催者がチャレンジを作成する際のデータフローを示す。

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   主催者    │     │  作成画面    │     │   サーバー   │     │ データベース │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                   │
       │ フォーム入力       │                   │                   │
       │──────────────────>│                   │                   │
       │                   │                   │                   │
       │                   │ バリデーション     │                   │
       │                   │ (Zod)             │                   │
       │                   │                   │                   │
       │                   │ createEvent API   │                   │
       │                   │──────────────────>│                   │
       │                   │                   │                   │
       │                   │                   │ 入力検証           │
       │                   │                   │ (サーバーサイド)   │
       │                   │                   │                   │
       │                   │                   │ INSERT events     │
       │                   │                   │──────────────────>│
       │                   │                   │                   │
       │                   │                   │ event.id返却      │
       │                   │                   │<──────────────────│
       │                   │                   │                   │
       │                   │ 成功レスポンス     │                   │
       │                   │<──────────────────│                   │
       │                   │                   │                   │
       │ 詳細画面へ遷移     │                   │                   │
       │<──────────────────│                   │                   │
       │                   │                   │                   │
```

**入力データ**:

| フィールド | 型 | 必須 | バリデーション |
|-----------|------|------|---------------|
| title | string | ✅ | 1〜100文字 |
| description | string | - | 最大500文字 |
| targetCount | number | ✅ | 1〜10000 |
| eventDate | Date | ✅ | 未来の日付 |
| visibility | enum | ✅ | public/followers/private |

---

## 参加表明フロー

ユーザーがチャレンジに参加する際のデータフローを示す。

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  参加者     │     │  詳細画面    │     │   サーバー   │     │ データベース │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                   │
       │ 参加ボタン押下     │                   │                   │
       │──────────────────>│                   │                   │
       │                   │                   │                   │
       │                   │ 都道府県選択モーダル│                   │
       │                   │                   │                   │
       │ 都道府県選択       │                   │                   │
       │──────────────────>│                   │                   │
       │                   │                   │                   │
       │                   │ participate API   │                   │
       │                   │──────────────────>│                   │
       │                   │                   │                   │
       │                   │                   │ 重複チェック       │
       │                   │                   │──────────────────>│
       │                   │                   │                   │
       │                   │                   │ INSERT participations
       │                   │                   │──────────────────>│
       │                   │                   │                   │
       │                   │                   │ 参加者数更新       │
       │                   │                   │ (events.currentCount)
       │                   │                   │──────────────────>│
       │                   │                   │                   │
       │                   │                   │ マイルストーン判定 │
       │                   │                   │ (25%/50%/75%/100%)│
       │                   │                   │                   │
       │                   │                   │ 通知送信（該当時） │
       │                   │                   │                   │
       │                   │ 成功レスポンス     │                   │
       │                   │<──────────────────│                   │
       │                   │                   │                   │
       │ UI更新（参加済み） │                   │                   │
       │<──────────────────│                   │                   │
       │                   │                   │                   │
```

---

## データ同期フロー

オフライン時のデータ同期フローを示す。

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  ユーザー   │     │ AsyncStorage │     │   サーバー   │     │ データベース │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                   │
       │ オフライン時操作   │                   │                   │
       │──────────────────>│                   │                   │
       │                   │                   │                   │
       │                   │ ローカル保存       │                   │
       │                   │ (pending_actions) │                   │
       │                   │                   │                   │
       │ オンライン復帰     │                   │                   │
       │──────────────────>│                   │                   │
       │                   │                   │                   │
       │                   │ 保留アクション取得 │                   │
       │                   │                   │                   │
       │                   │ 各アクションを実行 │                   │
       │                   │──────────────────>│                   │
       │                   │                   │                   │
       │                   │                   │ DB更新            │
       │                   │                   │──────────────────>│
       │                   │                   │                   │
       │                   │ 成功時：保留削除   │                   │
       │                   │ 失敗時：リトライ   │                   │
       │                   │                   │                   │
       │ 同期完了通知       │                   │                   │
       │<──────────────────│                   │                   │
       │                   │                   │                   │
```

---

## キャッシュ戦略

| データ種別 | キャッシュ先 | 有効期限 | 更新タイミング |
|-----------|------------|---------|---------------|
| ユーザー情報 | AsyncStorage | 24時間 | ログイン時 |
| チャレンジ一覧 | メモリ（React Query） | 5分 | 画面表示時 |
| 参加者リスト | メモリ（React Query） | 1分 | 参加時 |
| 画像 | expo-image（ディスク） | 7日 | 自動 |
| 設定 | AsyncStorage | 永続 | 変更時 |

---

## エラーハンドリングフロー

APIエラー発生時のデータフローを示す。

| エラーコード | 原因 | クライアント側対応 |
|-------------|------|-------------------|
| 401 | 未認証 | ログイン画面へリダイレクト |
| 403 | 権限なし | エラーメッセージ表示 |
| 404 | リソースなし | 「見つかりません」表示 |
| 429 | レート制限 | 指数バックオフでリトライ |
| 500 | サーバーエラー | 「しばらくお待ちください」表示 |

---

## 評価ポイント

データフローを評価する際のチェックポイント：

- [ ] 認証トークンはサーバーサイドのみで保持されているか
- [ ] 入力データは適切にバリデーションされているか
- [ ] オフライン時のデータ整合性は保たれるか
- [ ] キャッシュの有効期限は適切か
- [ ] エラー時のユーザー体験は考慮されているか

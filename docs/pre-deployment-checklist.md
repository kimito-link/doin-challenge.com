# デプロイ前チェックリスト

本番環境へのデプロイ前に、以下の項目を確認してください。

## 1. 環境変数の確認

### 必須環境変数

- [ ] `DATABASE_URL`: PostgreSQL接続文字列が正しく設定されているか
- [ ] `SESSION_SECRET`: 32文字以上のランダムな文字列が設定されているか
- [ ] `TWITTER_CLIENT_ID`: Twitter OAuth Client IDが設定されているか
- [ ] `TWITTER_CLIENT_SECRET`: Twitter OAuth Client Secretが設定されているか
- [ ] `TWITTER_REDIRECT_URI`: Twitter OAuth Redirect URIが本番環境のURLに設定されているか

### オプション環境変数

- [ ] `SENTRY_DSN`: Sentry DSNが設定されているか（エラー監視を有効化する場合）
- [ ] `SENTRY_ENVIRONMENT`: `production`に設定されているか
- [ ] `EXPO_PUBLIC_SENTRY_DSN`: クライアント側のSentry DSNが設定されているか
- [ ] `EXPO_PUBLIC_SENTRY_ENVIRONMENT`: `production`に設定されているか

## 2. セキュリティ設定の確認

### CORS設定

- [ ] `server/_core/index.ts`のCORS設定が本番環境のドメインに制限されているか
- [ ] ワイルドカード（`*`）が使用されていないか

### 認証設定

- [ ] OAuth Redirect URIが本番環境のURLに設定されているか
- [ ] セッションクッキーが`Secure`フラグ付きで設定されているか（HTTPS環境）
- [ ] CSRF対策が有効になっているか

### データベース設定

- [ ] データベース接続がSSL/TLSで暗号化されているか
- [ ] データベースユーザーの権限が最小限に制限されているか

## 3. パフォーマンス最適化の確認

### ビルド設定

- [ ] `pnpm build`が正常に完了するか
- [ ] ビルド成果物のサイズが適切か（`dist/`ディレクトリ）
- [ ] 不要なファイルが含まれていないか

### キャッシュ設定

- [ ] 静的ファイルのキャッシュヘッダーが設定されているか
- [ ] CDNが有効になっているか（画像、CSS、JS）

### データベース最適化

- [ ] インデックスが適切に設定されているか
- [ ] N+1クエリが発生していないか
- [ ] クエリのパフォーマンスが最適化されているか

## 4. 監視・ログ設定の確認

### ヘルスチェック

- [ ] `/api/healthz`が200を返すか
- [ ] `/api/readyz`が200を返すか（DB接続OK時）
- [ ] UptimeRobotで`/api/readyz`の監視が設定されているか

### エラー監視

- [ ] Sentryが正しく初期化されているか
- [ ] テストエラーがSentryに送信されるか
- [ ] エラー通知が適切に設定されているか

### ログ設定

- [ ] ログレベルが適切に設定されているか（`info`または`warn`）
- [ ] 機密情報がログに出力されていないか
- [ ] ログの保存期間が設定されているか

## 5. 機能テストの確認

### 主要フロー

- [ ] ユーザー登録・ログインが正常に動作するか
- [ ] チャレンジ作成が正常に動作するか
- [ ] 参加表明が正常に動作するか
- [ ] 応援メッセージの投稿が正常に動作するか
- [ ] リアルタイム更新が正常に動作するか

### UI/UX

- [ ] レスポンシブデザインが正常に動作するか（モバイル、タブレット、デスクトップ）
- [ ] ダークモードが正常に動作するか
- [ ] アクセシビリティが適切に設定されているか（ARIA属性、キーボードナビゲーション）

### パフォーマンス

- [ ] ページの読み込み時間が3秒以内か
- [ ] 画像が適切に最適化されているか
- [ ] 不要なJavaScriptが削除されているか

## 6. ドキュメントの確認

### README

- [ ] README.mdが最新の情報に更新されているか
- [ ] セットアップ手順が正確か
- [ ] 環境変数の説明が正確か

### API仕様書

- [ ] API仕様書が最新の情報に更新されているか
- [ ] エンドポイントの説明が正確か
- [ ] リクエスト/レスポンス例が正確か

### トラブルシューティング

- [ ] よくある問題と解決方法が記載されているか
- [ ] エラーメッセージの説明が正確か

## 7. バックアップ・ロールバック計画

### バックアップ

- [ ] データベースのバックアップが設定されているか
- [ ] バックアップの復元手順が文書化されているか
- [ ] バックアップの保存期間が設定されているか

### ロールバック

- [ ] ロールバック手順が文書化されているか（docs/rollback-procedure.md）
- [ ] 前回のチェックポイントが保存されているか
- [ ] ロールバックのテストが完了しているか

## 8. 通知設定の確認

### プッシュ通知

- [ ] プッシュ通知が正常に動作するか
- [ ] 通知の内容が適切か
- [ ] 通知の頻度が適切か

### メール通知

- [ ] メール通知が正常に動作するか（UptimeRobot、Sentry）
- [ ] メールアドレスが正しく設定されているか
- [ ] スパムフォルダに入らないか

## 9. 法的・コンプライアンスの確認

### プライバシーポリシー

- [ ] プライバシーポリシーが公開されているか
- [ ] 個人情報の取り扱いが適切に説明されているか

### 利用規約

- [ ] 利用規約が公開されているか
- [ ] 禁止事項が明記されているか

### ライセンス

- [ ] オープンソースライセンスが適切に表示されているか（LICENSE.md）
- [ ] サードパーティライセンスが適切に表示されているか

## 10. 最終確認

- [ ] すべてのチェック項目が完了しているか
- [ ] チームメンバーがデプロイを承認しているか
- [ ] デプロイのタイミングが適切か（ピーク時間を避ける）
- [ ] デプロイ後の監視体制が整っているか

---

## デプロイ後の確認

デプロイ後、以下の項目を確認してください：

1. **ヘルスチェック**: `/api/healthz`と`/api/readyz`が200を返すか
2. **主要フロー**: ユーザー登録・ログイン、チャレンジ作成、参加表明が正常に動作するか
3. **エラー監視**: Sentryでエラーが発生していないか
4. **パフォーマンス**: ページの読み込み時間が適切か
5. **ログ**: エラーログが出力されていないか

問題が発生した場合は、直ちにロールバックを実行してください（docs/rollback-procedure.md参照）。

# Gate 1: main ã« push â†’ ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€æœ¬ç•ªã® commitSha ã‚’ç…§åˆï¼ˆæœ€å°ç‰ˆï¼‰
name: deploy-verify

on:
  push:
    branches: [main]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Wait for deployment
        run: |
          echo "â³ Waiting for Railway deployment to complete..."
          echo "Expected commit: ${{ github.sha }}"
          sleep 420  # 7åˆ†å¾…æ©Ÿï¼ˆRailwayã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯é€šå¸¸3-5åˆ†ã ãŒã€é…å»¶ã‚’è€ƒæ…®ï¼‰

      - name: Verify production health matches this commit
        env:
          PROD_URL: https://doin-challenge.com
          SHA: ${{ github.sha }}
        run: |
          chmod +x scripts/verify-deploy.sh
          echo "ğŸ” Starting verification for commit: $SHA"
          
          # æœ€æ–°ã®mainãƒ–ãƒ©ãƒ³ãƒã®ã‚³ãƒŸãƒƒãƒˆã‚‚è¨±å®¹ã™ã‚‹ï¼ˆRailwayã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå°‘ã—é…ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ï¼‰
          git fetch origin main --depth=1
          LATEST_MAIN=$(git rev-parse origin/main)
          echo "Latest main commit: $LATEST_MAIN"
          
          for i in $(seq 1 30); do
            echo "Verify attempt $i/30..."
            
            # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—
            HEALTH_RESPONSE=$(curl -s "$PROD_URL/api/health" || echo "{}")
            ACTUAL_SHA=$(echo "$HEALTH_RESPONSE" | jq -r '.commitSha // .gitSha // "unknown"')
            OK=$(echo "$HEALTH_RESPONSE" | jq -r '.ok // false')
            
            echo "Health check response: $HEALTH_RESPONSE"
            echo "Actual commitSha: $ACTUAL_SHA"
            echo "Expected commitSha: $SHA (or latest main: $LATEST_MAIN)"
            
            # OKãŒfalseã®å ´åˆã¯ç¶šè¡Œï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ä¸­ã‹ã‚‚ã—ã‚Œãªã„ï¼‰
            if [ "$OK" != "true" ]; then
              echo "âš ï¸ Health check returned ok=false, continuing..."
            elif [ "$ACTUAL_SHA" = "$SHA" ]; then
              echo "âœ… Production matches expected commit $SHA"
              exit 0
            elif [ "$ACTUAL_SHA" = "$LATEST_MAIN" ]; then
              echo "âœ… Production matches latest main commit $LATEST_MAIN"
              exit 0
            elif [ "$ACTUAL_SHA" != "unknown" ]; then
              echo "âš ï¸ Commit mismatch: expected=$SHA or $LATEST_MAIN, actual=$ACTUAL_SHA"
            fi
            
            if [ "$i" -eq 30 ]; then
              echo "âŒ Still mismatch after 30 attempts"
              echo "Expected: $SHA (or $LATEST_MAIN)"
              echo "Actual: $ACTUAL_SHA"
              echo "Last health response: $HEALTH_RESPONSE"
              exit 1
            fi
            
            sleep 20  # 20ç§’é–“éš”ã§ãƒªãƒˆãƒ©ã‚¤ï¼ˆåˆè¨ˆ10åˆ†ï¼‰
          done

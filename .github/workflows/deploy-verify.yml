# ã‚µã‚¤ãƒˆä¸å…·åˆæ¤œçŸ¥: main ã« push å¾Œã€æœ¬ç•ªãŒã€Œã“ã® push ã®ã‚³ãƒŸãƒƒãƒˆã€ã§æ­£å¸¸å¿œç­”ã—ã¦ã„ã‚‹ã“ã¨ã‚’å³å¯†ã«ç…§åˆã™ã‚‹ã€‚
# ç›®çš„: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ãƒ»æœ¬ç•ªãŒå¤ã„/å£Šã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã‚’æ¤œçŸ¥ã™ã‚‹ã€‚
name: deploy-verify

on:
  push:
    branches: [main]

# æ–°ã—ã„ push ãŒæ¥ãŸã‚‰å‰å›ã® verify ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‚æ¤œè¨¼å¯¾è±¡ã¯ã€Œç›´è¿‘ã® push ã®ã‚³ãƒŸãƒƒãƒˆã€ã®ã¿ã¨ã™ã‚‹ã€‚
concurrency:
  group: deploy-verify-main
  cancel-in-progress: true

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Wait for deployment
        run: |
          echo "â³ Waiting for Railway deployment to complete..."
          echo "Expected commit (this push): ${{ github.sha }}"
          sleep 600  # 10åˆ†: Railway ã®ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰ç…§åˆã™ã‚‹

      - name: Verify production health matches this commit
        env:
          PROD_URL: https://doin-challenge.com
          SHA: ${{ github.sha }}
        run: |
          echo "ğŸ” ã‚µã‚¤ãƒˆä¸å…·åˆæ¤œçŸ¥: æœ¬ç•ªã® commitSha ãŒã“ã® push ã®ã‚³ãƒŸãƒƒãƒˆã¨ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™"
          for i in $(seq 1 40); do
            echo "Verify attempt $i/40..."
            HEALTH_RESPONSE=$(curl -s "$PROD_URL/api/health" || echo "{}")
            ACTUAL_SHA=$(echo "$HEALTH_RESPONSE" | jq -r '.commitSha // .gitSha // "unknown"')
            OK=$(echo "$HEALTH_RESPONSE" | jq -r '.ok // false')
            echo "Actual commitSha: $ACTUAL_SHA, ok: $OK (expected commit: $SHA)"
            if [ "$OK" = "true" ] && [ "$ACTUAL_SHA" = "$SHA" ]; then
              echo "âœ… æœ¬ç•ªã¯ã“ã® push ã®ã‚³ãƒŸãƒƒãƒˆã§æ­£å¸¸ã«å¿œç­”ã—ã¦ã„ã¾ã™"
              exit 0
            fi
            if [ "$i" -eq 40 ]; then
              echo "âŒ æœ¬ç•ªãŒã“ã® push ã®ã‚³ãƒŸãƒƒãƒˆã§å¿œç­”ã—ã¾ã›ã‚“ã§ã—ãŸï¼ˆä¸å…·åˆã®å¯èƒ½æ€§ï¼‰"
              echo "Expected: $SHA"
              echo "Actual: $ACTUAL_SHA"
              echo "Last health response: $HEALTH_RESPONSE"
              exit 1
            fi
            sleep 20
          done

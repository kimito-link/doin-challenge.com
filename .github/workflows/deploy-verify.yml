# ã‚µã‚¤ãƒˆä¸å…·åˆæ¤œçŸ¥: main ã« push å¾Œã€æœ¬ç•ªãŒã€Œã“ã® push ã®ã‚³ãƒŸãƒƒãƒˆã€ã§æ­£å¸¸å¿œç­”ã—ã¦ã„ã‚‹ã“ã¨ã‚’å³å¯†ã«ç…§åˆã™ã‚‹ã€‚
# ç›®çš„: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ãƒ»æœ¬ç•ªãŒå¤ã„/å£Šã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã‚’æ¤œçŸ¥ã™ã‚‹ã€‚
name: deploy-verify

on:
  push:
    branches: [main]

# æ–°ã—ã„ push ãŒæ¥ã¦ã‚‚å‰å›ã® verify ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãªã„ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã¨ "The operation was canceled" ã§çµ‚äº†ã—ã¦ã—ã¾ã†ãŸã‚ï¼‰
# ãŸã ã—ã€å¾…æ©Ÿä¸­ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¤‡æ•°ã‚ã‚‹å ´åˆã€GitHub ActionsãŒè‡ªå‹•çš„ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ã“ã¨ãŒã‚ã‚‹
# ãã®å ´åˆã¯ã€æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã«å¯¾ã—ã¦verifyãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚å•é¡Œãªã„
# ã‚³ãƒŸãƒƒãƒˆSHAã‚’å«ã‚ã¦ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹ã“ã¨ã§ã€å„ã‚³ãƒŸãƒƒãƒˆã«å¯¾ã—ã¦ç‹¬ç«‹ã—ã¦verifyã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
concurrency:
  group: deploy-verify-main-${{ github.sha }}
  cancel-in-progress: false

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Wait for deployment
        run: |
          echo "â³ Waiting for Railway deployment to complete..."
          echo "Expected commit (this push): ${{ github.sha }}"
          sleep 600  # 10åˆ†: Railway ã®ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰ç…§åˆã™ã‚‹

      - name: Verify production health matches this commit
        env:
          PROD_URL: https://doin-challenge.com
          SHA: ${{ github.sha }}
        run: |
          echo "ğŸ” ã‚µã‚¤ãƒˆä¸å…·åˆæ¤œçŸ¥: æœ¬ç•ªãŒæ­£å¸¸ã‹ã¤æœŸå¾…ã‚³ãƒŸãƒƒãƒˆã¾ãŸã¯æœ€æ–°mainã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™"
          git fetch origin main --depth=1
          LATEST_MAIN=$(git rev-parse origin/main)
          echo "Expected (this push): $SHA, Latest main: $LATEST_MAIN"
          for i in $(seq 1 40); do
            echo "Verify attempt $i/40..."
            HEALTH_RESPONSE=$(curl -s "$PROD_URL/api/health" || echo "{}")
            ACTUAL_SHA=$(echo "$HEALTH_RESPONSE" | jq -r '.commitSha // .gitSha // "unknown"')
            OK=$(echo "$HEALTH_RESPONSE" | jq -r '.ok // false')
            echo "Actual commitSha: $ACTUAL_SHA, ok: $OK (expected: $SHA or $LATEST_MAIN)"
            if [ "$OK" = "true" ] && ([ "$ACTUAL_SHA" = "$SHA" ] || [ "$ACTUAL_SHA" = "$LATEST_MAIN" ]); then
              echo "âœ… æœ¬ç•ªã¯æ­£å¸¸ã«å¿œç­”ã—ã¦ã„ã¾ã™ (commit: $ACTUAL_SHA)"
              exit 0
            fi
            if [ "$i" -eq 40 ]; then
              echo "âŒ æœ¬ç•ªãŒæœŸå¾…ã‚³ãƒŸãƒƒãƒˆã¾ãŸã¯æœ€æ–°mainã§å¿œç­”ã—ã¾ã›ã‚“ã§ã—ãŸï¼ˆä¸å…·åˆã®å¯èƒ½æ€§ï¼‰"
              echo "Expected: $SHA or $LATEST_MAIN"
              echo "Actual: $ACTUAL_SHA"
              echo "Last health response: $HEALTH_RESPONSE"
              exit 1
            fi
            sleep 20
          done

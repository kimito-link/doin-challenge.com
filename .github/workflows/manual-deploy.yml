name: Manual Deploy (Workflow Dispatch)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      reason:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç†ç”±ï¼ˆä»»æ„ï¼‰'
        required: false
        type: string

jobs:
  deploy:
    name: Manual Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Display deploy info
        run: |
          echo "ðŸš€ Manual deploy triggered"
          echo "Environment: ${{ inputs.environment }}"
          echo "Reason: ${{ inputs.reason || 'No reason provided' }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Branch: ${{ github.ref_name }}"
      
      - name: Run diff-check
        id: diff
        shell: bash
        run: |
          chmod +x scripts/diff-check.sh
          ./scripts/diff-check.sh
      
      - name: Run md-compliance check
        shell: bash
        run: |
          chmod +x scripts/check-md-compliance.sh
          ./scripts/check-md-compliance.sh || echo "âš ï¸ MD compliance check failed, but continuing..."
      
      - name: Trigger main deploy workflow
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-vercel.yml',
              ref: context.ref
            });
            console.log('âœ… Main deploy workflow triggered');
      
      - name: Deployment summary
        run: |
          echo "## ðŸŽ‰ Deployment Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Reason**: ${{ inputs.reason || 'No reason provided' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š [View main deploy workflow](https://github.com/${{ github.repository }}/actions/workflows/deploy-vercel.yml)" >> $GITHUB_STEP_SUMMARY

name: Gate 1

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  diff-check:
    name: Diff Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run diff-check.sh
        id: diff_check
        run: |
          chmod +x scripts/diff-check.sh
          bash scripts/diff-check.sh "${{ github.event.pull_request.base.sha || 'HEAD~1' }}" "${{ github.sha }}"
      
      - name: Comment on PR (if sensitive changes detected)
        if: steps.diff_check.outputs.sensitive == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `
            ## ğŸš¨ Gate 1: å±é™ºãªå¤‰æ›´ãŒæ¤œçŸ¥ã•ã‚Œã¾ã—ãŸ
            
            ä»¥ä¸‹ã®é ˜åŸŸã«å¤‰æ›´ãŒã‚ã‚Šã¾ã™ï¼š
            
            ${ process.env.TOUCH_AUTH === 'true' ? 'âš ï¸ **OAuth / èªè¨¼**\n' : '' }
            ${ process.env.TOUCH_DEPLOY === 'true' ? 'âš ï¸ **Deploy / CI**\n' : '' }
            ${ process.env.TOUCH_ENV === 'true' ? 'âš ï¸ **Env**\n' : '' }
            ${ process.env.TOUCH_DB === 'true' ? 'âš ï¸ **DB**\n' : '' }
            ${ process.env.TOUCH_HEALTH === 'true' ? 'âš ï¸ **Health**\n' : '' }
            ${ process.env.TOUCH_ROUTING === 'true' ? 'âš ï¸ **Routing / Redirect / Proxy**\n' : '' }
            
            ### ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            
            1. PRãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’å…¨ã¦ç¢ºèª
            2. å½±éŸ¿ç¯„å›²ã‚’ç†è§£ã—ã€å¿…é ˆç¢ºèªé …ç›®ã‚’å®Ÿæ–½
            3. Deployå¾Œã€æœ¬ç•ªç’°å¢ƒã§å‹•ä½œç¢ºèª
            
            ğŸ”’ ã“ã®PRã‚’ãƒãƒ¼ã‚¸ã™ã‚‹å‰ã«ã€ä¸Šè¨˜ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
        env:
          TOUCH_AUTH: ${{ steps.diff_check.outputs.touch_auth }}
          TOUCH_DEPLOY: ${{ steps.diff_check.outputs.touch_deploy }}
          TOUCH_ENV: ${{ steps.diff_check.outputs.touch_env }}
          TOUCH_DB: ${{ steps.diff_check.outputs.touch_db }}
          TOUCH_HEALTH: ${{ steps.diff_check.outputs.touch_health }}
          TOUCH_ROUTING: ${{ steps.diff_check.outputs.touch_routing }}

  deploy-health-check:
    name: Deploy Health Check
    runs-on: ubuntu-latest
    needs: [diff-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Wait for Vercel deployment
        run: sleep 60
      
      - name: Check deployment health
        run: |
          HEALTH_URL="https://doin-challenge.com/api/health"
          RESPONSE=$(curl -s "$HEALTH_URL")
          
          echo "Health check response: $RESPONSE"
          
          # commit SHAã‚’ç¢ºèª
          DEPLOYED_SHA=$(echo "$RESPONSE" | jq -r '.commit // empty')
          EXPECTED_SHA="${{ github.sha }}"
          
          if [ -z "$DEPLOYED_SHA" ]; then
            echo "âŒ Health check failed: No commit SHA in response"
            exit 1
          fi
          
          if [ "$DEPLOYED_SHA" != "$EXPECTED_SHA" ]; then
            echo "âŒ Deploy verification failed"
            echo "Expected SHA: $EXPECTED_SHA"
            echo "Deployed SHA: $DEPLOYED_SHA"
            exit 1
          fi
          
          echo "âœ… Deploy verification passed"
          echo "Deployed SHA: $DEPLOYED_SHA"

  oauth-smoke-test:
    name: OAuth Smoke Test
    runs-on: ubuntu-latest
    needs: [deploy-health-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Test OAuth entry point
        run: |
          OAUTH_URL="https://doin-challenge.com/api/auth/twitter"
          RESPONSE_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L "$OAUTH_URL")
          
          echo "OAuth entry point response code: $RESPONSE_CODE"
          
          # 302 (ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ) ã¾ãŸã¯ 200 ã‚’æœŸå¾…
          if [ "$RESPONSE_CODE" != "302" ] && [ "$RESPONSE_CODE" != "200" ]; then
            echo "âŒ OAuth smoke test failed"
            echo "Expected: 302 or 200"
            echo "Got: $RESPONSE_CODE"
            exit 1
          fi
          
          echo "âœ… OAuth smoke test passed"

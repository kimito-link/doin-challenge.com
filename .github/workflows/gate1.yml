name: Gate 1 Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  diff-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # PR „Å´„Ç≥„É°„É≥„Éà„Åô„Çã„Åü„ÇÅ„Å´ÂøÖË¶Å
    outputs:
      touch_api: ${{ steps.diff-check.outputs.touch_api }}
      touch_auth: ${{ steps.diff-check.outputs.touch_auth }}
      touch_db: ${{ steps.diff-check.outputs.touch_db }}
      touch_deploy: ${{ steps.diff-check.outputs.touch_deploy }}
      touch_env: ${{ steps.diff-check.outputs.touch_env }}
      touch_health: ${{ steps.diff-check.outputs.touch_health }}
      sensitive: ${{ steps.diff-check.outputs.sensitive }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ÂâçÂõû„ÅÆ„Ç≥„Éü„ÉÉ„Éà„ÇÇÂèñÂæó
      
      - name: Run diff-check
        id: diff-check
        run: |
          bash scripts/diff-check.sh
        continue-on-error: true
      
      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const sensitive = '${{ steps.diff-check.outputs.sensitive }}';
            const touchAuth = '${{ steps.diff-check.outputs.touch_auth }}';
            const touchDeploy = '${{ steps.diff-check.outputs.touch_deploy }}';
            const touchEnv = '${{ steps.diff-check.outputs.touch_env }}';
            const touchDb = '${{ steps.diff-check.outputs.touch_db }}';
            const touchHealth = '${{ steps.diff-check.outputs.touch_health }}';
            
            let comment = '## üîç Gate 1: diff-checkÁµêÊûú\n\n';
            
            if (sensitive === 'true') {
              comment += '‚ö†Ô∏è **Âç±Èô∫„Å™Â§âÊõ¥„ÅåÊ§úÁü•„Åï„Çå„Åæ„Åó„Åü**\n\n';
              comment += '‰ª•‰∏ã„ÅÆÂøÖÈ†à„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö\n\n';
              
              if (touchAuth === 'true') {
                comment += '- [ ] **Ë™çË®ºÈñ¢ÈÄ£**: „É≠„Ç∞„Ç§„É≥Ê©üËÉΩ„ÅÆ„ÉÜ„Çπ„Éà„ÇíÂÆüÊñΩ\n';
              }
              if (touchDeploy === 'true') {
                comment += '- [ ] **DeployÈñ¢ÈÄ£**: DeployÂæå„Éò„É´„ÇπÁÖßÂêà„ÇíÂÆüÊñΩ\n';
              }
              if (touchEnv === 'true') {
                comment += '- [ ] **Áí∞Â¢ÉÂ§âÊï∞Èñ¢ÈÄ£**: Áí∞Â¢ÉÂ§âÊï∞„ÅÆË®≠ÂÆöÁ¢∫Ë™ç„ÇíÂÆüÊñΩ\n';
              }
              if (touchDb === 'true') {
                comment += '- [ ] **„Éá„Éº„Çø„Éô„Éº„ÇπÈñ¢ÈÄ£**: „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°åÁ¢∫Ë™ç„ÇíÂÆüÊñΩ\n';
              }
              if (touchHealth === 'true') {
                comment += '- [ ] **„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØÈñ¢ÈÄ£**: DeployÂæå„Éò„É´„ÇπÁÖßÂêà„ÇíÂÆüÊñΩ\n';
              }
            } else {
              comment += '‚úÖ **Âç±Èô∫„Å™Â§âÊõ¥„ÅØÊ§úÁü•„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü**\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      # PRÊôÇ„ÅÆ„ÅøÂ§±Êïó„Åï„Åõ„Çã„ÄÇpushÔºàmain„Å∏„ÅÆ„Éû„Éº„Ç∏Âæå„Å™„Å©Ôºâ„Åß„ÅØ„Éá„Éó„É≠„Ç§„Çí„Éñ„É≠„ÉÉ„ÇØ„Åó„Å™„ÅÑ
      - name: Gate 1 enforcement
        if: github.event_name == 'pull_request' && steps.diff-check.outputs.sensitive == 'true'
        run: |
          echo "‚ùå Gate 1: Âç±Èô∫„Å™Â§âÊõ¥„ÅåÊ§úÁü•„Åï„Çå„Åü„Åü„ÇÅÂ§±Êïó„Åï„Åõ„Åæ„Åô"
          exit 1

  health-check:
    runs-on: ubuntu-latest
    needs: [diff-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && (needs.diff-check.outputs.touch_api == 'true' || needs.diff-check.outputs.touch_db == 'true' || needs.diff-check.outputs.touch_deploy == 'true' || needs.diff-check.outputs.touch_env == 'true' || needs.diff-check.outputs.touch_health == 'true')
    steps:
      - uses: actions/checkout@v4
      
      - name: Wait for deployment
        run: sleep 60  # „Éá„Éó„É≠„Ç§„ÅåÂÆå‰∫Ü„Åô„Çã„Åæ„ÅßÂæÖÊ©ü
      
      - name: Check deployed commit SHA
        run: |
          EXPECTED_SHA="${{ github.sha }}"
          ACTUAL_SHA="unknown"
          for i in {1..10}; do
            echo "Health check attempt ${i}..."
            RESPONSE=$(curl -s https://doin-challenge.com/api/health || true)
            if [ -n "${RESPONSE}" ]; then
              ACTUAL_SHA=$(echo "${RESPONSE}" | jq -r .commitSha 2>/dev/null || echo "unknown")
              if [ "${ACTUAL_SHA}" != "unknown" ]; then
                break
              fi
            fi
            sleep 10
          done
          
          if [ "$EXPECTED_SHA" != "$ACTUAL_SHA" ]; then
            echo "‚ùå Deployed commit mismatch"
            echo "Expected: $EXPECTED_SHA"
            echo "Actual: $ACTUAL_SHA"
            exit 1
          fi
          
          echo "‚úÖ Deployed commit matches: $EXPECTED_SHA"

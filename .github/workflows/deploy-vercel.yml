name: Deploy to Vercel

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.0
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Lint (with auto-fix attempt)
        run: |
          # 自動修正可能なエラーを修正
          pnpm lint --fix || true
          # 修正後、エラーのみをチェック（警告は無視）
          pnpm lint --max-warnings 9999 || {
            echo "⚠️ Lint errors detected. Please fix them before deploying."
            exit 1
          }
      
      - name: Type check
        run: pnpm check
      
      - name: Test
        run: pnpm test
      
      - name: Build
        env:
          GITHUB_SHA: ${{ github.sha }}
        run: pnpm build

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

      - name: Post-deploy verify (Gate 1)
        env:
          EXPECTED_SHA: ${{ github.sha }}
        run: |
          set -e
          echo "⏳ Waiting for Railway deployment to sync..."
          echo "Expected commitSha: $EXPECTED_SHA"
          sleep 420  # 7分待機（Railwayのデプロイは通常3-5分だが、遅延を考慮）
          
          git fetch origin main --depth=1
          LATEST_MAIN=$(git rev-parse origin/main)
          echo "Latest main commit: $LATEST_MAIN"
          
          for i in $(seq 1 30); do
            echo "Verify attempt $i/30..."
            HEALTH=$(curl -s https://doin-challenge.com/api/health || echo "{}")
            HEALTH_SHA=$(echo "$HEALTH" | jq -r '.commitSha // .gitSha // "unknown"')
            OK=$(echo "$HEALTH" | jq -r '.ok // false')
            
            echo "Health check response: $HEALTH"
            echo "Actual commitSha: $HEALTH_SHA"
            echo "Expected commitSha: $EXPECTED_SHA (or latest main: $LATEST_MAIN)"
            
            if [[ "$OK" != "true" ]]; then
              echo "⚠️ Health check returned ok=false, continuing..."
            elif [[ "$HEALTH_SHA" == "$EXPECTED_SHA" ]]; then
              echo "✅ /api/health commitSha matches expected"
              break
            elif [[ "$HEALTH_SHA" == "$LATEST_MAIN" ]]; then
              echo "✅ /api/health is on latest main ($LATEST_MAIN)"
              break
            elif [[ "$HEALTH_SHA" != "unknown" ]]; then
              echo "⚠️ Commit mismatch: expected=$EXPECTED_SHA or $LATEST_MAIN, actual=$HEALTH_SHA"
            fi
            
            if [[ $i -eq 30 ]]; then
              echo "❌ /api/health commitSha mismatch after 30 attempts"
              echo "Expected: $EXPECTED_SHA or $LATEST_MAIN"
              echo "Got: $HEALTH_SHA"
              echo "Last health response: $HEALTH"
              exit 1
            fi
            sleep 20  # 20秒間隔でリトライ（合計10分）
          done
          # /version.jsonの検証（Vercelのフロントエンド）
          VERSION_JSON=$(curl -s https://doin-challenge.com/version.json || echo "{}")
          VJ_SHA=$(echo "$VERSION_JSON" | jq -r '.commitSha // .gitSha // "unknown"')
          echo "Version.json response: $VERSION_JSON"
          echo "Version.json commitSha: $VJ_SHA"
          
          if [[ "$VJ_SHA" == "$EXPECTED_SHA" ]]; then
            echo "✅ /version.json commitSha matches expected"
          elif [[ "$VJ_SHA" == "$LATEST_MAIN" ]]; then
            echo "✅ /version.json is on latest main ($LATEST_MAIN)"
          elif [[ "$VJ_SHA" == "unknown" ]]; then
            echo "⚠️ /version.json commitSha is unknown (may not be deployed yet)"
          else
            echo "⚠️ /version.json commitSha mismatch (non-critical for Railway backend)"
            echo "Expected: $EXPECTED_SHA or $LATEST_MAIN"
            echo "Got: $VJ_SHA"
            # VercelのフロントエンドはRailwayのバックエンドより遅れる可能性があるため、警告のみ
          fi

      - name: Gate 2 - API smoke
        env:
          BASE_URL: https://doin-challenge.com
        run: node scripts/gate2-api-smoke.mjs

      - name: Gate 2 - E2E (ホーム→詳細)
        env:
          PLAYWRIGHT_BASE_URL: https://doin-challenge.com
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
        run: |
          npx playwright install --with-deps chromium
          pnpm exec playwright test tests/e2e/gate2-flow.spec.ts --project=chromium

name: Deploy to Vercel

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.0
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Lint (with auto-fix attempt)
        run: |
          set -e
          # è‡ªå‹•ä¿®æ­£å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£
          pnpm lint --fix || true
          # ä¿®æ­£å¾Œã€ã‚¨ãƒ©ãƒ¼ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šã¯ç„¡è¦–ï¼‰
          pnpm lint --max-warnings 9999 || {
            echo "âš ï¸ Lint errors detected. Please fix them before deploying."
            exit 1
          }
      
      - name: Type check
        run: |
          set -e
          echo "ğŸ” Running TypeScript type check..."
          pnpm check || {
            echo "âŒ Type check failed. Please fix type errors before deploying."
            exit 1
          }
          echo "âœ… Type check passed"
      
      - name: Test
        run: |
          set -e
          echo "ğŸ§ª Running tests..."
          pnpm test || {
            echo "âŒ Tests failed. Please fix failing tests before deploying."
            exit 1
          }
          echo "âœ… All tests passed"
      
      - name: Build
        env:
          GITHUB_SHA: ${{ github.sha }}
        run: |
          set -e
          echo "ğŸ”¨ Building application..."
          pnpm build || {
            echo "âŒ Build failed. Please fix build errors before deploying."
            exit 1
          }
          echo "âœ… Build completed"

      - name: Pre-deploy health check
        run: |
          echo "ğŸ¥ Checking production health before deploy..."
          HEALTH=$(curl -s https://doin-challenge.com/api/health || echo "{}" )
          OK=$(echo "$HEALTH" | jq -r '.ok // false')
          if [[ "$OK" == "true" ]]; then
            echo "âœ… Production is healthy before deploy"
          else
            echo "âš ï¸ Production health check failed, but continuing with deploy"
            echo "Health response: $HEALTH"
          fi

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel (with retry)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          set -e
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          echo "ğŸš€ Deploying to Vercel..."
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ“¦ Deployment attempt $((RETRY_COUNT + 1))/$MAX_RETRIES"
            
            if vercel deploy --prod --token=$VERCEL_TOKEN 2>&1 | tee deploy.log; then
              echo "âœ… Deployment successful!"
              VERCEL_URL=$(grep -oP 'https://[^\s]+\.vercel\.app' deploy.log | head -1 || echo "" )
              if [ -n "$VERCEL_URL" ]; then
                echo "ğŸŒ Deployment URL: $VERCEL_URL"
                echo "VERCEL_URL=$VERCEL_URL" >> $GITHUB_ENV
              fi
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸ Deployment failed. Retrying in 30 seconds..."
                sleep 30
              else
                echo "âŒ Deployment failed after $MAX_RETRIES attempts."
                cat deploy.log
                exit 1
              fi
            fi
          done

      # ã‚µã‚¤ãƒˆä¸å…·åˆæ¤œçŸ¥: æœ¬ç•ª /api/health ãŒã“ã® push ã®ã‚³ãƒŸãƒƒãƒˆã§æ­£å¸¸å¿œç­”ã™ã‚‹ã“ã¨ã‚’å³å¯†ã«ç¢ºèªã™ã‚‹ã€‚
      - name: Post-deploy verify (Gate 1)
        env:
          EXPECTED_SHA: ${{ github.sha }}
        run: |
          set -e
          echo "â³ Waiting for deployment to propagate..."
          echo "Expected commitSha (this deploy): $EXPECTED_SHA"
          sleep 180  # 3åˆ†: ãƒ‡ãƒ—ãƒ­ã‚¤ã®ä¼æ’­ã‚’å¾…ã¤ï¼ˆRailwayã¯ä¸¦è¡Œã—ã¦ãƒ“ãƒ«ãƒ‰ä¸­ï¼‰
          git fetch origin main --depth=1
          LATEST_MAIN=$(git rev-parse origin/main)
          echo "Latest main: $LATEST_MAIN"
          for i in $(seq 1 40); do
            echo "Verify attempt $i/40..."
            HEALTH=$(curl -s https://doin-challenge.com/api/health || echo "{}" )
            HEALTH_SHA=$(echo "$HEALTH" | jq -r '.commitSha // .commitsha // .gitSha // "unknown"')
            OK=$(echo "$HEALTH" | jq -r '.ok // false')
            DB_CONNECTED=$(echo "$HEALTH" | jq -r '.db.connected // false')
            DB_ERROR=$(echo "$HEALTH" | jq -r '.db.error // ""')
            echo "Actual commitSha: $HEALTH_SHA, ok: $OK, db.connected: $DB_CONNECTED (expected: $EXPECTED_SHA or $LATEST_MAIN)"
            
            # ã‚³ãƒŸãƒƒãƒˆSHAãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            SHA_MATCH=false
            if [[ "$HEALTH_SHA" == "$EXPECTED_SHA" ]] || [[ "$HEALTH_SHA" == "$LATEST_MAIN" ]]; then
              SHA_MATCH=true
            fi
            
            # ã‚³ãƒŸãƒƒãƒˆSHAãŒä¸€è‡´ã—ã¦ã„ã‚‹å ´åˆã¯æˆåŠŸï¼ˆDBæ¥ç¶šã‚¨ãƒ©ãƒ¼ã¯è­¦å‘Šã®ã¿ï¼‰
            if [[ "$SHA_MATCH" == "true" ]]; then
              if [[ "$OK" == "true" ]]; then
                echo "âœ… æœ¬ç•ªã¯æ­£å¸¸ã«å¿œç­”ã—ã¦ã„ã¾ã™ (commit: $HEALTH_SHA)"
              elif [[ "$DB_CONNECTED" == "false" ]]; then
                echo "âš ï¸ ã‚³ãƒŸãƒƒãƒˆSHAã¯ä¸€è‡´ã—ã¦ã„ã¾ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™"
                echo "âš ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤ã¯æˆåŠŸã—ã¦ã„ã¾ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
                echo "âš ï¸ DB Error: $DB_ERROR"
                echo "Last health response: $HEALTH"
                # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ã¯è­¦å‘Šã¨ã—ã¦æ‰±ã„ã€ãƒ‡ãƒ—ãƒ­ã‚¤è‡ªä½“ã¯æˆåŠŸã¨ã¿ãªã™
              else
                echo "âš ï¸ ã‚³ãƒŸãƒƒãƒˆSHAã¯ä¸€è‡´ã—ã¦ã„ã¾ã™ãŒã€ok=falseã§ã™"
                echo "âš ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤ã¯æˆåŠŸã—ã¦ã„ã¾ã™ãŒã€ä»–ã®å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
                echo "Last health response: $HEALTH"
              fi
              break
            fi
            
            if [[ $i -eq 40 ]]; then
              # ã‚³ãƒŸãƒƒãƒˆSHAãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹å†ãƒã‚§ãƒƒã‚¯
              SHA_MATCH=false
              if [[ "$HEALTH_SHA" == "$EXPECTED_SHA" ]] || [[ "$HEALTH_SHA" == "$LATEST_MAIN" ]]; then
                SHA_MATCH=true
              fi
              
              if [[ "$SHA_MATCH" == "true" ]]; then
                echo "âš ï¸ ã‚³ãƒŸãƒƒãƒˆSHAã¯ä¸€è‡´ã—ã¦ã„ã¾ã™ãŒã€ok=falseã¾ãŸã¯DBæ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™"
                echo "âš ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤ã¯æˆåŠŸã—ã¦ã„ã¾ã™ãŒã€è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„"
                echo "Expected: $EXPECTED_SHA or $LATEST_MAIN"
                echo "Got: $HEALTH_SHA"
                echo "Health ok: $OK"
                echo "DB connected: $DB_CONNECTED"
                if [[ "$DB_CONNECTED" == "false" ]] && [[ -n "$DB_ERROR" ]]; then
                  echo "DB Error: $DB_ERROR"
                fi
                echo "Last health response: $HEALTH"
                exit 0
              fi
              
              echo "âŒ æœ¬ç•ªãŒæœŸå¾…ã‚³ãƒŸãƒƒãƒˆã¾ãŸã¯æœ€æ–°mainã§å¿œç­”ã—ã¾ã›ã‚“ã§ã—ãŸï¼ˆä¸å…·åˆã®å¯èƒ½æ€§ï¼‰"
              echo "Expected: $EXPECTED_SHA or $LATEST_MAIN"
              echo "Got: $HEALTH_SHA"
              echo "Health ok: $OK"
              echo "DB connected: $DB_CONNECTED"
              if [[ "$DB_CONNECTED" == "false" ]] && [[ -n "$DB_ERROR" ]]; then
                echo "DB Error: $DB_ERROR"
              fi
              echo "Last health response: $HEALTH"
              exit 1
            fi
            sleep 20
          done
          VERSION_JSON=$(curl -s https://doin-challenge.com/version.json || echo "{}" )
          VJ_SHA=$(echo "$VERSION_JSON" | jq -r '.commitSha // .gitSha // "unknown"')
          echo "Version.json commitSha: $VJ_SHA (reference)"
          if [[ "$VJ_SHA" != "$EXPECTED_SHA" ]] && [[ "$VJ_SHA" != "unknown" ]]; then
            echo "âš ï¸ /version.json ã¯æœªåŒæœŸã®å¯èƒ½æ€§ï¼ˆVercel å´ã®åæ˜ é…å»¶ï¼‰"
          fi

      - name: Gate 2 - API smoke
        env:
          BASE_URL: https://doin-challenge.com
        run: node scripts/gate2-api-smoke.mjs

      - name: Gate 2 - E2E (ãƒ›ãƒ¼ãƒ â†’è©³ç´° )
        env:
          PLAYWRIGHT_BASE_URL: https://doin-challenge.com
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
        run: |
          npx playwright install --with-deps chromium
          pnpm exec playwright test tests/e2e/gate2-flow.spec.ts --project=chromium

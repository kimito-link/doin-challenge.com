name: Deploy to Vercel

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.0
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Lint (with auto-fix attempt)
        run: |
          set -e
          # è‡ªå‹•ä¿®æ­£å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£
          pnpm lint --fix || true
          # ä¿®æ­£å¾Œã€ã‚¨ãƒ©ãƒ¼ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šã¯ç„¡è¦–ï¼‰
          pnpm lint --max-warnings 9999 || {
            echo "âš ï¸ Lint errors detected. Please fix them before deploying."
            exit 1
          }
      
      - name: Type check
        run: |
          set -e
          echo "ğŸ” Running TypeScript type check..."
          pnpm check || {
            echo "âŒ Type check failed. Please fix type errors before deploying."
            exit 1
          }
          echo "âœ… Type check passed"
      
      - name: Test
        run: |
          set -e
          echo "ğŸ§ª Running tests..."
          pnpm test || {
            echo "âŒ Tests failed. Please fix failing tests before deploying."
            exit 1
          }
          echo "âœ… All tests passed"
      
      - name: Build
        env:
          GITHUB_SHA: ${{ github.sha }}
        run: |
          set -e
          echo "ğŸ”¨ Building application..."
          pnpm build || {
            echo "âŒ Build failed. Please fix build errors before deploying."
            exit 1
          }
          echo "âœ… Build completed"

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

      # ã‚µã‚¤ãƒˆä¸å…·åˆæ¤œçŸ¥: æœ¬ç•ª /api/health ãŒã“ã® push ã®ã‚³ãƒŸãƒƒãƒˆã§æ­£å¸¸å¿œç­”ã™ã‚‹ã“ã¨ã‚’å³å¯†ã«ç¢ºèªã™ã‚‹ã€‚
      - name: Post-deploy verify (Gate 1)
        env:
          EXPECTED_SHA: ${{ github.sha }}
        run: |
          set -e
          echo "â³ Waiting for Railway deployment to sync..."
          echo "Expected commitSha (this deploy): $EXPECTED_SHA"
          sleep 600  # 10åˆ†: Railway ã®ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ã‚’å¾…ã¤
          git fetch origin main --depth=1
          LATEST_MAIN=$(git rev-parse origin/main)
          echo "Latest main: $LATEST_MAIN"
          for i in $(seq 1 40); do
            echo "Verify attempt $i/40..."
            HEALTH=$(curl -s https://doin-challenge.com/api/health || echo "{}")
            HEALTH_SHA=$(echo "$HEALTH" | jq -r '.commitSha // .gitSha // "unknown"')
            OK=$(echo "$HEALTH" | jq -r '.ok // false')
            echo "Actual commitSha: $HEALTH_SHA, ok: $OK (expected: $EXPECTED_SHA or $LATEST_MAIN)"
            if [[ "$OK" == "true" ]] && ([[ "$HEALTH_SHA" == "$EXPECTED_SHA" ]] || [[ "$HEALTH_SHA" == "$LATEST_MAIN" ]]); then
              echo "âœ… æœ¬ç•ªã¯æ­£å¸¸ã«å¿œç­”ã—ã¦ã„ã¾ã™ (commit: $HEALTH_SHA)"
              break
            fi
            if [[ $i -eq 40 ]]; then
              echo "âŒ æœ¬ç•ªãŒæœŸå¾…ã‚³ãƒŸãƒƒãƒˆã¾ãŸã¯æœ€æ–°mainã§å¿œç­”ã—ã¾ã›ã‚“ã§ã—ãŸï¼ˆä¸å…·åˆã®å¯èƒ½æ€§ï¼‰"
              echo "Expected: $EXPECTED_SHA or $LATEST_MAIN"
              echo "Got: $HEALTH_SHA"
              echo "Last health response: $HEALTH"
              exit 1
            fi
            sleep 20
          done
          VERSION_JSON=$(curl -s https://doin-challenge.com/version.json || echo "{}")
          VJ_SHA=$(echo "$VERSION_JSON" | jq -r '.commitSha // .gitSha // "unknown"')
          echo "Version.json commitSha: $VJ_SHA (reference)"
          if [[ "$VJ_SHA" != "$EXPECTED_SHA" ]] && [[ "$VJ_SHA" != "unknown" ]]; then
            echo "âš ï¸ /version.json ã¯æœªåŒæœŸã®å¯èƒ½æ€§ï¼ˆVercel å´ã®åæ˜ é…å»¶ï¼‰"
          fi

      - name: Gate 2 - API smoke
        env:
          BASE_URL: https://doin-challenge.com
        run: node scripts/gate2-api-smoke.mjs

      - name: Gate 2 - E2E (ãƒ›ãƒ¼ãƒ â†’è©³ç´°)
        env:
          PLAYWRIGHT_BASE_URL: https://doin-challenge.com
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
        run: |
          npx playwright install --with-deps chromium
          pnpm exec playwright test tests/e2e/gate2-flow.spec.ts --project=chromium

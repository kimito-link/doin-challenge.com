name: Deploy to Vercel

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.0
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Lint (with auto-fix attempt)
        run: |
          # 自動修正可能なエラーを修正
          pnpm lint --fix || true
          # 修正後、エラーのみをチェック（警告は無視）
          pnpm lint --max-warnings 9999 || {
            echo "⚠️ Lint errors detected. Please fix them before deploying."
            exit 1
          }
      
      - name: Type check
        run: pnpm check
      
      - name: Test
        run: pnpm test
      
      - name: Build
        env:
          GITHUB_SHA: ${{ github.sha }}
        run: pnpm build

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

      # サイト不具合検知: 本番 /api/health がこの push のコミットで正常応答することを厳密に確認する。
      - name: Post-deploy verify (Gate 1)
        env:
          EXPECTED_SHA: ${{ github.sha }}
        run: |
          set -e
          echo "⏳ Waiting for Railway deployment to sync..."
          echo "Expected commitSha (this deploy): $EXPECTED_SHA"
          sleep 600  # 10分: Railway のビルド・デプロイ完了を待つ
          git fetch origin main --depth=1
          LATEST_MAIN=$(git rev-parse origin/main)
          echo "Latest main: $LATEST_MAIN"
          for i in $(seq 1 40); do
            echo "Verify attempt $i/40..."
            HEALTH=$(curl -s https://doin-challenge.com/api/health || echo "{}")
            HEALTH_SHA=$(echo "$HEALTH" | jq -r '.commitSha // .gitSha // "unknown"')
            OK=$(echo "$HEALTH" | jq -r '.ok // false')
            echo "Actual commitSha: $HEALTH_SHA, ok: $OK (expected: $EXPECTED_SHA or $LATEST_MAIN)"
            if [[ "$OK" == "true" ]] && ([[ "$HEALTH_SHA" == "$EXPECTED_SHA" ]] || [[ "$HEALTH_SHA" == "$LATEST_MAIN" ]]); then
              echo "✅ 本番は正常に応答しています (commit: $HEALTH_SHA)"
              break
            fi
            if [[ $i -eq 40 ]]; then
              echo "❌ 本番が期待コミットまたは最新mainで応答しませんでした（不具合の可能性）"
              echo "Expected: $EXPECTED_SHA or $LATEST_MAIN"
              echo "Got: $HEALTH_SHA"
              echo "Last health response: $HEALTH"
              exit 1
            fi
            sleep 20
          done
          VERSION_JSON=$(curl -s https://doin-challenge.com/version.json || echo "{}")
          VJ_SHA=$(echo "$VERSION_JSON" | jq -r '.commitSha // .gitSha // "unknown"')
          echo "Version.json commitSha: $VJ_SHA (reference)"
          if [[ "$VJ_SHA" != "$EXPECTED_SHA" ]] && [[ "$VJ_SHA" != "unknown" ]]; then
            echo "⚠️ /version.json は未同期の可能性（Vercel 側の反映遅延）"
          fi

      - name: Gate 2 - API smoke
        env:
          BASE_URL: https://doin-challenge.com
        run: node scripts/gate2-api-smoke.mjs

      - name: Gate 2 - E2E (ホーム→詳細)
        env:
          PLAYWRIGHT_BASE_URL: https://doin-challenge.com
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
        run: |
          npx playwright install --with-deps chromium
          pnpm exec playwright test tests/e2e/gate2-flow.spec.ts --project=chromium

name: Safe Production Deploy

on:
  push:
    branches: [ main ]

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  # Êú¨Áï™URLÔºàE2E„ÉÜ„Çπ„ÉàÁî®Ôºâ
  PROD_URL: https://doin-challenge.com

jobs:
  # ========================================
  # Preflight: SecretsÂ≠òÂú®„ÉÅ„Çß„ÉÉ„ÇØ
  # ========================================
  preflight:
    name: Preflight (Secrets Check)
    runs-on: ubuntu-latest
    steps:
      - name: Check Required Secrets
        run: |
          echo "Checking required secrets..."
          missing=""
          
          if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
            missing="$missing RAILWAY_TOKEN"
          fi
          if [ -z "${{ secrets.DATABASE_URL }}" ]; then
            missing="$missing DATABASE_URL"
          fi
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            missing="$missing VERCEL_TOKEN"
          fi
          if [ -z "${{ secrets.VERCEL_ORG_ID }}" ]; then
            missing="$missing VERCEL_ORG_ID"
          fi
          if [ -z "${{ secrets.VERCEL_PROJECT_ID }}" ]; then
            missing="$missing VERCEL_PROJECT_ID"
          fi
          
          if [ -n "$missing" ]; then
            echo "::error::Missing required secrets:$missing"
            exit 1
          fi
          
          echo "‚úÖ All required secrets are set"

  # ========================================
  # CI: lint / typecheck / test
  # ========================================
  ci:
    name: CI (lint / typecheck / test)
    runs-on: ubuntu-latest
    needs: preflight
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - run: pnpm install
      - run: pnpm lint
      - run: pnpm check
      - run: pnpm test

  # ========================================
  # Backend: Railway Deploy + Migrate
  # ========================================
  backend:
    name: Backend Deploy (Railway) + Migrate
    runs-on: ubuntu-latest
    needs: ci
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - run: pnpm install
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      - name: Deploy Backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: railway up --service doin-challenge.com --detach
      - name: Run DB Migration
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: pnpm db:migrate
      - name: Health Check (schema)
        run: |
          sleep 30
          response=$(curl -sf ${{ env.PROD_URL }}/api/health?schema=true)
          echo "$response"
          echo "$response" | jq -e '.schema.status == "ok"' || exit 1

  # ========================================
  # Frontend: Vercel Deploy (with URL output)
  # ========================================
  frontend:
    name: Frontend Deploy (Vercel)
    runs-on: ubuntu-latest
    needs: backend
    outputs:
      deployment_url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - run: pnpm install
      - name: Deploy Frontend
        id: deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          # „Éá„Éó„É≠„Ç§„Åó„Å¶URL„ÇíÂèñÂæó
          url=$(npx vercel deploy --prod --token=$VERCEL_TOKEN --yes 2>&1 | grep -oP 'https://[^\s]+\.vercel\.app' | head -1)
          if [ -z "$url" ]; then
            url="${{ env.PROD_URL }}"
          fi
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "Deployed to: $url"

  # ========================================
  # E2E: Playwright Smoke Test
  # ========================================
  e2e:
    name: E2E Smoke Test (Playwright)
    runs-on: ubuntu-latest
    needs: frontend
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
      - run: pnpm install
      - run: npx playwright install --with-deps
      - name: Run E2E Smoke Tests
        env:
          # „Éá„Éó„É≠„Ç§„Åï„Çå„ÅüURL„Çí‰ΩøÁî®Ôºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÅØÊú¨Áï™URLÔºâ
          BASE_URL: ${{ needs.frontend.outputs.deployment_url || env.PROD_URL }}
        run: |
          echo "Testing against: $BASE_URL"
          pnpm e2e
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # ========================================
  # Notify: Â§±ÊïóÊôÇ„ÅÆÈÄöÁü•
  # ========================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [preflight, ci, backend, frontend, e2e]
    if: failure()
    steps:
      - name: Determine Failed Job
        id: failed
        run: |
          failed_jobs=""
          if [ "${{ needs.preflight.result }}" == "failure" ]; then

            failed_jobs="$failed_jobs Preflight"
          fi
          if [ "${{ needs.ci.result }}" == "failure" ]; then
            failed_jobs="$failed_jobs CI"
          fi
          if [ "${{ needs.backend.result }}" == "failure" ]; then
            failed_jobs="$failed_jobs Backend"
          fi
          if [ "${{ needs.frontend.result }}" == "failure" ]; then
            failed_jobs="$failed_jobs Frontend"
          fi
          if [ "${{ needs.e2e.result }}" == "failure" ]; then
            failed_jobs="$failed_jobs E2E"
          fi
          echo "jobs=$failed_jobs" >> $GITHUB_OUTPUT
      
      - name: Send Discord Notification
        if: ${{ secrets.DISCORD_WEBHOOK_URL != '' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üö® CI/CD Pipeline Failed",
                "description": "Production deploy failed for **doin-challenge.com**",
                "color": 15158332,
                "fields": [
                  {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                  {"name": "Commit", "value": "`${{ github.sha }}`", "inline": true},
                  {"name": "Failed Jobs", "value": "${{ steps.failed.outputs.jobs }}", "inline": false},
                  {"name": "Workflow", "value": "[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
              }]
            }'
      
      - name: Send Slack Notification
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "blocks": [
                {
                  "type": "header",
                  "text": {"type": "plain_text", "text": "üö® CI/CD Pipeline Failed", "emoji": true}
                },
                {
                  "type": "section",
                  "fields": [
                    {"type": "mrkdwn", "text": "*Repository:*\ndoin-challenge.com"},
                    {"type": "mrkdwn", "text": "*Branch:*\n${{ github.ref_name }}"},
                    {"type": "mrkdwn", "text": "*Commit:*\n`${{ github.sha }}`"},
                    {"type": "mrkdwn", "text": "*Failed Jobs:*\n${{ steps.failed.outputs.jobs }}"}
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {"type": "plain_text", "text": "View Workflow Run"},
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }'
      
      - name: Log Failure (fallback)
        if: ${{ secrets.DISCORD_WEBHOOK_URL == '' && secrets.SLACK_WEBHOOK_URL == '' }}
        run: |
          echo "::error::CI/CD Pipeline Failed!"
          echo "Failed jobs: ${{ steps.failed.outputs.jobs }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "‚ö†Ô∏è No notification webhook configured."
          echo "Set DISCORD_WEBHOOK_URL or SLACK_WEBHOOK_URL in GitHub Secrets to receive notifications."

name: Smoke Check

on:
  # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«æ‰‹å‹•ã§å®Ÿè¡Œ
  workflow_dispatch:
  # ã¾ãŸã¯ã€mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥å¾Œã«å®Ÿè¡Œ
  # push:
  #   branches: [main]

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Wait for deployment
        run: sleep 30
        
      - name: Check /api/health (basic)
        run: |
          response=$(curl -s -w "\n%{http_code}" https://doin-challenge.com/api/health)
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" != "200" ]; then
            echo "âŒ Health check failed with status $http_code"
            exit 1
          fi
          
          ok=$(echo "$body" | jq -r '.ok')
          if [ "$ok" != "true" ]; then
            echo "âŒ Health check returned ok=false"
            echo "$body" | jq '.'
            exit 1
          fi
          
          echo "âœ… Basic health check passed"
      
      - name: Check /api/health (with DB)
        run: |
          response=$(curl -s https://doin-challenge.com/api/health)
          
          db_connected=$(echo "$response" | jq -r '.db.connected')
          if [ "$db_connected" != "true" ]; then
            echo "âŒ Database connection failed"
            echo "$response" | jq '.db'
            exit 1
          fi
          
          db_latency=$(echo "$response" | jq -r '.db.latency')
          echo "DB Latency: ${db_latency}ms"
          
          if [ "$db_latency" -gt 1000 ]; then
            echo "âš ï¸  Warning: DB latency is high (${db_latency}ms)"
          fi
          
          echo "âœ… Database connection check passed"
      
      - name: Check /api/health (critical APIs)
        run: |
          response=$(curl -s "https://doin-challenge.com/api/health?critical=true")
          
          home_events_ok=$(echo "$response" | jq -r '.critical.homeEvents.ok')
          rankings_ok=$(echo "$response" | jq -r '.critical.rankings.ok')
          
          if [ "$home_events_ok" != "true" ]; then
            echo "âŒ homeEvents API check failed"
            echo "$response" | jq '.critical.homeEvents'
            exit 1
          fi
          
          if [ "$rankings_ok" != "true" ]; then
            echo "âŒ rankings API check failed"
            echo "$response" | jq '.critical.rankings'
            exit 1
          fi
          
          echo "âœ… Critical APIs check passed"
      
      - name: Check tRPC endpoint
        run: |
          response=$(curl -s -w "\n%{http_code}" https://doin-challenge.com/api/trpc/events.list)
          http_code=$(echo "$response" | tail -n1)
          
          if [ "$http_code" != "200" ]; then
            echo "âŒ tRPC endpoint check failed with status $http_code"
            exit 1
          fi
          
          echo "âœ… tRPC endpoint check passed"
      
      - name: Summary
        if: success()
        run: |
          echo "ğŸ‰ All smoke checks passed!"
          echo "âœ… Health endpoint"
          echo "âœ… Database connection"
          echo "âœ… Critical APIs (homeEvents, rankings)"
          echo "âœ… tRPC endpoint"

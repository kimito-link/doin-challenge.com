name: Security Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check for sensitive data
        run: |
          echo "ğŸ”’ æ©Ÿå¯†æƒ…å ±ã®ãƒã‚§ãƒƒã‚¯..."
          
          # .envãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
          if git ls-files | grep -q "\.env$"; then
            echo "âŒ .envãƒ•ã‚¡ã‚¤ãƒ«ãŒGitã«å«ã¾ã‚Œã¦ã„ã¾ã™ï¼"
            echo "âš ï¸ .envãƒ•ã‚¡ã‚¤ãƒ«ã¯.gitignoreã«è¿½åŠ ã—ã¦ãã ã•ã„"
            exit 1
          fi
          
          # ç§˜å¯†éµãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
          if git ls-files | grep -E "\.(key|pem|p12)$"; then
            echo "âŒ ç§˜å¯†éµãƒ•ã‚¡ã‚¤ãƒ«ãŒGitã«å«ã¾ã‚Œã¦ã„ã¾ã™ï¼"
            echo "âš ï¸ ç§˜å¯†éµãƒ•ã‚¡ã‚¤ãƒ«ã¯.gitignoreã«è¿½åŠ ã—ã¦ãã ã•ã„"
            exit 1
          fi
          
          # Personal Access TokenãŒã‚³ãƒ¼ãƒ‰ã«å«ã¾ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
          if git diff --cached | grep -iE "ghp_[a-zA-Z0-9]{36}|gho_[a-zA-Z0-9]{36}|ghu_[a-zA-Z0-9]{36}"; then
            echo "âŒ Personal Access TokenãŒã‚³ãƒ¼ãƒ‰ã«å«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼"
            echo "âš ï¸ PATã¯ã‚³ãƒ¼ãƒ‰ã«å«ã‚ãšã€ç’°å¢ƒå¤‰æ•°ã‚„GitHub Secretsã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"
            exit 1
          fi
          
          echo "âœ… æ©Ÿå¯†æƒ…å ±ã®ãƒã‚§ãƒƒã‚¯å®Œäº†"
      
      - name: Check .gitignore
        run: |
          echo "ğŸ“‹ .gitignoreã®ç¢ºèª..."
          if [ -f ".gitignore" ]; then
            if grep -q "\.env" .gitignore; then
              echo "âœ… .envãŒ.gitignoreã«å«ã¾ã‚Œã¦ã„ã¾ã™"
            else
              echo "âš ï¸ .envãŒ.gitignoreã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“"
            fi
            
            if grep -q "\.key\|traffic\.key" .gitignore; then
              echo "âœ… ç§˜å¯†éµãƒ•ã‚¡ã‚¤ãƒ«ãŒ.gitignoreã«å«ã¾ã‚Œã¦ã„ã¾ã™"
            else
              echo "âš ï¸ ç§˜å¯†éµãƒ•ã‚¡ã‚¤ãƒ«ãŒ.gitignoreã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“"
            fi
          else
            echo "âš ï¸ .gitignoreãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
      
      - name: Summary
        run: |
          echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†"
